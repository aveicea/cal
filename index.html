<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>멀티 캘린더 뷰어</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
  margin: 0;
  padding: 0;
  background: #ffffff;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.header {
  padding: 10px 20px;
  background: #fff;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
  flex-shrink: 0;
}

.view-selector {
  display: flex;
  gap: 8px;
  align-items: center;
  flex: 1;
  justify-content: center;
}

.view-btn {
  padding: 6px 12px;
  border: 1px solid #ddd;
  background: white;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
  color: #666;
}

.view-btn.active {
  background: var(--accent-color, #4285f4);
  color: white;
  border-color: var(--accent-color, #4285f4);
}

.nav-controls {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-right: 20px;
}

.nav-btn {
  width: 32px;
  height: 32px;
  border: 1px solid #ddd;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.nav-btn:hover {
  background: #f8f9fa;
}

.current-date {
  padding: 6px 12px;
  background: #f8f9fa;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  color: #333;
  min-width: 120px;
  text-align: center;
}

.settings-btn {
  width: 32px;
  height: 32px;
  border: none;
  background: #f8f9fa;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #666;
  transition: all 0.2s ease;
}

.settings-btn:hover {
  background: #e8eaed;
  color: #333;
}

.settings-panel {
  position: absolute;
  top: 45px;
  right: 20px;
  background: white;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  width: 450px;
  z-index: 1000;
  display: none;
  max-height: 70vh;
  overflow-y: auto;
}

.settings-title {
  font-size: 16px;
  font-weight: 500;
  margin-bottom: 15px;
  color: #333;
}

.color-picker-group {
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 1px solid #e0e0e0;
}

.color-picker-title {
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 10px;
  color: #333;
}

.color-input-row {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 10px;
}

.color-picker-input {
  width: 40px;
  height: 30px;
  border: 1px solid #ddd;
  border-radius: 4px;
  cursor: pointer;
  padding: 0;
}

.color-text-input {
  flex: 1;
  padding: 6px 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 12px;
  font-family: monospace;
}

.preset-colors {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 4px;
}

.preset-color {
  width: 24px;
  height: 24px;
  border-radius: 4px;
  border: 2px solid transparent;
  cursor: pointer;
  transition: all 0.2s ease;
}

.preset-color:hover {
  transform: scale(1.1);
  border-color: #333;
}

.calendar-list-section {
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 1px solid #e0e0e0;
}

.calendar-item {
  display: flex;
  align-items: center;
  padding: 8px;
  border: 1px solid #e0e0e0;
  border-radius: 6px;
  margin-bottom: 8px;
  background: #f8f9fa;
}

.calendar-item.active {
  border-color: var(--accent-color, #4285f4);
  background: #e3f2fd;
}

.calendar-color-picker {
  width: 24px;
  height: 24px;
  border: none;
  border-radius: 50%;
  margin-right: 8px;
  cursor: pointer;
  padding: 0;
  background: none;
  box-shadow: 0 0 0 2px white, 0 0 0 3px #ddd;
}

.calendar-color-picker:hover {
  transform: scale(1.1);
  transition: transform 0.2s ease;
}

.calendar-info {
  flex: 1;
}

.calendar-name {
  font-size: 13px;
  font-weight: 500;
  color: #333;
  background: none;
  border: none;
  padding: 0;
  margin: 0;
  width: 100%;
}

.calendar-name:focus {
  outline: 1px solid var(--accent-color, #4285f4);
  outline-offset: 1px;
  border-radius: 2px;
}

.calendar-url {
  font-size: 11px;
  color: #666;
  word-break: break-all;
  margin-top: 2px;
}

.calendar-status {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px;
  margin-top: 2px;
  display: inline-block;
}

.calendar-status.success {
  background: #e8f5e8;
  color: #2e7d32;
}

.calendar-status.error {
  background: #ffebee;
  color: #c62828;
}

.calendar-status.loading {
  background: #e3f2fd;
  color: #1976d2;
}

.calendar-actions {
  display: flex;
  gap: 4px;
}

.toggle-btn {
  width: 20px;
  height: 20px;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  transition: all 0.2s ease;
}

.toggle-btn.visible {
  background: var(--accent-color, #4285f4);
  color: white;
}

.toggle-btn.hidden {
  background: #ccc;
  color: white;
}

.remove-btn {
  background: #f44336;
  color: white;
}

.reload-btn {
  background: #ff9800;
  color: white;
  font-size: 10px;
}

.add-calendar-section {
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 1px solid #e0e0e0;
}

.input-group {
  margin-bottom: 10px;
}

.input-group label {
  display: block;
  font-size: 12px;
  color: #666;
  margin-bottom: 4px;
}

.input-group input, .input-group textarea, .input-group select {
  width: 100%;
  padding: 6px 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 12px;
  box-sizing: border-box;
  resize: vertical;
}

.help-text {
  font-size: 11px;
  color: #888;
  margin-top: 4px;
  line-height: 1.4;
}

.btn {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-right: 8px;
  margin-bottom: 8px;
}

.btn-primary {
  background: var(--accent-color, #4285f4);
  color: white;
}

.btn-primary:hover {
  background: var(--accent-hover-color, #3367d6);
}

.btn-secondary {
  background: #f8f9fa;
  color: #666;
  border: 1px solid #ddd;
}

.calendar-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.calendar-content {
  flex: 1;
  overflow: auto;
  background: #f8f9fa;
}

/* 월간 뷰 */
.calendar-grid.month-view {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  grid-template-rows: auto repeat(6, 1fr);
  gap: 1px;
  background: #e0e0e0;
  border: 1px solid #e0e0e0;
  height: 100%;
  min-height: 500px;
}

.calendar-day {
  background: white;
  min-height: 80px;
  padding: 6px;
  position: relative;
  font-size: 12px;
  border: none;
}

.calendar-day.other-month {
  background: #f8f9fa;
  color: #999;
}

.calendar-day.today {
  background: #e3f2fd;
}

.day-number {
  font-weight: 500;
  margin-bottom: 3px;
}

.event {
  padding: 1px 3px;
  border-radius: 2px;
  font-size: 10px;
  margin-bottom: 1px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: white;
  cursor: pointer;
}

/* 시간 기반 뷰 개선 */
.time-based-view {
  display: grid;
  background: white;
  height: 100%;
  overflow: hidden;
}

.week-view {
  grid-template-columns: 70px repeat(7, 1fr);
  grid-template-rows: 50px repeat(18, 50px); /* 6시~23시 = 18시간 */
}

.day-view {
  grid-template-columns: 70px 1fr;
  grid-template-rows: 50px repeat(18, 50px); /* 6시~23시 = 18시간 */
}

.time-slot {
  background: #f8f9fa;
  padding: 4px;
  font-size: 11px;
  color: #666;
  border-right: 1px solid #e0e0e0;
  border-bottom: 1px solid #f0f0f0;
  text-align: center;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
}

.day-column {
  background: white;
  position: relative;
  border-right: 1px solid #f0f0f0;
  border-bottom: 1px solid #f0f0f0;
  overflow: hidden;
}

.day-column:last-child {
  border-right: none;
}

.week-header {
  background: #f8f9fa;
  padding: 8px;
  font-weight: 500;
  text-align: center;
  font-size: 13px;
  border-bottom: 1px solid #e0e0e0;
  border-right: 1px solid #f0f0f0;
  color: #333;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
}

.week-header:last-child {
  border-right: none;
}

.week-header.today {
  background: #e3f2fd;
  color: var(--accent-color, #4285f4);
  font-weight: 600;
}

.week-header small {
  font-size: 11px;
  font-weight: normal;
  margin-top: 2px;
}

/* 이벤트 스타일링 개선 */
.time-event {
  position: absolute;
  left: 4px;
  right: 4px;
  border-radius: 4px;
  padding: 2px 6px;
  color: white;
  font-weight: 500;
  font-size: 10px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  cursor: pointer;
  z-index: 1;
}

.time-event:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  z-index: 2;
}

.all-day-event {
  position: absolute;
  top: 2px;
  left: 4px;
  right: 4px;
  height: 20px;
  line-height: 18px;
  border-radius: 3px;
  padding: 0 6px;
  color: white;
  font-weight: 500;
  font-size: 10px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  cursor: pointer;
  z-index: 1;
}

.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: #666;
}

.error-message {
  background: #ffebee;
  border: 1px solid #ffcdd2;
  border-radius: 8px;
  padding: 16px;
  margin: 20px;
  color: #c62828;
  font-size: 12px;
}

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.1);
  z-index: 999;
  display: none;
}

.debug-section {
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 1px solid #e0e0e0;
}

.debug-log {
  background: #f8f9fa;
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  padding: 10px;
  font-family: monospace;
  font-size: 11px;
  max-height: 200px;
  overflow-y: auto;
  margin-top: 10px;
}

.calendar-inputs {
  display: none;
}

.calendar-inputs.active {
  display: block;
}

@media (max-width: 768px) {
  .settings-panel {
    right: 10px;
    left: 10px;
    width: auto;
  }
  .nav-controls {
    margin-right: 10px;
  }
  .time-slot {
    font-size: 9px;
    padding: 2px;
  }
  .week-header {
    font-size: 11px;
    padding: 4px;
  }
}
</style>
</head>
<body>
<div class="header">
  <div class="view-selector">
    <button class="view-btn active" onclick="setView('day')" id="dayBtn">일</button>
    <button class="view-btn" onclick="setView('week')" id="weekBtn">주</button>
    <button class="view-btn" onclick="setView('month')" id="monthBtn">월</button>
  </div>
  
  <div class="nav-controls">
    <button class="nav-btn" onclick="navigateCalendar(-1)">‹</button>
    <div class="current-date" id="currentDate"></div>
    <button class="nav-btn" onclick="navigateCalendar(1)">›</button>
    <button class="nav-btn" onclick="goToToday()">오늘</button>
  </div>
  
  <button class="settings-btn" onclick="toggleSettings()">⚙️</button>
  
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-title">멀티 캘린더 설정</div>
    
    <div class="color-picker-group">
      <div class="color-picker-title">테마 색상</div>
      <div class="color-input-row">
        <input type="color" class="color-picker-input" id="colorPicker" onchange="updateColorFromPicker()">
        <input type="text" class="color-text-input" id="colorText" placeholder="#4285F4" oninput="updateColorFromText()" maxlength="7">
      </div>
      <div class="preset-colors">
        <div class="preset-color" style="background-color: #4285f4;" onclick="setPresetColor('#4285f4')"></div>
        <div class="preset-color" style="background-color: #34a853;" onclick="setPresetColor('#34a853')"></div>
        <div class="preset-color" style="background-color: #ea4335;" onclick="setPresetColor('#ea4335')"></div>
        <div class="preset-color" style="background-color: #ffc107;" onclick="setPresetColor('#ffc107')"></div>
        <div class="preset-color" style="background-color: #9c27b0;" onclick="setPresetColor('#9c27b0')"></div>
        <div class="preset-color" style="background-color: #607d8b;" onclick="setPresetColor('#607d8b')"></div>
      </div>
    </div>
    
    <div class="calendar-list-section">
      <div class="color-picker-title">연동된 캘린더 목록</div>
      <button class="btn btn-secondary" onclick="addSampleCalendar()" style="margin-bottom: 10px;">샘플 캘린더 추가</button>
      <div id="calendarList">
        <p style="color: #666; font-size: 12px; text-align: center; padding: 20px;">
          연동된 캘린더가 없습니다.<br>샘플 캘린더를 추가하거나 아래에서 캘린더를 추가해보세요!
        </p>
      </div>
    </div>
    
    <div class="add-calendar-section">
      <div class="color-picker-title">캘린더 추가</div>
      <div class="input-group">
        <label>캘린더 유형</label>
        <select id="calendarType" onchange="updateCalendarInputs()">
          <option value="ical">iCal 링크 (.ics)</option>
          <option value="googlePublic">구글 캘린더 공개 링크</option>
          <option value="api">구글 캘린더 API</option>
        </select>
      </div>
      
      <div class="input-group">
        <label>캘린더 이름</label>
        <input type="text" id="calendarName" placeholder="예: 개인 일정, 업무 캘린더">
      </div>
      
      <div class="input-group">
        <label>캘린더 색상</label>
        <input type="color" id="calendarColor" value="#4285f4">
      </div>
      
      <div id="icalInputs" class="calendar-inputs active">
        <div class="input-group">
          <label>iCal 링크</label>
          <textarea id="icalUrl" rows="3" placeholder="https://calendar.google.com/calendar/ical/.../basic.ics"></textarea>
          <div class="help-text">
            구글 캘린더 설정 → 통합 및 공유 → 비공개 주소의 iCal 링크를 복사하세요.
          </div>
        </div>
      </div>
      
      <div id="googlePublicInputs" class="calendar-inputs">
        <div class="input-group">
          <label>구글 캘린더 ID</label>
          <input type="text" id="googleCalendarId" placeholder="캘린더ID@group.calendar.google.com">
          <div class="help-text">
            공개된 구글 캘린더의 캘린더 ID를 입력하세요.<br>
            예: ko.south_korea#holiday@group.v.calendar.google.com (한국 공휴일)
          </div>
        </div>
      </div>
      
      <div id="apiInputs" class="calendar-inputs">
        <div class="input-group">
          <label>API 키</label>
          <input type="text" id="apiKey" placeholder="Google Calendar API 키">
        </div>
        <div class="input-group">
          <label>캘린더 ID</label>
          <input type="text" id="calendarId" placeholder="primary 또는 이메일@gmail.com">
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="addCalendar()">캘린더 추가</button>
    </div>

    <div class="debug-section">
      <div class="color-picker-title">디버그 정보</div>
      <button class="btn btn-secondary" onclick="clearDebugLog()">로그 지우기</button>
      <div id="debugLog" class="debug-log"></div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="closeSettings()"></div>

<div class="calendar-container">
  <div class="calendar-content" id="calendarContent">
    <div class="loading">캘린더를 불러오는 중...</div>
  </div>
</div>

<script>
// 전역 변수
let currentView = 'day';
let currentDate = new Date();
let accentColor = '#4285f4';
let accentHoverColor = '#3367d6';
let calendars = [];
let debugMessages = [];

// 캘린더 색상 팔레트
const calendarColors = [
  '#4285f4', '#34a853', '#ea4335', '#ffc107', '#9c27b0', '#607d8b'
];

// DOM 요소
const settingsPanel = document.getElementById("settingsPanel");
const overlay = document.getElementById("overlay");
const colorPicker = document.getElementById("colorPicker");
const colorText = document.getElementById("colorText");
const currentDateElement = document.getElementById("currentDate");
const calendarContent = document.getElementById("calendarContent");
const calendarList = document.getElementById("calendarList");
const debugLog = document.getElementById("debugLog");

// 디버그 로그 함수
function addDebugLog(message) {
  const timestamp = new Date().toLocaleTimeString();
  debugMessages.push(`[${timestamp}] ${message}`);
  if (debugMessages.length > 50) debugMessages.shift();
  
  if (debugLog) {
    debugLog.innerHTML = debugMessages.map(msg => `<div>${msg}</div>`).join('');
    debugLog.scrollTop = debugLog.scrollHeight;
  }
  console.log(message);
}

function clearDebugLog() {
  debugMessages = [];
  if (debugLog) {
    debugLog.innerHTML = '';
  }
}

// 초기화
function init() {
  loadFromStorage();
  updateCurrentDateDisplay();
  setAccentColor(accentColor);
  updateCalendarList();
  renderCalendar();
  addDebugLog('샘플 캘린더가 추가되었습니다.');
  addDebugLog('캘린더 뷰어가 시작되었습니다.');
}

// 설정 패널
function toggleSettings() {
  const isVisible = settingsPanel.style.display === 'block';
  if (isVisible) {
    closeSettings();
  } else {
    openSettings();
  }
}

function openSettings() {
  settingsPanel.style.display = 'block';
  overlay.style.display = 'block';
}

function closeSettings() {
  settingsPanel.style.display = 'none';
  overlay.style.display = 'none';
}

// 뷰 변경
function setView(viewMode) {
  currentView = viewMode;
  document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(viewMode + 'Btn').classList.add('active');
  updateCurrentDateDisplay();
  renderCalendar();
  saveToStorage();
}

// 날짜 네비게이션
function navigateCalendar(direction) {
  if (currentView === 'month') {
    currentDate.setMonth(currentDate.getMonth() + direction);
  } else if (currentView === 'week') {
    currentDate.setDate(currentDate.getDate() + (direction * 7));
  } else if (currentView === 'day') {
    currentDate.setDate(currentDate.getDate() + direction);
  }
  updateCurrentDateDisplay();
  renderCalendar();
}

function goToToday() {
  currentDate = new Date();
  updateCurrentDateDisplay();
  renderCalendar();
}

function updateCurrentDateDisplay() {
  if (currentView === 'day') {
    const options = { month: 'long', day: 'numeric', weekday: 'short' };
    const formatted = currentDate.toLocaleDateString('ko-KR', options);
    currentDateElement.textContent = formatted.replace(/(\d+일)\s*(\([^)]+\))/, '$1 $2');
  } else if (currentView === 'week') {
    const options = { year: 'numeric', month: 'long' };
    currentDateElement.textContent = currentDate.toLocaleDateString('ko-KR', options);
  } else {
    const options = { year: 'numeric', month: 'long' };
    currentDateElement.textContent = currentDate.toLocaleDateString('ko-KR', options);
  }
}

// 색상 관리
function darkenColor(hex, percent) {
  const num = parseInt(hex.replace("#", ""), 16);
  const amt = Math.round(2.55 * percent);
  const R = (num >> 16) - amt;
  const G = (num >> 8 & 0x00FF) - amt;
  const B = (num & 0x0000FF) - amt;
  return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
}

function setAccentColor(color) {
  accentColor = color;
  accentHoverColor = darkenColor(color, 15);
  
  document.documentElement.style.setProperty('--accent-color', color);
  document.documentElement.style.setProperty('--accent-hover-color', accentHoverColor);
  
  if (colorPicker) colorPicker.value = color;
  if (colorText) colorText.value = color.toUpperCase();
  
  saveToStorage();
}

function setPresetColor(color) {
  setAccentColor(color);
}

function updateColorFromPicker() {
  setAccentColor(colorPicker.value);
}

function updateColorFromText() {
  let color = colorText.value.trim();
  if (!color.startsWith('#')) color = '#' + color;
  if (/^#[0-9A-F]{6}$/i.test(color)) {
    setAccentColor(color);
  }
}

// 캘린더 입력 폼 업데이트
function updateCalendarInputs() {
  const type = document.getElementById('calendarType').value;
  
  document.querySelectorAll('.calendar-inputs').forEach(input => {
    input.classList.remove('active');
  });
  
  document.getElementById(type + 'Inputs').classList.add('active');
}

  // 샘플 캘린더 추가
  function addSampleCalendar() {
    const sampleEvents = generateSampleEvents();
    const sampleCalendar = {
      id: 'sample-' + Date.now(),
      name: '샘플 캘린더',
      type: 'sample',
      color: calendarColors[calendars.length % calendarColors.length],
      visible: true,
      events: sampleEvents,
      status: 'success',
      statusMessage: `${sampleEvents.length}개 이벤트`
    };
    
    calendars.push(sampleCalendar);
    updateCalendarList();
    renderCalendar();
    saveToStorage();
    addDebugLog('샘플 캘린더가 추가되었습니다.');
  }
  
  // 샘플 이벤트 생성
  function generateSampleEvents() {
    const events = [];
    const today = new Date();
    
    // 오늘부터 30일간의 샘플 이벤트 생성
    for (let i = -5; i < 25; i++) {
      const eventDate = new Date(today);
      eventDate.setDate(today.getDate() + i);
      
      // 랜덤하게 이벤트 추가
      if (Math.random() > 0.7) {
        events.push({
          title: getSampleEventTitle(),
          date: eventDate.toISOString().split('T')[0],
          time: Math.random() > 0.3 ? getSampleEventTime() : '종일',
          startTime: Math.random() > 0.3 ? getSampleEventTime() : '종일',
          endTime: Math.random() > 0.3 ? getSampleEventTime() : '종일',
          description: '샘플 이벤트입니다.'
        });
      }
    }
    
    return events;
  }

function getSampleEventTitle() {
  const titles = [
    '팀 회의', '프로젝트 미팅', '점심 약속', '의사 진료', '운동',
    '친구 만나기', '쇼핑', '영화 보기', '독서', '산책',
    '발표 준비', '보고서 작성', '고객 미팅', '세미나 참석', '교육 수강'
  ];
  return titles[Math.floor(Math.random() * titles.length)];
}

function getSampleEventTime() {
  const hour = Math.floor(Math.random() * 12) + 9; // 9시-20시
  const minute = Math.random() > 0.5 ? '00' : '30';
  return `${hour.toString().padStart(2, '0')}:${minute}`;
}

function getSampleEndTime(startTime) {
  if (startTime === '종일') return '종일';
  
  const [hour, minute] = startTime.split(':').map(Number);
  const duration = Math.floor(Math.random() * 3) + 1; // 1-3시간
  const endHour = Math.min(hour + duration, 23);
  return `${endHour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
}

// 캘린더 이벤트 로드
async function loadCalendarEvents(calendar) {
  addDebugLog(`이벤트 로드 시작: ${calendar.name} (${calendar.type})`);
  
  if (calendar.type === 'ical') {
    await loadIcalEvents(calendar);
  } else if (calendar.type === 'googlePublic') {
    await loadGooglePublicEvents(calendar);
  } else if (calendar.type === 'api') {
    await loadApiEvents(calendar);
  }
}

// iCal 이벤트 로드
async function loadIcalEvents(calendar) {
  const proxies = [
    `https://cors-anywhere.herokuapp.com/${calendar.url}`,
    `https://api.allorigins.win/get?url=${encodeURIComponent(calendar.url)}`,
    `https://corsproxy.io/?${encodeURIComponent(calendar.url)}`,
    `https://cors.sh/${calendar.url}`,
    `https://proxy.cors.sh/${calendar.url}`
  ];
  
  let lastError = null;
  
  for (const proxyUrl of proxies) {
    try {
      addDebugLog(`프록시 시도: ${proxyUrl.split('/')[2]}`);
      
      const response = await fetch(proxyUrl, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      let icalData;
      if (proxyUrl.includes('allorigins')) {
        const data = await response.json();
        icalData = data.contents;
      } else {
        icalData = await response.text();
      }
      
      if (!icalData || !icalData.includes('BEGIN:VCALENDAR')) {
        throw new Error('유효하지 않은 iCal 데이터');
      }
      
      calendar.events = parseIcalData(icalData);
      addDebugLog(`iCal 파싱 완료: ${calendar.events.length}개 이벤트`);
      return;
      
    } catch (error) {
      lastError = error;
      addDebugLog(`프록시 실패: ${proxyUrl.split('/')[2]} - ${error.message}`);
      continue;
    }
  }
  
  throw new Error(`모든 프록시 실패. 마지막 오류: ${lastError.message}`);
}

// 구글 공개 캘린더 로드
async function loadGooglePublicEvents(calendar) {
  const timeMin = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1).toISOString();
  const timeMax = new Date(currentDate.getFullYear(), currentDate.getMonth() + 2, 0).toISOString();
  
  // 공개 API 키 (제한적이지만 공개 캘린더용)
  const apiKey = 'AIzaSyBNlYH01_9Hc5S1J9vuFmu2nUqBZJNAXxs'; // 데모용 키
  const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendar.calendarId)}/events?key=${apiKey}&timeMin=${timeMin}&timeMax=${timeMax}&orderBy=startTime&singleEvents=true`;
  
  try {
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`API 오류: ${response.status} - ${response.statusText}`);
    }
    
    const data = await response.json();
    
    if (!data.items) {
      throw new Error('이벤트 데이터가 없습니다');
    }
    
    calendar.events = data.items.map(event => {
      const startDate = event.start.dateTime || event.start.date;
      const endDate = event.end.dateTime || event.end.date;
      const startTime = new Date(startDate);
      const endTime = new Date(endDate);
      
      return {
        title: event.summary || '제목 없음',
        date: startTime.toISOString().split('T')[0],
        startTime: event.start.dateTime ? 
          startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          '종일',
        endTime: event.end.dateTime ? 
          endTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          '종일',
        time: event.start.dateTime ? 
          startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          '종일',
        color: calendar.color,
        description: event.description || ''
      };
    });
    
    addDebugLog(`구글 공개 캘린더 로드 완료: ${calendar.events.length}개 이벤트`);
    
  } catch (error) {
    addDebugLog(`구글 공개 캘린더 로드 실패: ${error.message}`);
    throw error;
  }
}

// API 이벤트 로드
async function loadApiEvents(calendar) {
  const timeMin = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1).toISOString();
  const timeMax = new Date(currentDate.getFullYear(), currentDate.getMonth() + 2, 0).toISOString();
  
  const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendar.calendarId)}/events?key=${calendar.apiKey}&timeMin=${timeMin}&timeMax=${timeMax}&orderBy=startTime&singleEvents=true`;
  
  try {
    const response = await fetch(url);
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(`API 오류 ${response.status}: ${errorData.error?.message || response.statusText}`);
    }
    
    const data = await response.json();
    
    calendar.events = data.items.map(event => {
      const startDate = event.start.dateTime || event.start.date;
      const endDate = event.end.dateTime || event.end.date;
      const startTime = new Date(startDate);
      const endTime = new Date(endDate);
      
      return {
        title: event.summary || '제목 없음',
        date: startTime.toISOString().split('T')[0],
        startTime: event.start.dateTime ? 
          startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          '종일',
        endTime: event.end.dateTime ? 
          endTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          '종일',
        time: event.start.dateTime ? 
          startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          '종일',
        color: calendar.color,
        description: event.description || ''
      };
    });
    
    addDebugLog(`API 캘린더 로드 완료: ${calendar.events.length}개 이벤트`);
    
  } catch (error) {
    addDebugLog(`API 캘린더 로드 실패: ${error.message}`);
    throw error;
  }
}

// iCal 데이터 파싱 함수
function parseIcalData(icalText) {
  const events = [];
  const lines = icalText.split(/\r?\n/);
  let currentEvent = null;
  
  addDebugLog(`iCal 파싱 시작: ${lines.length}줄`);
  
  for (let i = 0; i < lines.length; i++) {
    let line = lines[i].trim();
    
    // 멀티라인 처리
    while (i + 1 < lines.length && lines[i + 1].match(/^\s/)) {
      i++;
      line += lines[i].trim();
    }
    
    if (line === 'BEGIN:VEVENT') {
      currentEvent = {};
    } else if (line === 'END:VEVENT' && currentEvent) {
      if (currentEvent.summary && currentEvent.dtstart) {
        events.push({
          title: currentEvent.summary,
          date: currentEvent.date,
          time: currentEvent.time || '종일',
          startTime: currentEvent.startTime || currentEvent.time || '종일',
          endTime: currentEvent.endTime || currentEvent.time || '종일',
          description: currentEvent.description || ''
        });
      }
      currentEvent = null;
    } else if (currentEvent) {
      const colonIndex = line.indexOf(':');
      if (colonIndex > 0) {
        const key = line.substring(0, colonIndex).split(';')[0];
        const value = line.substring(colonIndex + 1);
        
        switch (key) {
          case 'SUMMARY':
            currentEvent.summary = decodeIcalText(value);
            break;
          case 'DESCRIPTION':
            currentEvent.description = decodeIcalText(value);
            break;
          case 'DTSTART':
            const startDate = parseIcalDate(value);
            if (startDate) {
              currentEvent.dtstart = startDate.date;
              currentEvent.date = startDate.date;
              currentEvent.time = startDate.time;
              currentEvent.startTime = startDate.time;
            }
            break;
          case 'DTEND':
            const endDate = parseIcalDate(value);
            if (endDate) {
              currentEvent.endTime = endDate.time;
            }
            break;
        }
      }
    }
  }
  
  addDebugLog(`iCal 파싱 완료: ${events.length}개 이벤트 추출`);
  return events;
}

// iCal 텍스트 디코딩
function decodeIcalText(text) {
  return text
    .replace(/\\n/g, ' ')
    .replace(/\\,/g, ',')
    .replace(/\\;/g, ';')
    .replace(/\\\\/g, '\\')
    .trim();
}

// iCal 날짜 파싱 함수
function parseIcalDate(dateString) {
  try {
    // YYYYMMDD 형식 (종일 이벤트)
    if (dateString.length === 8) {
      const year = parseInt(dateString.substring(0, 4));
      const month = parseInt(dateString.substring(4, 6));
      const day = parseInt(dateString.substring(6, 8));
      const date = new Date(year, month - 1, day);
      return {
        date: date.toISOString().split('T')[0],
        time: '종일'
      };
    }
    
    // YYYYMMDDTHHMMSS[Z] 형식 (시간 포함)
    if (dateString.length >= 15) {
      const year = parseInt(dateString.substring(0, 4));
      const month = parseInt(dateString.substring(4, 6));
      const day = parseInt(dateString.substring(6, 8));
      const hour = parseInt(dateString.substring(9, 11));
      const minute = parseInt(dateString.substring(11, 13));
      
      const date = new Date(year, month - 1, day, hour, minute);
      
      // UTC 시간인 경우 (Z로 끝남) 로컬 시간으로 변환
      if (dateString.endsWith('Z')) {
        const localDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
        return {
          date: localDate.toISOString().split('T')[0],
          time: localDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false })
        };
      }
      
      return {
        date: date.toISOString().split('T')[0],
        time: `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`
      };
    }
  } catch (e) {
    addDebugLog(`날짜 파싱 오류: ${dateString} - ${e.message}`);
  }
  return null;
}

// 캘린더 색상 업데이트
function updateCalendarColor(calendarId, newColor) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar) {
    calendar.color = newColor;
    renderCalendar();
    saveToStorage();
    addDebugLog(`캘린더 색상 변경: ${calendar.name} → ${newColor}`);
  }
}

// 캘린더 이름 업데이트
function updateCalendarName(calendarId, newName) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar && newName.trim()) {
    calendar.name = newName.trim();
    saveToStorage();
    addDebugLog(`캘린더 이름 변경: ${newName}`);
  }
}

function updateCalendarStatus(calendarId, status, message = '') {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar) {
    calendar.status = status;
    calendar.statusMessage = message;
    updateCalendarList();
  }
}

// 캘린더 목록 업데이트
function updateCalendarList() {
  if (calendars.length === 0) {
    calendarList.innerHTML = `
      <p style="color: #666; font-size: 12px; text-align: center; padding: 20px;">
        연동된 캘린더가 없습니다.<br>샘플 캘린더를 추가하거나 아래에서 캘린더를 추가해보세요!
      </p>
    `;
    return;
  }
  
  calendarList.innerHTML = calendars.map(calendar => `
    <div class="calendar-item ${calendar.visible ? 'active' : ''}" data-id="${calendar.id}">
      <input type="color" value="${calendar.color}" 
             onchange="updateCalendarColor('${calendar.id}', this.value)" 
             class="calendar-color-picker" 
             title="캘린더 색상 변경">
      <div class="calendar-info">
        <input class="calendar-name" value="${calendar.name}" 
               onchange="updateCalendarName('${calendar.id}', this.value)"
               onblur="updateCalendarName('${calendar.id}', this.value)">
        <div class="calendar-url">${calendar.type === 'sample' ? '샘플 데이터' : 
          (calendar.url || calendar.calendarId || '').substring(0, 30)}${(calendar.url || calendar.calendarId || '').length > 30 ? '...' : ''}</div>
        <div class="calendar-status ${calendar.status}">${calendar.statusMessage || calendar.status}</div>
      </div>
      <div class="calendar-actions">
        <button class="toggle-btn ${calendar.visible ? 'visible' : 'hidden'}" 
                onclick="toggleCalendarVisibility('${calendar.id}')" 
                title="${calendar.visible ? '숨기기' : '보이기'}">
          ${calendar.visible ? '👁️' : '🚫'}
        </button>
        <button class="toggle-btn reload-btn" onclick="reloadCalendar('${calendar.id}')" title="새로고침">🔄</button>
        <button class="toggle-btn remove-btn" onclick="removeCalendar('${calendar.id}')" title="삭제">❌</button>
      </div>
    </div>
  `).join('');
}

// 캘린더 새로고침
async function reloadCalendar(calendarId) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (!calendar) return;
  
  if (calendar.type === 'sample') {
    // 샘플 캘린더는 새 데이터 생성
    calendar.events = generateSampleEvents();
    updateCalendarStatus(calendarId, 'success', `${calendar.events.length}개 이벤트`);
    renderCalendar();
    saveToStorage();
    addDebugLog(`샘플 캘린더 새로고침 완료: ${calendar.name}`);
    return;
  }
  
  updateCalendarStatus(calendarId, 'loading', '새로고침 중...');
  addDebugLog(`캘린더 새로고침: ${calendar.name}`);
  
  try {
    calendar.events = [];
    await loadCalendarEvents(calendar);
    updateCalendarStatus(calendarId, 'success', `${calendar.events.length}개 이벤트`);
    renderCalendar();
    saveToStorage();
    addDebugLog(`캘린더 새로고침 완료: ${calendar.name}`);
  } catch (error) {
    updateCalendarStatus(calendarId, 'error', error.message);
    addDebugLog(`캘린더 새로고침 실패: ${calendar.name} - ${error.message}`);
  }
}

// 캘린더 가시성 토글
function toggleCalendarVisibility(calendarId) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar) {
    calendar.visible = !calendar.visible;
    updateCalendarList();
    renderCalendar();
    saveToStorage();
    addDebugLog(`캘린더 가시성 변경: ${calendar.name} - ${calendar.visible ? '보임' : '숨김'}`);
  }
}

// 캘린더 삭제
function removeCalendar(calendarId) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar && confirm(`'${calendar.name}' 캘린더를 삭제하시겠습니까?`)) {
    calendars = calendars.filter(c => c.id !== calendarId);
    updateCalendarList();
    renderCalendar();
    saveToStorage();
    addDebugLog(`캘린더 삭제됨: ${calendar.name}`);
  }
}

// 캘린더 렌더링
function renderCalendar() {
  if (currentView === 'month') {
    renderMonthView();
  } else if (currentView === 'week') {
    renderWeekView();
  } else if (currentView === 'day') {
    renderDayView();
  }
}

function renderMonthView() {
  const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
  const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
  const startDate = new Date(firstDay);
  startDate.setDate(startDate.getDate() - firstDay.getDay());
  
  const grid = document.createElement('div');
  grid.className = 'calendar-grid month-view';
  
  // 요일 헤더
  const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
  weekdays.forEach(day => {
    const header = document.createElement('div');
    header.className = 'week-header';
    header.textContent = day;
    grid.appendChild(header);
  });
  
  // 날짜 셀
  const today = new Date();
  for (let i = 0; i < 42; i++) {
    const cellDate = new Date(startDate);
    cellDate.setDate(startDate.getDate() + i);
    
    const cell = document.createElement('div');
    cell.className = 'calendar-day';
    
    if (cellDate.getMonth() !== currentDate.getMonth()) {
      cell.classList.add('other-month');
    }
    
    if (cellDate.toDateString() === today.toDateString()) {
      cell.classList.add('today');
    }
    
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = cellDate.getDate();
    cell.appendChild(dayNumber);
    
    // 모든 캘린더의 이벤트 표시
    const dayEvents = getAllEventsForDate(cellDate);
    dayEvents.slice(0, 4).forEach(event => { // 최대 4개만 표시
      const eventDiv = document.createElement('div');
      eventDiv.className = 'event';
      eventDiv.style.backgroundColor = event.color;
      eventDiv.textContent = event.title;
      eventDiv.title = `${event.title}\n시간: ${event.time}\n캘린더: ${event.calendarName}${event.description ? '\n설명: ' + event.description : ''}`;
      cell.appendChild(eventDiv);
    });
    
    // 더 많은 이벤트가 있으면 표시
    if (dayEvents.length > 4) {
      const moreDiv = document.createElement('div');
      moreDiv.className = 'event';
      moreDiv.style.backgroundColor = '#999';
      moreDiv.textContent = `+${dayEvents.length - 4}개 더`;
      cell.appendChild(moreDiv);
    }
    
    grid.appendChild(cell);
  }
  
  calendarContent.innerHTML = '';
  calendarContent.appendChild(grid);
}

// 공통 상수
const SLOT_START_HOUR = 6;
const SLOT_END_HOUR = 23;
const SLOT_COUNT = SLOT_END_HOUR - SLOT_START_HOUR + 1;

const weekdays = ['일', '월', '화', '수', '목', '금', '토'];

// 주간 뷰 렌더링 (CSS Grid)
function renderWeekView() {
  const startOfWeek = new Date(currentDate);
  startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

  const container = document.createElement('div');
  container.style.padding = '20px';
  container.style.height = '100%';
  container.style.overflow = 'auto';

  const grid = document.createElement('div');
  grid.className = 'time-based-view week-view';
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = `80px repeat(7, 1fr)`; // 1열(시간) + 7요일
  grid.style.gridTemplateRows = `40px repeat(${SLOT_COUNT}, 50px)`; // 1행(헤더) + 시간수

  // 시간 헤더
  const timeHeader = document.createElement('div');
  timeHeader.className = 'week-header';
  timeHeader.textContent = '시간';
  timeHeader.style.gridRow = '1';
  timeHeader.style.gridColumn = '1';
  grid.appendChild(timeHeader);

  // 요일 헤더
  for (let i = 0; i < 7; i++) {
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + i);

    const header = document.createElement('div');
    header.className = 'week-header';
    header.style.gridRow = '1';
    header.style.gridColumn = `${i + 2}`; // 두번째 열부터

    if (date.toDateString() === (new Date()).toDateString()) {
      header.classList.add('today');
    }

    const dayName = document.createElement('div');
    dayName.textContent = weekdays[i];
    header.appendChild(dayName);

    const dayNumber = document.createElement('small');
    dayNumber.textContent = date.getDate();
    header.appendChild(dayNumber);

    grid.appendChild(header);
  }

  // 시간 라벨 및 각 칸 배경(이벤트 담기용)
  for (let row = 0; row < SLOT_COUNT; row++) {
    const hour = SLOT_START_HOUR + row;
    // 시간 라벨
    const timeSlot = document.createElement('div');
    timeSlot.className = 'time-slot';
    timeSlot.textContent = `${hour}:00`;
    timeSlot.style.gridRow = `${row + 2}`;
    timeSlot.style.gridColumn = '1';
    grid.appendChild(timeSlot);

    // 각 요일별 기본 배경(빈 칸)
    for (let day = 0; day < 7; day++) {
      const cell = document.createElement('div');
      cell.className = 'day-cell';
      cell.style.gridRow = `${row + 2}`;
      cell.style.gridColumn = `${day + 2}`;
      grid.appendChild(cell);
    }
  }

  // 이벤트 렌더링 (이벤트마다 여러 시간대를 걸쳐 한 번만 생성)
  for (let day = 0; day < 7; day++) {
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + day);

    const dayEvents = getAllEventsForDate(date);
    dayEvents.forEach((event, index) => {
      // 종일 이벤트: week-header 바로 밑(2번째 row)에 붙임
      if (event.time === '종일') {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'all-day-event';
        eventDiv.style.gridRow = '2';
        eventDiv.style.gridColumn = `${day + 2}`;
        eventDiv.style.margin = '2px 0';
        eventDiv.style.backgroundColor = event.color;
        eventDiv.textContent = event.title;
        eventDiv.title = `${event.title}\n캘린더: ${event.calendarName}`;
        grid.appendChild(eventDiv);
      } else {
        // 시간 이벤트: 시작~끝까지 row를 계산해 네모로 표시
        const startHour = getEventHour(event.startTime);
        const endHour = getEventHour(event.endTime);
        const startMinute = getEventMinute(event.startTime);
        const endMinute = getEventMinute(event.endTime);

        // 행 계산 (헤더: 1, 종일: 2, 실제 시간은 3부터 시작)
        const gridRowStart = (startHour - SLOT_START_HOUR) + 2 + (startMinute > 0 ? 1 : 0);
        // 소수점 단위 row 지원이 어려우면 그냥 시간 단위로만
        let gridRowEnd = (endHour - SLOT_START_HOUR) + 2;
        // 분단위가 있으면 다음칸까지 확장
        if (endMinute > 0) gridRowEnd += 1;

        // 최소 높이 반영: grid-row 대신 absolute로 height/fraction 쓰고 싶다면 추가 스타일 조정
        const eventDiv = document.createElement('div');
        eventDiv.className = 'time-event';
        eventDiv.style.gridRow = `${gridRowStart} / ${Math.max(gridRowEnd, gridRowStart + 1)}`;
        eventDiv.style.gridColumn = `${day + 2}`;
        eventDiv.style.backgroundColor = event.color;
        eventDiv.style.margin = '2px 2px';
        eventDiv.style.position = 'relative'; // 여러개 겹침 약간 오프셋
        eventDiv.style.left = `${4 + index * 2}px`;
        eventDiv.style.zIndex = index + 1;
        eventDiv.textContent = event.title;
        eventDiv.title = `${event.title}\n시간: ${event.startTime} - ${event.endTime}\n캘린더: ${event.calendarName}`;

        grid.appendChild(eventDiv);
      }
    });
  }

  container.appendChild(grid);
  calendarContent.innerHTML = '';
  calendarContent.appendChild(container);
}

// 일간 뷰 렌더링 (CSS Grid)
function renderDayView() {
  const container = document.createElement('div');
  container.style.padding = '20px';
  container.style.height = '100%';
  container.style.overflow = 'auto';

  const grid = document.createElement('div');
  grid.className = 'time-based-view day-view';
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = `80px 1fr`;
  grid.style.gridTemplateRows = `40px repeat(${SLOT_COUNT}, 50px)`;

  // 헤더
  const timeHeader = document.createElement('div');
  timeHeader.className = 'week-header';
  timeHeader.textContent = '시간';
  timeHeader.style.gridRow = '1';
  timeHeader.style.gridColumn = '1';
  grid.appendChild(timeHeader);

  const dayHeader = document.createElement('div');
  dayHeader.className = 'week-header';
  const today = new Date();
  if (currentDate.toDateString() === today.toDateString()) {
    dayHeader.classList.add('today');
  }
  const options = { month: 'short', day: 'numeric', weekday: 'short' };
  const dayName = document.createElement('div');
  dayName.textContent = currentDate.toLocaleDateString('ko-KR', options);
  dayHeader.appendChild(dayName);
  dayHeader.style.gridRow = '1';
  dayHeader.style.gridColumn = '2';
  grid.appendChild(dayHeader);

  // 시간 라벨 & 셀 기본 배경
  for (let row = 0; row < SLOT_COUNT; row++) {
    const hour = SLOT_START_HOUR + row;
    // 라벨
    const timeSlot = document.createElement('div');
    timeSlot.className = 'time-slot';
    timeSlot.textContent = `${hour}:00`;
    timeSlot.style.gridRow = `${row + 2}`;
    timeSlot.style.gridColumn = '1';
    grid.appendChild(timeSlot);

    const cell = document.createElement('div');
    cell.className = 'day-cell';
    cell.style.gridRow = `${row + 2}`;
    cell.style.gridColumn = '2';
    grid.appendChild(cell);
  }

  // 이벤트 (한 번만, 칸 수만큼 grid row로)
  const dayEvents = getAllEventsForDate(currentDate);
  dayEvents.forEach((event, index) => {
    if (event.time === '종일') {
      const eventDiv = document.createElement('div');
      eventDiv.className = 'all-day-event';
      eventDiv.style.gridRow = '2';
      eventDiv.style.gridColumn = '2';
      eventDiv.style.margin = '2px 0';
      eventDiv.style.backgroundColor = event.color;
      eventDiv.textContent = event.title;
      eventDiv.title = `${event.title}\n캘린더: ${event.calendarName}`;
      grid.appendChild(eventDiv);
    } else {
      const startHour = getEventHour(event.startTime);
      const endHour = getEventHour(event.endTime);
      const startMinute = getEventMinute(event.startTime);
      const endMinute = getEventMinute(event.endTime);

      const gridRowStart = (startHour - SLOT_START_HOUR) + 2 + (startMinute > 0 ? 1 : 0);
      let gridRowEnd = (endHour - SLOT_START_HOUR) + 2;
      if (endMinute > 0) gridRowEnd += 1;

      const eventDiv = document.createElement('div');
      eventDiv.className = 'time-event';
      eventDiv.style.gridRow = `${gridRowStart} / ${Math.max(gridRowEnd, gridRowStart + 1)}`;
      eventDiv.style.gridColumn = '2';
      eventDiv.style.backgroundColor = event.color;
      eventDiv.style.margin = '2px 2px';
      eventDiv.style.position = 'relative';
      eventDiv.style.left = `${4 + index * 2}px`;
      eventDiv.style.zIndex = index + 1;
      eventDiv.textContent = event.title;
      eventDiv.title = `${event.title}\n시간: ${event.startTime} - ${event.endTime}\n캘린더: ${event.calendarName}`;
      grid.appendChild(eventDiv);
    }
  });

  container.appendChild(grid);
  calendarContent.innerHTML = '';
  calendarContent.appendChild(container);
}

// 시간 파싱 관련 함수 및 이벤트 취득 함수 (원본과 동일)
function getEventHour(timeString) {
  if (timeString === '종일') return SLOT_START_HOUR;
  const parts = timeString.split(':');
  return parseInt(parts[0], 10) || 0;
}
function getEventMinute(timeString) {
  if (timeString === '종일') return 0;
  const parts = timeString.split(':');
  return parseInt(parts, 10) || 0;
}
function getAllEventsForDate(date) {
  const allEvents = [];
  calendars.forEach(calendar => {
    if (!calendar.visible || !calendar.events) return;
    const events = calendar.events.filter(event => {
      const eventDate = new Date(event.date + 'T00:00:00');
      return eventDate.toDateString() === date.toDateString();
    });
    events.forEach(event => {
      allEvents.push({
        ...event,
        color: calendar.color,
        calendarName: calendar.name
      });
    });
  });
  // 종일 > 그 외 시간순
  allEvents.sort((a, b) => {
    if (a.time === '종일' && b.time !== '종일') return -1;
    if (a.time !== '종일' && b.time === '종일') return 1;
    if (a.time === '종일' && b.time === '종일') return 0;
    return a.time.localeCompare(b.time);
  });
  return allEvents;
}


// 캘린더 추가
async function addCalendar() {
  const type = document.getElementById('calendarType').value;
  const name = document.getElementById('calendarName').value.trim();
  const color = document.getElementById('calendarColor').value;
  
  if (!name) {
    alert('캘린더 이름을 입력해주세요.');
    return;
  }
  
  let url = '';
  let calendarId = '';
  let apiKey = '';
  
  if (type === 'ical') {
    url = document.getElementById('icalUrl').value.trim();
    if (!url || !url.includes('.ics')) {
      alert('올바른 iCal 링크를 입력해주세요.');
      return;
    }
  } else if (type === 'googlePublic') {
    calendarId = document.getElementById('googleCalendarId').value.trim();
    if (!calendarId) {
      alert('구글 캘린더 ID를 입력해주세요.');
      return;
    }
  } else if (type === 'api') {
    apiKey = document.getElementById('apiKey').value.trim();
    calendarId = document.getElementById('calendarId').value.trim() || 'primary';
    if (!apiKey) {
      alert('API 키를 입력해주세요.');
      return;
    }
  }
  
  const calendar = {
    id: Date.now().toString(),
    name: name,
    type: type,
    color: color,
    visible: true,
    url: url,
    calendarId: calendarId,
    apiKey: apiKey,
    events: [],
    status: 'loading',
    statusMessage: '로딩 중...'
  };
  
  addDebugLog(`캘린더 추가 시작: ${name} (${type})`);
  
  calendars.push(calendar);
  updateCalendarList();
  
  // 캘린더 데이터 로드
  try {
    await loadCalendarEvents(calendar);
    updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}개 이벤트`);
    addDebugLog(`캘린더 로드 성공: ${name}, ${calendar.events.length}개 이벤트`);
    renderCalendar();
    saveToStorage();
    
    // 입력 폼 초기화
    document.getElementById('calendarName').value = '';
    document.getElementById('icalUrl').value = '';
    document.getElementById('googleCalendarId').value = '';
    document.getElementById('apiKey').value = '';
    document.getElementById('calendarId').value = '';
    
    closeSettings();
  } catch (error) {
    updateCalendarStatus(calendar.id, 'error', error.message);
    addDebugLog(`캘린더 로드 실패: ${name} - ${error.message}`);
    alert('캘린더를 불러오는데 실패했습니다: ' + error.message);
  }
}

// 저장/불러오기
function saveToStorage() {
  try {
    const data = {
      view: currentView,
      currentDate: currentDate.toISOString(),
      accentColor: accentColor,
      accentHoverColor: accentHoverColor,
      calendars: calendars.map(cal => ({
        ...cal,
        // 이벤트도 함께 저장하여 새로고침 시 유지
        events: cal.events || []
      }))
    };
    
    localStorage.setItem('multiCalendarData', JSON.stringify(data));
    addDebugLog('설정이 localStorage에 저장되었습니다.');
  } catch (e) {
    addDebugLog(`저장 실패: ${e.message}`);
  }
}

function loadFromStorage() {
  try {
    const data = localStorage.getItem('multiCalendarData');
    if (data) {
      const parsed = JSON.parse(data);
      currentView = parsed.view || 'day';
      if (parsed.currentDate) {
        currentDate = new Date(parsed.currentDate);
      }
      accentColor = parsed.accentColor || '#4285f4';
      accentHoverColor = parsed.accentHoverColor || darkenColor(accentColor, 15);
      calendars = parsed.calendars || [];
      
      // UI 복원
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(currentView + 'Btn').classList.add('active');
      
      // 저장된 캘린더들의 이벤트 다시 로드 (API 기반 캘린더만)
      calendars.forEach(async (calendar) => {
        if (calendar.type !== 'sample' && (!calendar.events || calendar.events.length === 0)) {
          updateCalendarStatus(calendar.id, 'loading', '로딩 중...');
          try {
            await loadCalendarEvents(calendar);
            updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}개 이벤트`);
          } catch (error) {
            updateCalendarStatus(calendar.id, 'error', error.message);
            addDebugLog(`저장된 캘린더 로드 실패: ${calendar.name} - ${error.message}`);
          }
        } else {
          // 이미 저장된 이벤트가 있으면 성공 상태로 표시
          updateCalendarStatus(calendar.id, 'success', `${(calendar.events || []).length}개 이벤트`);
        }
      });
      
      addDebugLog('설정이 localStorage에서 복원되었습니다.');
    }
  } catch (e) {
    addDebugLog(`불러오기 실패: ${e.message}`);
  }
}

// 한국 공휴일 샘플 추가
function addKoreanHolidays() {
  const holidayCalendar = {
    id: 'korean-holidays-' + Date.now(),
    name: '한국 공휴일',
    type: 'googlePublic',
    color: '#ea4335',
    visible: true,
    calendarId: 'ko.south_korea#holiday@group.v.calendar.google.com',
    events: [],
    status: 'loading',
    statusMessage: '로딩 중...'
  };
  
  calendars.push(holidayCalendar);
  updateCalendarList();
  
  loadCalendarEvents(holidayCalendar)
    .then(() => {
      updateCalendarStatus(holidayCalendar.id, 'success', `${holidayCalendar.events.length}개 이벤트`);
      renderCalendar();
      saveToStorage();
      addDebugLog('한국 공휴일 캘린더 추가 완료');
    })
    .catch(error => {
      updateCalendarStatus(holidayCalendar.id, 'error', error.message);
      addDebugLog(`한국 공휴일 캘린더 추가 실패: ${error.message}`);
    });
}

// 초기화 실행
init();

// 키보드 단축키
document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  
  switch(e.key) {
    case 'ArrowLeft':
      navigateCalendar(-1);
      e.preventDefault();
      break;
    case 'ArrowRight':
      navigateCalendar(1);
      e.preventDefault();
      break;
    case 't':
    case 'T':
      goToToday();
      break;
    case 'm':
    case 'M':
      setView('month');
      break;
    case 'w':
    case 'W':
      setView('week');
      break;
    case 'd':
    case 'D':
      setView('day');
      break;
    case 'Escape':
      closeSettings();
      break;
  }
});

// 캘린더 색상 자동 할당
document.getElementById('calendarColor').addEventListener('focus', function() {
  this.value = calendarColors[calendars.length % calendarColors.length];
});

// 디버그용 함수들
window.debugCalendar = {
  showCalendars: () => console.table(calendars),
  showEvents: (calendarId) => {
    const calendar = calendars.find(c => c.id === calendarId || c.name === calendarId);
    if (calendar) {
      console.table(calendar.events);
    } else {
      console.log('캘린더를 찾을 수 없습니다.');
    }
  },
  clearStorage: () => {
    localStorage.removeItem('multiCalendarData');
    location.reload();
  },
  addKoreanHolidays: addKoreanHolidays,
  addSampleCalendar: addSampleCalendar
};

// 도움말 표시
console.log('%c멀티 캘린더 뷰어 디버그 도구%c\n' +
  'debugCalendar.showCalendars() - 모든 캘린더 정보 표시\n' +
  'debugCalendar.showEvents(캘린더ID) - 특정 캘린더의 이벤트 표시\n' +
  'debugCalendar.clearStorage() - 저장된 데이터 삭제 및 새로고침\n' +
  'debugCalendar.addKoreanHolidays() - 한국 공휴일 캘린더 추가\n' +
  'debugCalendar.addSampleCalendar() - 샘플 캘린더 추가', 
  'color: #4285f4; font-weight: bold; font-size: 14px;', 
  'color: #333; font-size: 12px;');
</script>
</body>
</html>
