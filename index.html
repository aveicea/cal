<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë©€í‹° ìº˜ë¦°ë” ë·°ì–´</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 13px;
    color: #333;
    background: transparent;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0;
    margin: 0;
    touch-action: manipulation;
  }

  #widget-container {
    width: 100%;
    max-width: 400px;
    height: 700px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    padding: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }
  
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0;
    padding: 12px 16px;
    border-bottom: 1px solid #e5e5e7;
    flex-shrink: 0;
  }
  
  .view-selector {
    display: flex;
    gap: 8px;
    align-items: center;
    flex: 1;
    justify-content: center;
  }
  
  .view-btn {
    padding: 6px 10px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #666;
    width: 32px;  /* ìˆ˜ì • - view-btn í¬ê¸°ë¥¼ nav-btnê³¼ ë™ì¼í•˜ê²Œ */
    height: 32px; /* ìˆ˜ì • - view-btn í¬ê¸°ë¥¼ nav-btnê³¼ ë™ì¼í•˜ê²Œ */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0; /* ìˆ˜ì • - padding ì œê±°í•´ì„œ í¬ê¸° ë§ì¶¤ */
  }
  
  .view-btn-group .view-btn:last-child {
    margin-right: 8px;
  }
  
  
  .view-btn.active {
    background: var(--accent-color, #D1D1D1);
    color: white;
    border-color: var(--accent-color, #D1D1D1);
  }
  
  .nav-controls {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-right: 0;
  }
  
  .nav-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    color: #666;  
  }
  
  .nav-btn:hover {
    background: #f8f9fa;
    color: #333;
  }
  
  .current-date {
    padding: 6px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    color: #333;
    min-width: 80px;   /* ìˆ˜ì • - 120pxì—ì„œ 80pxë¡œ ì¤„ì„ */
    max-width: 80px;   /* ì¶”ê°€ - ìµœëŒ€ ë„“ì´ ì œí•œ */
    text-align: center;
    margin: 0 5px;     /* ì¶”ê°€ - ì¢Œìš° ì—¬ë°± */
    height: 20px;      /* ì¶”ê°€ - ë†’ì´ ì œí•œ */
    display: flex;     /* ì¶”ê°€ - flexboxë¡œ ì¤‘ì•™ ì •ë ¬ */
    align-items: center; /* ì¶”ê°€ - ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
    justify-content: center; /* ì¶”ê°€ - ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
  }
  
  .settings-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    transition: all 0.2s ease;
  }

  .settings-btn:hover {
    background: transparent;
    color: #333;
  }
  
  .settings-panel {
    position: absolute;
    top: 60px;
    right: 16px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    width: calc(100% - 32px);
    max-width: 350px;
    z-index: 1000;
    display: none;
    max-height: 500px;
    overflow-y: auto;
    box-sizing: border-box;
  }
  
  .settings-title {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 15px;
    color: #333;
  }
  
  .color-picker-group {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .color-picker-title {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 10px;
    color: #333;
  }
  
  .color-input-row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .color-picker-input {
    width: 40px;
    height: 30px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    padding: 0;
  }
  
  .color-text-input {
    flex: 1;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 12px;
    font-family: monospace;
  }
  
  .preset-colors {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 4px;
  }
  
  .preset-color {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .preset-color:hover {
    transform: scale(1.1);
    border-color: #333;
  }
  
  .calendar-list-section {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
  }

  .text-align-section {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
  }

  .calendar-item {
    display: flex;
    align-items: center;
    padding: 8px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    margin-bottom: 8px;
    background: #f8f9fa;
  }
  
  .calendar-item.active {
    border-color: var(--accent-color, #D1D1D1);
    background: #e3f2fd;
  }
  
  .calendar-color-picker {
    width: 24px;
    height: 24px;
    border: none;
    border-radius: 50%;
    margin-right: 8px;
    cursor: pointer;
    padding: 0;
    background: none;
    box-shadow: 0 0 0 2px white, 0 0 0 3px #ddd;
  }
  
  .calendar-color-picker:hover {
    transform: scale(1.1);
    transition: transform 0.2s ease;
  }
  
  .calendar-info {
    flex: 1;
  }
  
  .calendar-name {
    font-size: 13px;
    font-weight: 500;
    color: #333;
    background: none;
    border: none;
    padding: 0;
    margin: 0;
    width: 100%;
  }
  
  .calendar-name:focus {
    outline: 1px solid var(--accent-color, #D1D1D1);
    outline-offset: 1px;
    border-radius: 2px;
  }
  
  .calendar-url {
    font-size: 11px;
    color: #666;
    word-break: break-all;
    margin-top: 2px;
  }
  
  .calendar-status {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    margin-top: 2px;
    display: inline-block;
  }
  
  .calendar-status.success {
    background: #e8f5e8;
    color: #2e7d32;
  }
  
  .calendar-status.error {
    background: #ffebee;
    color: #c62828;
  }
  
  .calendar-status.loading {
    background: #e3f2fd;
    color: #1976d2;
  }
  
  .calendar-actions {
    display: flex;
    gap: 4px;
  }
  
  .toggle-btn {
    width: 20px;
    height: 20px;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.2s ease;
  }
  
  .toggle-btn.visible {
    background: var(--accent-color, #D1D1D1);
    color: white;
  }
  
  .toggle-btn.hidden {
    background: #ccc;
    color: white;
  }
  
  .remove-btn {
    background: #f44336;
    color: white;
  }
  
  .reload-btn {
    background: #ff9800;
    color: white;
    font-size: 10px;
  }
  
  .add-calendar-section {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .input-group {
    margin-bottom: 10px;
  }
  
  .input-group label {
    display: block;
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
  }
  
  .input-group input, .input-group textarea, .input-group select {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 12px;
    box-sizing: border-box;
    resize: vertical;
  }
  
  .help-text {
    font-size: 11px;
    color: #888;
    margin-top: 4px;
    line-height: 1.4;
  }
  
  .btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-right: 8px;
    margin-bottom: 8px;
  }
  
  .btn-primary {
    background: var(--accent-color, #D1D1D1);
    color: white;
  }
  
  .btn-primary:hover {
    background: var(--accent-hover-color, #3367d6);
  }
  
  .btn-secondary {
    background: #f8f9fa;
    color: #666;
    border: 1px solid #ddd;
  }
  
  .calendar-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .calendar-content {
    flex: 1;
    overflow: hidden;
    background: transparent;
  }
    
  /* ì›”ê°„ ë·° */
  .calendar-grid.month-view {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: auto repeat(6, 1fr);
    gap: 1px;
    background: #e0e0e0;
    border: 1px solid #e0e0e0;
    height: 100%;
    min-height: 400px;
    width: 100%;
    table-layout: fixed;
  }
  
    .calendar-day {
    background: white;
    min-height: 40px;
    max-height: 120px;
    padding: 4px;
    position: relative;
    font-size: 11px;
    border: none;
    overflow-y: auto;  /* ìˆ˜ì •: hidden â†’ auto */
    overflow-x: hidden;
    width: 100%;
    box-sizing: border-box;
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
  }

  .calendar-day::-webkit-scrollbar {
    display: none;  /* Chrome, Safari, Opera */
  }
  
  .calendar-day.other-month {
    background: #f8f9fa;
    color: #999;
  }
  
  .calendar-day.today {
    background: var(--accent-color, #D1D1D1);  /* ê¸°ì¡´: #e3f2fd */
  }
  
  .day-number {
    font-weight: 500;
    margin-bottom: 3px;
  }
  
  .event {
    padding: 1px 3px;
    border-radius: 2px;
    font-size: 10px;
    margin-bottom: 1px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: #333;
    cursor: pointer;
    max-width: 100%;  /* ì¶”ê°€ */
    display: block;  /* ì¶”ê°€ */
    text-align: center;  /* ê°€ìš´ë° ì •ë ¬ */
  }
  
  /* ì‹œê°„ ê¸°ë°˜ ë·° ê°œì„  */
  .time-based-view {
    display: grid;
    background: white;
    height: 100%;
    overflow: visible;
  }

  .week-view {
    grid-template-columns: 50px repeat(7, 1fr);
    grid-template-rows: 30px 18px repeat(24, 24px);
  }

  .day-view {
    grid-template-columns: 50px 1fr;
    grid-template-rows: 30px 18px repeat(24, 24px);
  }
  
  .time-slot {
    background: #f8f9fa;
    padding: 2px;
    font-size: 8px;
    color: #666;
    border-right: 1px solid #e0e0e0;
    border-bottom: 1px solid #f0f0f0;
    text-align: center;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .day-column {
    background: white;
    position: relative;
    border-right: 1px solid #f0f0f0;
    border-bottom: 1px solid #f0f0f0;
    overflow: hidden;
  }
  
  .day-column:last-child {
    border-right: none;
  }
  
  .week-header {
    background: #f8f9fa;
    padding: 8px;
    font-weight: 500;
    text-align: center;
    font-size: 11px;
    border-bottom: 1px solid #e0e0e0;
    border-right: 1px solid #f0f0f0;
    color: #333;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  
  .week-header:last-child {
    border-right: none;
  }
  
  .week-header.today {
    background: var(--accent-color, #D1D1D1);  /* ê¸°ì¡´: #e3f2fd */
    color: var(--accent-color, #D1D1D1);  /* ë‹¤ì‹œ ì›ë˜ëŒ€ë¡œ */
    font-weight: 600;
  }
  
  .week-header small {
    font-size: 11px;
    font-weight: normal;
    margin-top: 2px;
  }
  
  /* ì´ë²¤íŠ¸ ìŠ¤íƒ€ì¼ë§ ê°œì„  */
  .time-event {
    position: absolute;
    left: 4px;
    right: 4px;
    border-radius: 4px;
    padding: 2px 6px;
    color: #333;
    font-weight: 500;
    font-size: 6px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: normal;  /* nowrap â†’ normalë¡œ ë³€ê²½ */
    word-wrap: break-word;
    word-break: break-word;
    line-height: 1.2;
    overflow: visible;  /* hidden â†’ visibleë¡œ ë³€ê²½ */
    text-overflow: clip;  /* ellipsis â†’ clipìœ¼ë¡œ ë³€ê²½ */
  }
  
  .time-event:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    z-index: 2;
  }
  
  .all-day-event {
    position: absolute;
    top: 2px;
    left: 4px;
    right: 4px;
    height: 20px;
    line-height: 18px;
    border-radius: 3px;
    padding: 0 6px;
    color: #333;
    font-weight: 500;
    font-size: 8px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: pointer;
    z-index: 1;
  }

  .all-day-row {
    position: relative;
    background: #fafafa;
    border-bottom: 1px solid #e0e0e0;
  }

  .all-day-slot {
    position: relative;
    background: #f8f9fa;
    border-right: 1px solid #f0f0f0;
    border-bottom: 1px solid #e0e0e0;
  }

  .all-day-event-bar {
    position: absolute;
    top: 2px;
    bottom: 2px;
    border-radius: 3px;
    font-size: 8px;
    color: white;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: pointer;
    z-index: 1;
    display: flex;
    align-items: center;
    padding: 0 4px;
    box-sizing: border-box;
  }
  
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: #666;
  }
  
  .error-message {
    background: #ffebee;
    border: 1px solid #ffcdd2;
    border-radius: 8px;
    padding: 16px;
    margin: 20px;
    color: #c62828;
    font-size: 12px;
  }
  
  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.1);
    z-index: 999;
    display: none;
  }
  
  .debug-section {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .debug-log {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 10px;
    font-family: monospace;
    font-size: 11px;
    max-height: 200px;
    overflow-y: auto;
    margin-top: 10px;
  }
  
  .calendar-inputs {
    display: none;
  }
  
  .calendar-inputs.active {
    display: block;
  }
  
  @media (max-width: 768px) {
    .settings-panel {
      right: 10px;
      left: 10px;
      width: auto;
      max-width: none;
    }
    .nav-controls {
      margin-right: 0;
    }
    .time-slot {
      font-size: 9px;
      padding: 2px;
    }
    .week-header {
      font-size: 11px;
      padding: 4px;
    }
  }
  
  @media (max-height: 600px) {
    .calendar-grid.month-view {
      min-height: 200px;
    }
  }

  @media (min-height: 800px) {
    .calendar-grid.month-view {
      min-height: 400px;
    }
  }
  
  .view-calendar-section {
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid #eee;
}

  .view-calendar-section:last-child {
    border-bottom: none;
  }

  .view-calendar-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .view-calendar-item {
    display: flex;
    align-items: center;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
  }

  .view-calendar-item:hover {
    background-color: #f0f0f0;
  }

  .view-calendar-item input[type="checkbox"] {
    cursor: pointer;
  }

  .backup-section {
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid #eee;
}

  .btn {
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
  }

  .btn-primary {
    background-color: var(--accent-color);
    color: white;
  }

  .btn-primary:hover {
    background-color: var(--accent-hover-color);
  }

  .btn-secondary {
    background-color: #f5f5f5;
    color: #333;
    border: 1px solid #ddd;
  }

  .btn-secondary:hover {
    background-color: #e8e8e8;
  }

  .toggle-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  cursor: pointer;
  user-select: none;
}

  .toggle-icon {
    font-size: 12px;
    transition: transform 0.2s;
    color: #666;
  }

  .toggle-icon.expanded {
    transform: rotate(180deg);
  }

  .toggle-content {
    display: none;
    margin-top: 10px;
  }

  .toggle-content.expanded {
    display: block;
  }

  .toggle-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  cursor: pointer;
  user-select: none;
  transition: background-color 0.2s;
}

  .toggle-header:hover {
    background: rgba(0,0,0,0.02);
    border-radius: 4px;
  }

  .toggle-icon {
    font-size: 12px;
    transition: transform 0.2s;
    color: #666;
    margin-left: 8px;
  }

  .toggle-icon.expanded {
    transform: rotate(180deg);
  }

  .toggle-content {
    display: none;
    margin-top: 8px;
  }

  .toggle-content.expanded {
    display: block;
  }

  .nav-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    font-size: 14px;
  }

  .nav-btn:hover {
    background: rgba(0,0,0,0.1);
  }

</style>
</head>
<body>
<div id="widget-container">
<div class="header">
  <div class="view-selector">
    <button class="view-btn active" onclick="setView('day')" id="dayBtn">ì¼</button>
    <button class="view-btn" onclick="setView('week')" id="weekBtn">ì£¼</button>
    <button class="view-btn" onclick="setView('month')" id="monthBtn">ì›”</button>
  </div>
  
  <div class="nav-controls">
    <button class="nav-btn" onclick="navigateCalendar(-1)">â€¹</button>
    <div class="current-date" id="currentDate"></div>
    <button class="nav-btn" onclick="navigateCalendar(1)">â€º</button>
  </div>

  <button class="nav-btn" onclick="goToToday()">ğŸ“…</button>
  <button class="settings-btn" onclick="toggleSettings()">âš™ï¸</button>
  
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-title">ë©€í‹° ìº˜ë¦°ë” ì„¤ì •</div>

<!-- ë·°ë³„ ìº˜ë¦°ë” ì„ íƒ -->
<div class="view-calendar-section">
  <div class="toggle-header" onclick="toggleSection('viewCalendarSettings', 'viewToggleIcon')">
    <div class="color-picker-title">ë·°ë³„ ìº˜ë¦°ë” ì„ íƒ</div>
    <div class="toggle-icon" id="viewToggleIcon">â–¼</div>
  </div>
  <div class="toggle-content" id="viewCalendarSettings">
    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
  </div>
</div>

<!-- í…Œë§ˆ ìƒ‰ìƒ -->
<div class="color-picker-group">
  <div class="toggle-header" onclick="toggleSection('themeColorContent', 'themeToggleIcon')">
    <div class="color-picker-title">í…Œë§ˆ ìƒ‰ìƒ</div>
    <div class="toggle-icon" id="themeToggleIcon">â–¼</div>
  </div>
  <div class="toggle-content" id="themeColorContent">
    <div class="color-input-row">
      <input type="color" class="color-picker-input" id="colorPicker" onchange="updateColorFromPicker()">
      <input type="text" class="color-text-input" id="colorText" placeholder="#D1D1D1" oninput="updateColorFromText()" maxlength="7">
    </div>
    <div class="preset-colors">
      <div class="preset-color" style="background-color: #4285f4;" onclick="setPresetColor('#4285f4')"></div>
      <div class="preset-color" style="background-color: #34a853;" onclick="setPresetColor('#34a853')"></div>
      <div class="preset-color" style="background-color: #ea4335;" onclick="setPresetColor('#ea4335')"></div>
      <div class="preset-color" style="background-color: #ffc107;" onclick="setPresetColor('#ffc107')"></div>
      <div class="preset-color" style="background-color: #9c27b0;" onclick="setPresetColor('#9c27b0')"></div>
      <div class="preset-color" style="background-color: #607d8b;" onclick="setPresetColor('#607d8b')"></div>
    </div>
  </div>
</div>

<!-- ì¼ì • í…ìŠ¤íŠ¸ ì„¤ì • -->
<div class="text-align-section">
  <div class="toggle-header" onclick="toggleSection('textAlignContent', 'textAlignToggleIcon')">
    <div class="color-picker-title">ì¼ì • í…ìŠ¤íŠ¸ ì„¤ì •</div>
    <div class="toggle-icon" id="textAlignToggleIcon">â–¼</div>
  </div>
  <div class="toggle-content" id="textAlignContent">
    <div class="input-group">
      <label>ê°€ë¡œ ì •ë ¬</label>
      <select id="textAlignHorizontal" onchange="updateTextAlignment()">
        <option value="left">ì™¼ìª½</option>
        <option value="center">ê°€ìš´ë°</option>
      </select>
    </div>
    <div class="input-group">
      <label>ì„¸ë¡œ ì •ë ¬</label>
      <select id="textAlignVertical" onchange="updateTextAlignment()">
        <option value="top">ìœ„</option>
        <option value="center">ì¤‘ê°„</option>
      </select>
    </div>
    <div class="input-group">
      <label>ê¸€ì ìƒ‰ìƒ</label>
      <select id="eventTextColor" onchange="updateTextAlignment()">
        <option value="white">í°ìƒ‰</option>
        <option value="black">ê²€ì€ìƒ‰</option>
      </select>
    </div>
    <div class="input-group">
      <label>ê¸€ì í¬ê¸°</label>
      <select id="eventFontSize" onchange="updateTextAlignment()">
        <option value="0.5em">ë§¤ìš° ì‘ê²Œ</option>
        <option value="0.6em" selected>ì‘ê²Œ</option>
        <option value="0.7em">ë³´í†µ</option>
        <option value="0.8em">í¬ê²Œ</option>
        <option value="0.9em">ë§¤ìš° í¬ê²Œ</option>
      </select>
    </div>
  </div>
</div>

<!-- ì—°ë™ëœ ìº˜ë¦°ë” ëª©ë¡ -->
<div class="calendar-list-section">
  <div class="toggle-header" onclick="toggleSection('calendarListContent', 'listToggleIcon')">
    <div class="color-picker-title">ì—°ë™ëœ ìº˜ë¦°ë” ëª©ë¡</div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <button class="nav-btn" onclick="refreshAllCalendars()" title="ëª¨ë“  ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
      <div class="toggle-icon" id="listToggleIcon">â–¼</div>
    </div>
  </div>
  <div class="toggle-content" id="calendarListContent">
    <div id="calendarList">
      <p style="color: #666; font-size: 12px; text-align: center; padding: 20px;">
        ì—°ë™ëœ ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ì—ì„œ ìº˜ë¦°ë”ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!
      </p>
    </div>
  </div>
</div>

<!-- ìº˜ë¦°ë” ì¶”ê°€ -->
<div class="add-calendar-section">
  <div class="toggle-header" onclick="toggleSection('addCalendarContent', 'addToggleIcon')">
    <div class="color-picker-title">ìº˜ë¦°ë” ì¶”ê°€</div>
    <div class="toggle-icon" id="addToggleIcon">â–¼</div>
  </div>
  <div class="toggle-content" id="addCalendarContent">
    <div class="input-group">
      <label>ìº˜ë¦°ë” ìœ í˜•</label>
      <select id="calendarType" onchange="updateCalendarInputs()">
        <option value="ical">iCal ë§í¬ (.ics)</option>
        <option value="googlePublic">êµ¬ê¸€ ìº˜ë¦°ë” ê³µê°œ ë§í¬</option>
        <option value="api">êµ¬ê¸€ ìº˜ë¦°ë” API</option>
        <option value="notion">ë…¸ì…˜ ë°ì´í„°ë² ì´ìŠ¤</option>
      </select>
    </div>
    
    <div class="input-group">
      <label>ìº˜ë¦°ë” ì´ë¦„</label>
      <input type="text" id="calendarName" placeholder="ì˜ˆ: ê°œì¸ ì¼ì •, ì—…ë¬´ ìº˜ë¦°ë”">
    </div>
    
    <div class="input-group">
      <label>ìº˜ë¦°ë” ìƒ‰ìƒ</label>
      <input type="color" id="calendarColor" value="#D1D1D1">
    </div>
    
    <div id="icalInputs" class="calendar-inputs active">
      <div class="input-group">
        <label>iCal ë§í¬</label>
        <textarea id="icalUrl" rows="3" placeholder="https://calendar.google.com/calendar/ical/.../basic.ics"></textarea>
        <div class="help-text">
          êµ¬ê¸€ ìº˜ë¦°ë” ì„¤ì • â†’ í†µí•© ë° ê³µìœ  â†’ ë¹„ê³µê°œ ì£¼ì†Œì˜ iCal ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”.
        </div>
      </div>
    </div>
    
    <div id="googlePublicInputs" class="calendar-inputs">
      <div class="input-group">
        <label>êµ¬ê¸€ ìº˜ë¦°ë” ID</label>
        <input type="text" id="googleCalendarId" placeholder="ìº˜ë¦°ë”ID@group.calendar.google.com">
        <div class="help-text">
          ê³µê°œëœ êµ¬ê¸€ ìº˜ë¦°ë”ì˜ ìº˜ë¦°ë” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>
          ì˜ˆ: ko.south_korea#holiday@group.v.calendar.google.com (í•œêµ­ ê³µíœ´ì¼)
        </div>
      </div>
    </div>
    
    <div id="apiInputs" class="calendar-inputs">
      <div class="input-group">
        <label>API í‚¤</label>
        <input type="text" id="apiKey" placeholder="Google Calendar API í‚¤">
      </div>
      <div class="input-group">
        <label>ìº˜ë¦°ë” ID</label>
        <input type="text" id="calendarId" placeholder="primary ë˜ëŠ” ì´ë©”ì¼@gmail.com">
      </div>
    </div>

    <div id="notionInputs" class="calendar-inputs">
      <div class="input-group">
        <label>Notion API Key</label>
        <input type="text" id="notionApiKey" placeholder="secret_xxx...">
        <div class="help-text">
          notion.so â†’ Settings & members â†’ Integrationsì—ì„œ ìƒì„±í•œ Internal Integrationì˜ Secretì„ ì…ë ¥í•˜ì„¸ìš”.
        </div>
      </div>
      <div class="input-group">
        <label>Database ID</label>
        <input type="text" id="notionDatabaseId" placeholder="ë°ì´í„°ë² ì´ìŠ¤ URLì˜ ID ë¶€ë¶„">
        <div class="help-text">
          ë°ì´í„°ë² ì´ìŠ¤ URLì—ì„œ 32ìë¦¬ IDë¥¼ ë³µì‚¬í•˜ì„¸ìš”.<br>
          ì˜ˆ: https://notion.so/{workspace}/[ì´ ë¶€ë¶„]?v=...
        </div>
      </div>
      <div class="input-group">
        <label>ë‚ ì§œ ì†ì„± ì´ë¦„</label>
        <input type="text" id="notionDateProperty" placeholder="ì˜ˆ: Date, ë‚ ì§œ" value="Date">
        <div class="help-text">
          ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë‚ ì§œ ì •ë³´ë¥¼ ë‹´ê³  ìˆëŠ” ì†ì„±(ì»¬ëŸ¼) ì´ë¦„
        </div>
      </div>
      <div class="input-group">
        <label>ì œëª© ì†ì„± ì´ë¦„</label>
        <input type="text" id="notionTitleProperty" placeholder="ì˜ˆ: Name, ì œëª©" value="Name">
        <div class="help-text">
          ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¼ì • ì œëª©ì„ ë‹´ê³  ìˆëŠ” ì†ì„±(ì»¬ëŸ¼) ì´ë¦„
        </div>
      </div>
    </div>

    <button class="btn btn-primary" onclick="addCalendar()">ìº˜ë¦°ë” ì¶”ê°€</button>
  </div>
</div>

    <div class="backup-section">
      <div class="color-picker-title">ì„¤ì • ë°±ì—…/ë³µì›</div>
      <div style="display: flex; gap: 8px; margin-bottom: 10px;">
        <button class="btn btn-primary" onclick="exportCalendarSettings()">ì„¤ì • ë‚´ë ¤ë°›ê¸°</button>
        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ì„¤ì • ê°€ì ¸ì˜¤ê¸°</button>
      </div>
      <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importCalendarSettings(this)">
      <div style="font-size: 11px; color: #666; margin-top: 5px;">
        ìº˜ë¦°ë” ì—°ë™ ì •ë³´, ìƒ‰ìƒ, ë·° ì„¤ì • ë“±ì„ ë°±ì—…í•˜ê³  ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </div>
    
    <div class="debug-section">
      <div class="color-picker-title">ë””ë²„ê·¸ ì •ë³´</div>
      <button class="btn btn-secondary" onclick="clearDebugLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
      <div id="debugLog" class="debug-log"></div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="closeSettings()"></div>

<div class="calendar-container">
  <div class="calendar-content" id="calendarContent">
    <div class="loading">ìº˜ë¦°ë”ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜
let currentView = 'day';
let currentDate = new Date();
let accentColor = '#D1D1D1';
let accentHoverColor = '#3367d6';
let calendars = [];
let debugMessages = [];

let viewCalendarSettings = {
  day: [],    // ì¼ê°„ë·°ì—ì„œ ë³´ì¼ ìº˜ë¦°ë” ID ë°°ì—´
  week: [],   // ì£¼ê°„ë·°ì—ì„œ ë³´ì¼ ìº˜ë¦°ë” ID ë°°ì—´
  month: []   // ì›”ê°„ë·°ì—ì„œ ë³´ì¼ ìº˜ë¦°ë” ID ë°°ì—´
};

// í…ìŠ¤íŠ¸ ì •ë ¬ ì„¤ì •
let textAlignHorizontal = 'center'; // 'left' or 'center'
let textAlignVertical = 'center';   // 'top' or 'center'
let eventTextColor = 'white';       // 'white' or 'black'
let eventFontSize = '0.6em';        // ì¼ì • ê¸€ì”¨ í¬ê¸°


// ìº˜ë¦°ë” ìƒ‰ìƒ íŒ”ë ˆíŠ¸
const calendarColors = [
  '#4285f4', '#34a853', '#ea4335', '#ffc107', '#9c27b0', '#607d8b'
];

// DOM ìš”ì†Œ
const settingsPanel = document.getElementById("settingsPanel");
const overlay = document.getElementById("overlay");
const colorPicker = document.getElementById("colorPicker");
const colorText = document.getElementById("colorText");
const currentDateElement = document.getElementById("currentDate");
const calendarContent = document.getElementById("calendarContent");
const calendarList = document.getElementById("calendarList");
const debugLog = document.getElementById("debugLog");

// HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ (XSS ë°©ì§€)
function escapeHtml(text) {
  if (text == null) return '';
  const div = document.createElement('div');
  div.textContent = String(text);
  return div.innerHTML;
}

// ë””ë²„ê·¸ ë¡œê·¸ í•¨ìˆ˜
function addDebugLog(message) {
  const timestamp = new Date().toLocaleTimeString();
  debugMessages.push(`[${timestamp}] ${message}`);
  if (debugMessages.length > 50) debugMessages.shift();

  if (debugLog) {
    debugLog.innerHTML = debugMessages.map(msg => `<div>${escapeHtml(msg)}</div>`).join('');
    debugLog.scrollTop = debugLog.scrollHeight;
  }
  console.log(message);
}

function clearDebugLog() {
  debugMessages = [];
  if (debugLog) {
    debugLog.innerHTML = '';
  }
}

// ì´ˆê¸°í™”
function init() {
  loadFromStorage();

  // ëª¨ë‹¬ ê°•ì œë¡œ ìˆ¨ê¸°ê¸° (í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ëœ¨ëŠ” ë¬¸ì œ ë°©ì§€)
  const eventModal = document.getElementById('eventModal');
  const eventModalOverlay = document.getElementById('eventModalOverlay');
  if (eventModal) eventModal.style.display = 'none';
  if (eventModalOverlay) eventModalOverlay.style.display = 'none';

  // ë…¸ì…˜ì—ì„œëŠ” ì €ì¥ëœ ë‚ ì§œ ë¬´ì‹œí•˜ê³  í•­ìƒ ì˜¤ëŠ˜ ì‚¬ìš©
  const isNotion = window.location !== window.parent.location;
  if (isNotion) {
    currentDate = new Date();
    const hour = currentDate.getHours();

    if (hour < 6) {
      currentDate.setDate(currentDate.getDate() - 1);
    }

    addDebugLog('ë…¸ì…˜ í™˜ê²½: ì˜¤ëŠ˜ ë‚ ì§œë¡œ ë¦¬ì…‹');
  } else {
    // ë…¸ì…˜ì´ ì•„ë‹ ë•Œë§Œ ì €ì¥ëœ ë‚ ì§œ í™•ì¸
    if (!currentDate || isNaN(currentDate.getTime())) {
      currentDate = new Date();
      const hour = currentDate.getHours();

      if (hour < 6) {
        currentDate.setDate(currentDate.getDate() - 1);
      }
    }
  }
  updateCurrentDateDisplay();
  setAccentColor(accentColor);
  updateCalendarList();
  renderCalendar();
  addDebugLog('ìº˜ë¦°ë” ë·°ì–´ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
  // init() í•¨ìˆ˜ ëì— ì¶”ê°€
  setInterval(async () => {
    for (const calendar of calendars) {
      if (calendar.type !== 'sample' && calendar.visible) {
        try {
          const oldEventCount = calendar.events.length;
          await loadCalendarEvents(calendar);
          if (calendar.events.length !== oldEventCount) {
            renderCalendar();
            addDebugLog(`ìƒˆ ì¼ì • ê°ì§€: ${calendar.name}`);
          }
        } catch (error) {
          // ì¡°ìš©íˆ ì‹¤íŒ¨ ì²˜ë¦¬
        }
      }
    }
  }, 120000); // 2ë¶„ë§ˆë‹¤ ì²´í¬
}

// ì„¤ì • íŒ¨ë„
function toggleSettings() {
  const isVisible = settingsPanel.style.display === 'block';
  if (isVisible) {
    closeSettings();
  } else {
    openSettings();
  }
}

function openSettings() {
  settingsPanel.style.display = 'block';
  overlay.style.display = 'block';
}

function closeSettings() {
  settingsPanel.style.display = 'none';
  overlay.style.display = 'none';
}

// ë·° ë³€ê²½
function setView(viewMode) {
  currentView = viewMode;
  document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(viewMode + 'Btn').classList.add('active');
  updateCurrentDateDisplay();
  renderCalendar();
  saveToStorage();
}

// ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜
function navigateCalendar(direction) {
  if (currentView === 'month') {
    currentDate.setMonth(currentDate.getMonth() + direction);
  } else if (currentView === 'week') {
    currentDate.setDate(currentDate.getDate() + (direction * 7));
  } else if (currentView === 'day') {
    currentDate.setDate(currentDate.getDate() + direction);
  }
  updateCurrentDateDisplay();
  renderCalendar();
}

function goToToday() {
  currentDate = new Date();
  // 6ì‹œ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì •: 0-5ì‹œë©´ ì „ë‚ ì„ í‘œì‹œ
  if (currentDate.getHours() < 6) {
    currentDate.setDate(currentDate.getDate() - 1);
  }
  updateCurrentDateDisplay();
  renderCalendar();
}

function updateCurrentDateDisplay() {
  if (currentView === 'day') {
    const options = { month: 'long', day: 'numeric', weekday: 'short' };
    const formatted = currentDate.toLocaleDateString('ko-KR', options);
    currentDateElement.textContent = formatted.replace(/(\d+ì¼)\s*(\([^)]+\))/, '$1 $2');
  } else if (currentView === 'week') {
    const options = { year: 'numeric', month: 'long' };
    currentDateElement.textContent = currentDate.toLocaleDateString('ko-KR', options);
  } else {
    const options = { year: 'numeric', month: 'long' };
    currentDateElement.textContent = currentDate.toLocaleDateString('ko-KR', options);
  }
}

// í…ìŠ¤íŠ¸ ì •ë ¬ ì—…ë°ì´íŠ¸
function updateTextAlignment() {
  textAlignHorizontal = document.getElementById('textAlignHorizontal').value;
  textAlignVertical = document.getElementById('textAlignVertical').value;
  eventTextColor = document.getElementById('eventTextColor').value;
  eventFontSize = document.getElementById('eventFontSize').value;
  saveToStorage();
  renderCalendar();
  addDebugLog(`í…ìŠ¤íŠ¸ ì„¤ì • ë³€ê²½: ê°€ë¡œ=${textAlignHorizontal}, ì„¸ë¡œ=${textAlignVertical}, ìƒ‰ìƒ=${eventTextColor}, í¬ê¸°=${eventFontSize}`);
}

// ìƒ‰ìƒ ê´€ë¦¬
function darkenColor(hex, percent) {
  const num = parseInt(hex.replace("#", ""), 16);
  const amt = Math.round(2.55 * percent);
  const R = (num >> 16) - amt;
  const G = (num >> 8 & 0x00FF) - amt;
  const B = (num & 0x0000FF) - amt;
  return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
}

function lightenColor(hex, percent) {
  const num = parseInt(hex.replace("#", ""), 16);
  const amt = Math.round(2.55 * percent);
  const R = Math.min(255, (num >> 16) + amt);
  const G = Math.min(255, ((num >> 8) & 0x00FF) + amt);
  const B = Math.min(255, (num & 0x0000FF) + amt);
  return "#" + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
}

function setAccentColor(color) {
  accentColor = color;
  accentHoverColor = darkenColor(color, 15);
  
  document.documentElement.style.setProperty('--accent-color', color);
  document.documentElement.style.setProperty('--accent-hover-color', accentHoverColor);
  
  if (colorPicker) colorPicker.value = color;
  if (colorText) colorText.value = color.toUpperCase();
  
  saveToStorage();
}

function setPresetColor(color) {
  setAccentColor(color);
}

function updateColorFromPicker() {
  setAccentColor(colorPicker.value);
}

function updateColorFromText() {
  let color = colorText.value.trim();
  if (!color.startsWith('#')) color = '#' + color;
  if (/^#[0-9A-F]{6}$/i.test(color)) {
    setAccentColor(color);
  }
}

// ìº˜ë¦°ë” ì…ë ¥ í¼ ì—…ë°ì´íŠ¸
function updateCalendarInputs() {
  const type = document.getElementById('calendarType').value;
  
  document.querySelectorAll('.calendar-inputs').forEach(input => {
    input.classList.remove('active');
  });
  
  document.getElementById(type + 'Inputs').classList.add('active');
}

// ìº˜ë¦°ë” ì´ë²¤íŠ¸ ë¡œë“œ
async function loadCalendarEvents(calendar) {
  addDebugLog(`ì´ë²¤íŠ¸ ë¡œë“œ ì‹œì‘: ${calendar.name} (${calendar.type})`);

  if (calendar.type === 'ical') {
    await loadIcalEvents(calendar);
  } else if (calendar.type === 'googlePublic') {
    await loadGooglePublicEvents(calendar);
  } else if (calendar.type === 'api') {
    await loadApiEvents(calendar);
  } else if (calendar.type === 'notion') {
    await loadNotionEvents(calendar);
  }
}

// iCal ì´ë²¤íŠ¸ ë¡œë“œ
async function loadIcalEvents(calendar) {
  // ë” ì•ˆì •ì ì¸ í”„ë¡ì‹œ ì„œë¹„ìŠ¤ë“¤ë¡œ ì—…ë°ì´íŠ¸
  const proxies = [
    `https://corsproxy.io/?${encodeURIComponent(calendar.url)}`,
    // ìƒˆë¡œìš´ í”„ë¡ì‹œ ì¶”ê°€
    `https://proxy.cors.sh/${calendar.url}`,
    `https://cors.sh/${calendar.url}`,
    // ë°±ì—… ì˜µì…˜ë“¤
    `https://thingproxy.freeboard.io/fetch/${calendar.url}`,
    `https://yacdn.org/proxy/${calendar.url}`
  ];
  
  let lastError = null;
  
  for (const proxyUrl of proxies) {
    try {
      addDebugLog(`í”„ë¡ì‹œ ì‹œë„: ${proxyUrl.includes('allorigins') ? 'AllOrigins' : proxyUrl.split('/')[2]}`);
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ì´ˆ íƒ€ì„ì•„ì›ƒ
      
      const response = await fetch(proxyUrl, {
        method: 'GET',
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
          'Accept': 'text/calendar,text/plain,*/*',
          'Cache-Control': 'no-cache'
        },
        signal: controller.signal,
        mode: 'cors' // ëª…ì‹œì ìœ¼ë¡œ CORS ëª¨ë“œ ì„¤ì •
      });
      
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      let icalData;
      const contentType = response.headers.get('content-type') || '';
      
      if (proxyUrl.includes('allorigins')) {
        const data = await response.json();
        icalData = data.contents;
      } else {
        icalData = await response.text();
      }
      
      // iCal ë°ì´í„° ê²€ì¦ ê°•í™”
      if (!icalData || typeof icalData !== 'string') {
        throw new Error('ì‘ë‹µì´ í…ìŠ¤íŠ¸ê°€ ì•„ë‹˜');
      }
      
      if (!icalData.includes('BEGIN:VCALENDAR') && !icalData.includes('BEGIN:VEVENT')) {
        throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ iCal ë°ì´í„°');
      }
      
      calendar.events = parseIcalData(icalData);
      addDebugLog(`iCal íŒŒì‹± ì™„ë£Œ: ${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
      return;
      
    } catch (error) {
      lastError = error;
      if (error.name === 'AbortError') {
        addDebugLog(`í”„ë¡ì‹œ íƒ€ì„ì•„ì›ƒ: ${proxyUrl.split('/')[2]}`);
      } else {
        addDebugLog(`í”„ë¡ì‹œ ì‹¤íŒ¨: ${proxyUrl.split('/')[2]} - ${error.message}`);
      }
      continue;
    }
  }
  
  // ëª¨ë“  í”„ë¡ì‹œ ì‹¤íŒ¨ ì‹œ ì§ì ‘ ì ‘ê·¼ ì‹œë„ (CORS ì—ëŸ¬ ì˜ˆìƒë˜ì§€ë§Œ ì¼ë¶€ ì„œë²„ì—ì„œëŠ” ì‘ë™í•  ìˆ˜ ìˆìŒ)
  try {
    addDebugLog('ì§ì ‘ ì ‘ê·¼ ì‹œë„...');
    const response = await fetch(calendar.url, {
      method: 'GET',
      mode: 'no-cors', // CORS ìš°íšŒ ëª¨ë“œ
      cache: 'no-cache'
    });
    
    // no-cors ëª¨ë“œì—ì„œëŠ” ì‘ë‹µ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ì—†ìŒ
    throw new Error('ì§ì ‘ ì ‘ê·¼ ì‹¤íŒ¨ - CORS ì •ì±…ìœ¼ë¡œ ì¸í•´ ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ìŒ');
    
  } catch (directError) {
    addDebugLog(`ì§ì ‘ ì ‘ê·¼ë„ ì‹¤íŒ¨: ${directError.message}`);
  }
  
  throw new Error(`ëª¨ë“  í”„ë¡ì‹œ ì‹¤íŒ¨. ë§ˆì§€ë§‰ ì˜¤ë¥˜: ${lastError.message}\n\ní•´ê²°ë°©ë²•:\n1. êµ¬ê¸€ ìº˜ë¦°ë” ê³µê°œ ì„¤ì • í™•ì¸\n2. iCal ë§í¬ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸\n3. ë‹¤ë¥¸ ìº˜ë¦°ë” ì„œë¹„ìŠ¤ ì´ìš© ê³ ë ¤`);
}

// êµ¬ê¸€ ê³µê°œ ìº˜ë¦°ë” ë¡œë“œ
async function loadGooglePublicEvents(calendar) {
  const timeMin = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1).toISOString();
  const timeMax = new Date(currentDate.getFullYear(), currentDate.getMonth() + 2, 0).toISOString();
  
  // ê³µê°œ API í‚¤ (ì œí•œì ì´ì§€ë§Œ ê³µê°œ ìº˜ë¦°ë”ìš©)
  const apiKey = 'AIzaSyBNlYH01_9Hc5S1J9vuFmu2nUqBZJNAXxs'; // ë°ëª¨ìš© í‚¤
  const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendar.calendarId)}/events?key=${apiKey}&timeMin=${timeMin}&timeMax=${timeMax}&orderBy=startTime&singleEvents=true`;
  
  try {
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`API ì˜¤ë¥˜: ${response.status} - ${response.statusText}`);
    }
    
    const data = await response.json();
    
    if (!data.items) {
      throw new Error('ì´ë²¤íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
    }
    
    calendar.events = data.items.map(event => {
      const startDate = event.start.dateTime || event.start.date;
      const endDate = event.end.dateTime || event.end.date;
      const startTime = new Date(startDate);
      const endTime = new Date(endDate);
      
      return {
        title: event.summary || 'ì œëª© ì—†ìŒ',
        date: startTime.toISOString().split('T')[0],
        startTime: event.start.dateTime ? 
          startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          'ì¢…ì¼',
        endTime: event.end.dateTime ? 
          endTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          'ì¢…ì¼',
        time: event.start.dateTime ? 
          startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          'ì¢…ì¼',
        color: calendar.color,
        description: event.description || '',
        location: event.location || ''  // ìœ„ì¹˜ ì •ë³´ ì¶”ê°€
      };
    });
    
    addDebugLog(`êµ¬ê¸€ ê³µê°œ ìº˜ë¦°ë” ë¡œë“œ ì™„ë£Œ: ${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
    
  } catch (error) {
    addDebugLog(`êµ¬ê¸€ ê³µê°œ ìº˜ë¦°ë” ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
    throw error;
  }
}

// API ì´ë²¤íŠ¸ ë¡œë“œ
async function loadApiEvents(calendar) {
  // ë„“ì€ ë²”ìœ„ë¡œ ë³€ê²½ (iCalê³¼ ë™ì¼í•˜ê²Œ 3ë…„ ì „í›„)
  const now = new Date();
  const timeMin = new Date(now.getFullYear() - 3, 0, 1).toISOString();
  const timeMax = new Date(now.getFullYear() + 3, 11, 31).toISOString();

  // ëª¨ë“  í•„ë“œë¥¼ ìš”ì²­í•˜ë„ë¡ ìˆ˜ì •
  const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendar.calendarId)}/events?key=${calendar.apiKey}&timeMin=${timeMin}&timeMax=${timeMax}&orderBy=startTime&singleEvents=true&maxResults=2500`;

  addDebugLog(`API í˜¸ì¶œ (ëª¨ë“  í•„ë“œ ìš”ì²­): ${timeMin.split('T')[0]} ~ ${timeMax.split('T')[0]}`);

  try {
    const response = await fetch(url);
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(`API ì˜¤ë¥˜ ${response.status}: ${errorData.error?.message || response.statusText}`);
    }
    
    const data = await response.json();

    // ë””ë²„ê·¸: ì²« ë²ˆì§¸ ì´ë²¤íŠ¸ êµ¬ì¡° í™•ì¸
    if (data.items && data.items.length > 0) {
      const firstEvent = data.items[0];
      addDebugLog(`ì²« ë²ˆì§¸ ì´ë²¤íŠ¸ ì „ì²´ êµ¬ì¡°: ${JSON.stringify(firstEvent, null, 2).substring(0, 1000)}`);
      addDebugLog(`ì´ë²¤íŠ¸ í•„ë“œ ëª©ë¡: ${Object.keys(firstEvent).join(', ')}`);

      // ëª¨ë“  ì´ë²¤íŠ¸ì—ì„œ gadgetì´ë‚˜ extendedPropertiesê°€ ìˆëŠ”ì§€ í™•ì¸
      let hasGadget = false;
      let hasExtended = false;
      data.items.forEach((evt, idx) => {
        if (evt.gadget) {
          hasGadget = true;
          addDebugLog(`ì´ë²¤íŠ¸ ${idx}ì— gadget ë°œê²¬: ${JSON.stringify(evt.gadget)}`);
        }
        if (evt.extendedProperties) {
          hasExtended = true;
          addDebugLog(`ì´ë²¤íŠ¸ ${idx}ì— extendedProperties ë°œê²¬: ${JSON.stringify(evt.extendedProperties)}`);
        }
      });
      addDebugLog(`ì „ì²´ ${data.items.length}ê°œ ì´ë²¤íŠ¸ ì¤‘ gadget: ${hasGadget}, extendedProperties: ${hasExtended}`);
    }

    calendar.events = data.items.map((event, index) => {
      // ì²˜ìŒ 3ê°œ ì´ë²¤íŠ¸ì˜ summary ë¡œê¹…
      if (index < 3) {
        addDebugLog(`ì´ë²¤íŠ¸ ${index}: summary="${event.summary}", status="${event.status}"`);
      }
      const startDate = event.start.dateTime || event.start.date;
      const endDate = event.end.dateTime || event.end.date;
      const startTime = new Date(startDate);
      const endTime = new Date(endDate);

      // ì´ë™ì‹œê°„ íŒŒì‹± ì‹œë„ (Google Calendar APIì—ì„œëŠ” ì—¬ëŸ¬ í•„ë“œì— ìˆì„ ìˆ˜ ìˆìŒ)
      let travelTime = 0;

      // ë°©ë²• 1: extendedProperties í™•ì¸
      if (event.extendedProperties?.private?.travelTime) {
        travelTime = parseInt(event.extendedProperties.private.travelTime);
        addDebugLog(`ì´ë™ì‹œê°„ ë°œê²¬ (extendedProperties): ${travelTime}ì´ˆ`);
      }

      // ë°©ë²• 2: gadget ë°ì´í„° í™•ì¸ (êµ¬ê¸€ì´ travel timeì„ ì €ì¥í•˜ëŠ” ë°©ì‹)
      if (event.gadget?.preferences?.travelTime) {
        travelTime = parseInt(event.gadget.preferences.travelTime);
        addDebugLog(`ì´ë™ì‹œê°„ ë°œê²¬ (gadget): ${travelTime}ì´ˆ`);
      }

      // ë””ë²„ê·¸: ì´ë²¤íŠ¸ì— ì´ë™ì‹œê°„ ê´€ë ¨ í•„ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
      if (event.summary && (event.gadget || event.extendedProperties)) {
        addDebugLog(`ì´ë²¤íŠ¸ "${event.summary}" ì¶”ê°€ ë°ì´í„°: ${JSON.stringify({
          gadget: event.gadget ? 'exists' : 'none',
          extendedProperties: event.extendedProperties ? 'exists' : 'none'
        })}`);
      }

      return {
        title: event.summary || 'ì œëª© ì—†ìŒ',
        date: event.start.date || `${startTime.getFullYear()}-${String(startTime.getMonth() + 1).padStart(2, '0')}-${String(startTime.getDate()).padStart(2, '0')}`,
        startTime: event.start.dateTime ?
          startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          'ì¢…ì¼',
        endTime: event.end.dateTime ?
          endTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          'ì¢…ì¼',
        time: event.start.dateTime ?
          startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          'ì¢…ì¼',
        color: calendar.color,
        description: event.description || '',
        location: event.location || '',
        travelTime: travelTime
      };
    });

    addDebugLog(`API ìº˜ë¦°ë” ë¡œë“œ ì™„ë£Œ: ${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
    
  } catch (error) {
    addDebugLog(`API ìº˜ë¦°ë” ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
    throw error;
  }
}

// Notion ì´ë²¤íŠ¸ ë¡œë“œ
async function loadNotionEvents(calendar) {
  const databaseId = calendar.notionDatabaseId;
  const apiKey = calendar.notionApiKey;
  const dateProperty = calendar.notionDateProperty;
  const titleProperty = calendar.notionTitleProperty;

  // Vercel í”„ë¡ì‹œ ì„œë²„ URL (ë°°í¬ í›„ ì—¬ê¸°ë¥¼ ì‹¤ì œ URLë¡œ ë³€ê²½)
  const proxyUrl = 'https://cal-deh84wykk-aveiceas-projects.vercel.app/api/notion';

  try {
    addDebugLog(`Notion API í˜¸ì¶œ ì‹œì‘`);

    const response = await fetch(proxyUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        apiKey: apiKey,
        databaseId: databaseId
      })
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(`í”„ë¡ì‹œ ì˜¤ë¥˜ ${response.status}: ${errorData.error || errorData.message || response.statusText}`);
    }

    const data = await response.json();

    calendar.events = data.results.map(page => {
      // ì œëª© ì¶”ì¶œ
      const titleProp = page.properties[titleProperty];
      let title = 'ì œëª© ì—†ìŒ';
      if (titleProp) {
        if (titleProp.title && titleProp.title.length > 0) {
          title = titleProp.title[0].plain_text;
        } else if (titleProp.rich_text && titleProp.rich_text.length > 0) {
          title = titleProp.rich_text[0].plain_text;
        }
      }

      // ë‚ ì§œ ì¶”ì¶œ
      const dateProp = page.properties[dateProperty];
      let dateStr = null;
      let startTime = 'ì¢…ì¼';
      let endTime = 'ì¢…ì¼';

      if (dateProp && dateProp.date) {
        const startDate = new Date(dateProp.date.start);
        dateStr = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;

        // ì‹œê°„ ì •ë³´ê°€ ìˆëŠ” ê²½ìš°
        if (dateProp.date.start.includes('T')) {
          startTime = startDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
          if (dateProp.date.end) {
            const endDate = new Date(dateProp.date.end);
            endTime = endDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
          }
        }
      }

      return {
        title: title,
        date: dateStr,
        startTime: startTime,
        endTime: endTime,
        time: startTime,
        color: calendar.color,
        description: '',
        location: ''
      };
    }).filter(event => event.date !== null); // ë‚ ì§œê°€ ì—†ëŠ” í•­ëª© ì œì™¸

    addDebugLog(`Notion ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ ì™„ë£Œ: ${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);

  } catch (error) {
    addDebugLog(`Notion ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
    throw error;
  }
}

// iCal ë°ì´í„° íŒŒì‹± í•¨ìˆ˜
function parseIcalData(icalText) {
  const events = [];
  const lines = icalText.split(/\r?\n/);
  let currentEvent = null;
  const exceptionEvents = new Map();
  const recurringEvents = [];
  
  addDebugLog(`iCal íŒŒì‹± ì‹œì‘: ${lines.length}ì¤„`);
  
  for (let i = 0; i < lines.length; i++) {
    let line = lines[i].trim();
    
    // ë©€í‹°ë¼ì¸ ì²˜ë¦¬
    while (i + 1 < lines.length && lines[i + 1].match(/^\s/)) {
      i++;
      line += lines[i].trim();
    }
    
    if (line === 'BEGIN:VEVENT') {
      currentEvent = {};
    } 
    else if (line === 'END:VEVENT' && currentEvent) {
      if (currentEvent.summary && currentEvent.dtstart) {
        const baseEvent = {
          id: currentEvent.uid || `event_${Date.now()}_${Math.random()}`,
          uid: currentEvent.uid,
          title: currentEvent.summary,
          date: currentEvent.date,
          start: currentEvent.date + 'T' + (currentEvent.startTime === 'ì¢…ì¼' ? '00:00:00' : currentEvent.startTime + ':00'),
          end: currentEvent.date + 'T' + (currentEvent.endTime === 'ì¢…ì¼' ? '23:59:59' : currentEvent.endTime + ':00'),
          time: currentEvent.time || 'ì¢…ì¼',
          startTime: currentEvent.startTime || currentEvent.time || 'ì¢…ì¼',
          endTime: currentEvent.endTime || currentEvent.time || 'ì¢…ì¼',
          description: currentEvent.description || '',
          location: currentEvent.location || '',
          travelTime: currentEvent.travelTime || 0,
          exdate: currentEvent.exdate || [],
          rrule: currentEvent.rrule,
          recurrenceId: currentEvent.recurrenceId,
          isException: currentEvent.isException
        };
        
        // ìˆ˜ì •ëœ ì¸ìŠ¤í„´ìŠ¤ì¸ ê²½ìš°
        if (currentEvent.recurrenceId && currentEvent.uid) {
          const exceptionKey = `${currentEvent.uid}_${currentEvent.recurrenceId}`;
          exceptionEvents.set(exceptionKey, baseEvent);
          addDebugLog(`ì˜ˆì™¸ ì´ë²¤íŠ¸ ì €ì¥ í‚¤: ${exceptionKey}`);
        }
        // ë°˜ë³µ ì¼ì •ì¸ ê²½ìš°
        else if (currentEvent.rrule) {
          recurringEvents.push(baseEvent);
          addDebugLog(`ë°˜ë³µ ì¼ì • ì €ì¥: ${baseEvent.title}`);
        }
        // ì¼ë°˜ ë‹¨ì¼ ì´ë²¤íŠ¸
        else if (!currentEvent.isException) {
          events.push(baseEvent);
        }
      }
      currentEvent = null;
    }
    else if (currentEvent) {
      const colonIndex = line.indexOf(':');
      if (colonIndex > 0) {
        const key = line.substring(0, colonIndex).split(';')[0];
        const value = line.substring(colonIndex + 1);

        // ëª¨ë“  X-GOOGLE í•„ë“œ ë¡œê¹…
        if (key.startsWith('X-GOOGLE')) {
          addDebugLog(`iCal í•„ë“œ ë°œê²¬: ${key} = ${value.substring(0, 100)}`);
        }

        switch (key) {
          case 'UID':
            currentEvent.uid = value;
            break;
          case 'SUMMARY':
            currentEvent.summary = decodeIcalText(value);
            break;
          case 'DESCRIPTION':
            currentEvent.description = decodeIcalText(value);
            break;
          case 'DTSTART':
            const startDate = parseIcalDate(value);
            if (startDate) {
              currentEvent.dtstart = startDate.date;
              currentEvent.date = startDate.date;
              currentEvent.time = startDate.time;
              currentEvent.startTime = startDate.time;
            }
            break;
          case 'DTEND':
            const endDate = parseIcalDate(value);
            if (endDate) {
              currentEvent.endTime = endDate.time;
            }
            break;
          case 'RRULE':
          currentEvent.rrule = value;
          addDebugLog(`RRULE ë°œê²¬: ${value}`);
          if (value.includes('BYDAY')) {
            const byday = value.match(/BYDAY=([^;]+)/);
            addDebugLog(`  BYDAY: ${byday ? byday[1] : 'none'}`);
          }
          if (value.includes('UNTIL')) {
            const until = value.match(/UNTIL=([^;]+)/);
            addDebugLog(`  UNTIL: ${until ? until[1] : 'none'}`);
          }
            break;
          case 'EXDATE':
            if (!currentEvent.exdate) currentEvent.exdate = [];
            const parsed = parseIcalDate(value);
            if (parsed && parsed.date) {
              currentEvent.exdate.push(parsed.date);
            }
            break;
          case 'RECURRENCE-ID':
            const recDate = parseIcalDate(value);
            if (recDate) {
              currentEvent.recurrenceId = recDate.date;
              currentEvent.isException = true;
              addDebugLog(`RECURRENCE-ID íŒŒì‹±: ${currentEvent.recurrenceId}`);
            }
            break;
          case 'LOCATION':
            currentEvent.location = decodeIcalText(value);
            break;
          case 'X-GOOGLE-TRAVEL-TIME':
            // Google Calendar travel time in seconds
            currentEvent.travelTime = parseInt(value);
            addDebugLog(`ì´ë™ì‹œê°„ íŒŒì‹±: ${parseInt(value)}ì´ˆ`);
            break;
          case 'X-GOOGLE-TRAVEL-DURATION':
            // Alternative property name
            currentEvent.travelTime = parseInt(value);
            addDebugLog(`ì´ë™ì‹œê°„ íŒŒì‹± (ëŒ€ì²´): ${parseInt(value)}ì´ˆ`);
            break;
        }
      }
    }
  }
  
  // ë°˜ë³µ ì¼ì • í™•ì¥ - ë„“ì€ ë²”ìœ„ ì‚¬ìš©
  // parseIcalDataì˜ ë·° ë²”ìœ„ ì„¤ì • ë¶€ë¶„
  const now = new Date();
  const viewStart = new Date(now.getFullYear() - 3, 0, 1);
  const viewEnd = new Date(now.getFullYear() + 3, 11, 31);

  // toLocaleDateString ëŒ€ì‹  toISOString ì‚¬ìš©
  addDebugLog(`ë·° ë²”ìœ„: ${viewStart.toISOString().split('T')[0]} ~ ${viewEnd.toISOString().split('T')[0]}`);
  
  recurringEvents.forEach(event => {
    const expandedEvents = expandRecurringEventWithExceptions(
      event, 
      viewStart, 
      viewEnd, 
      exceptionEvents
    );
    events.push(...expandedEvents);
  });
  
  addDebugLog(`iCal íŒŒì‹± ì™„ë£Œ: ${events.length}ê°œ ì´ë²¤íŠ¸ ì¶”ì¶œ`);
  return events;
}


//ë°˜ë³µì¼ì •í™•ì¥í•¨ìˆ˜
function expandRecurringEventWithExceptions(event, viewStart, viewEnd, exceptionalEvents) {
    addDebugLog(`ë°˜ë³µ ì¼ì • í™•ì¥: ${event.title}, UID: ${event.uid}`);
    
    if (!event.uid) {
        event.uid = event.id;
    }
    
    const occurrences = [];
    let eventStart;
    if (event.isAllDay) {
        // ì¢…ì¼ ì´ë²¤íŠ¸ëŠ” ë¡œì»¬ ë‚ ì§œë¡œ ì •í™•íˆ ìƒì„±
        const [year, month, day] = event.date.split('-').map(n => parseInt(n));
        eventStart = new Date(year, month - 1, day, 0, 0, 0);
    } else {
        // ì‹œê°„ì´ ìˆëŠ” ì´ë²¤íŠ¸ëŠ” ê¸°ì¡´ ë°©ì‹
        eventStart = new Date(event.start || event.date + 'T00:00:00');
    }
    
    const eventEnd = new Date(event.end || event.date + 'T23:59:59');
    const eventDuration = eventEnd - eventStart;
    
    // RRULE íŒŒì‹±
    const rrule = event.rrule.replace('RRULE:', '').trim();
    const rules = {};
    rrule.split(';').forEach(part => {
        const [key, value] = part.split('=');
        if (key && value) {
            rules[key.trim()] = value.trim();
        }
    });
    
    // EXDATE ì²˜ë¦¬
    const excludedDates = new Set();
    if (event.exdate && Array.isArray(event.exdate)) {
        event.exdate.forEach(exdate => excludedDates.add(exdate));
    }
    
    // ì¢…ë£Œ ì¡°ê±´ íŒŒì‹±
    let untilDate = null;
    if (rules.UNTIL) {
        const parsed = parseIcalDate(rules.UNTIL);
        if (parsed) {
            untilDate = new Date(parsed.date + 'T23:59:59');
            addDebugLog(`UNTIL ë‚ ì§œ: ${untilDate.toISOString()}`);
        }
    }
    
    const maxCount = rules.COUNT ? parseInt(rules.COUNT) : null;
    
    // ì¢…ë£Œ ì¡°ê±´ì´ ì—†ìœ¼ë©´ ë·° ë²”ìœ„ë¡œ ì œí•œ
    const effectiveEndDate = untilDate ? 
        (untilDate < viewEnd ? untilDate : viewEnd) : 
        viewEnd;
    
    let current = new Date(eventStart.getTime());
    let totalGenerated = 0; // ì „ì²´ ìƒì„±ëœ ê°œìˆ˜ (ë·° ë°– í¬í•¨)
    let viewCount = 0; // ë·° ì•ˆì— í‘œì‹œë  ê°œìˆ˜
    
    // ë·° ì‹œì‘ ì „ê¹Œì§€ ë¹ ë¥´ê²Œ ì´ë™
    while (current < viewStart && totalGenerated < 1000) {
        totalGenerated++;
        
        // COUNT ì²´í¬
        if (maxCount && totalGenerated >= maxCount) break;
        
        // ë‹¤ìŒ ë°˜ë³µìœ¼ë¡œ ì´ë™
        switch (rules.FREQ) {
            case 'DAILY':
                current.setDate(current.getDate() + (parseInt(rules.INTERVAL) || 1));
                break;
            case 'WEEKLY':
                current.setDate(current.getDate() + (7 * (parseInt(rules.INTERVAL) || 1)));
                break;
            case 'MONTHLY':
                current.setMonth(current.getMonth() + (parseInt(rules.INTERVAL) || 1));
                break;
            case 'YEARLY':
                current.setFullYear(current.getFullYear() + (parseInt(rules.INTERVAL) || 1));
                break;
            default:
                return occurrences;
        }
    }
    
    // ë·° ë²”ìœ„ ë‚´ ì´ë²¤íŠ¸ ìƒì„±
    while (current <= effectiveEndDate && viewCount < 100) {
        if (current >= viewStart) {
            const eventDateStr = current.toISOString().split('T')[0];
            const exceptionKey = `${event.uid}_${eventDateStr}`;
            
            if (!excludedDates.has(eventDateStr)) {
                // ì˜ˆì™¸ ì´ë²¤íŠ¸ í™•ì¸
                if (exceptionalEvents && exceptionalEvents.has(exceptionKey)) {
                    const modifiedEvent = exceptionalEvents.get(exceptionKey);
                    occurrences.push({
                        ...modifiedEvent,
                        isModified: true,
                        originalUid: event.uid
                    });
                    if (viewCount < 3) addDebugLog(`ìˆ˜ì •ëœ ì¸ìŠ¤í„´ìŠ¤: ${eventDateStr}`);
                } else {
                    occurrences.push({
                        ...event,
                        id: `${event.uid}_${current.getTime()}`,
                        date: eventDateStr,
                        isRecurring: true,
                        originalUid: event.uid
                    });
                }
                viewCount++;
            }
        }
        
        totalGenerated++;
        
        // COUNT ì²´í¬
        if (maxCount && totalGenerated >= maxCount) {
            addDebugLog(`COUNT ì œí•œ ë„ë‹¬: ${maxCount}`);
            break;
        }
        
        // ë‹¤ìŒ ë°˜ë³µ
        // ë‹¤ìŒ ë°˜ë³µ
        switch (rules.FREQ) {
            case 'DAILY':
                current.setDate(current.getDate() + (parseInt(rules.INTERVAL) || 1));
                break;
            case 'WEEKLY':
                if (rules.BYDAY) {
                    // BYDAYê°€ ìˆìœ¼ë©´ ë‹¤ìŒ ì§€ì • ìš”ì¼ë¡œ ì´ë™
                    const dayMap = {'SU': 0, 'MO': 1, 'TU': 2, 'WE': 3, 'TH': 4, 'FR': 5, 'SA': 6};
                    const targetDays = rules.BYDAY.split(',').map(day => dayMap[day.trim()]);
                    
                    // ë‹¤ìŒ íƒ€ê²Ÿ ìš”ì¼ ì°¾ê¸°
                    let daysToAdd = 1;
                    let found = false;
                    for (let i = 1; i <= 7; i++) {
                        const nextDate = new Date(current);
                        nextDate.setDate(current.getDate() + i);
                        if (targetDays.includes(nextDate.getDay())) {
                            daysToAdd = i;
                            found = true;
                            break;
                        }
                    }
                    
                    // ë‹¤ìŒ ì£¼ê¸°ë¡œ ì´ë™
                    if (!found) {
                        daysToAdd = 7 * (parseInt(rules.INTERVAL) || 1);
                    }
                    current.setDate(current.getDate() + daysToAdd);
                } else {
                    // BYDAYê°€ ì—†ìœ¼ë©´ ë§¤ì£¼ ê°™ì€ ìš”ì¼
                    current.setDate(current.getDate() + (7 * (parseInt(rules.INTERVAL) || 1)));
                }
                break;
            case 'MONTHLY':
                current.setMonth(current.getMonth() + (parseInt(rules.INTERVAL) || 1));
                break;
            case 'YEARLY':
                current.setFullYear(current.getFullYear() + (parseInt(rules.INTERVAL) || 1));
                break;
        }
    }
    
    addDebugLog(`ë°˜ë³µ ì¼ì • ì™„ë£Œ: ${occurrences.length}ê°œ (ì´ ${totalGenerated}ê°œ ì¤‘)`);
    return occurrences;
}


// iCal í…ìŠ¤íŠ¸ ë””ì½”ë”©
function decodeIcalText(text) {
  return text
    .replace(/\\n/g, ' ')
    .replace(/\\,/g, ',')
    .replace(/\\;/g, ';')
    .replace(/\\\\/g, '\\')
    .trim();
}

// iCal ë‚ ì§œ íŒŒì‹± í•¨ìˆ˜
function parseIcalDate(dateString) {
  try {
    // YYYYMMDD í˜•ì‹ (ì¢…ì¼ ì´ë²¤íŠ¸)
    if (/^\d{8}$/.test(dateString)) {
      const year = parseInt(dateString.substring(0, 4));
      const month = parseInt(dateString.substring(4, 6));
      const day = parseInt(dateString.substring(6, 8));
      
      // ì •ì˜¤ë¡œ ì„¤ì •í•˜ì—¬ ì‹œê°„ëŒ€ ë³€í™˜ ë¬¸ì œ ë°©ì§€
      const date = new Date(year, month - 1, day, 12, 0, 0);
      
      // ë¡œì»¬ ë‚ ì§œ ë¬¸ìì—´ ìƒì„±
      const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      
      return {
        date: dateStr,
        time: 'ì¢…ì¼',
        isAllDay: true
      };
    }
    
    // YYYYMMDDTHHMMSS[Z] í˜•ì‹ (ì‹œê°„ í¬í•¨)
    if (/^\d{8}T\d{6}Z?$/.test(dateString)) {
      const year = parseInt(dateString.substring(0, 4));
      const month = parseInt(dateString.substring(4, 6));
      const day = parseInt(dateString.substring(6, 8));
      const hour = parseInt(dateString.substring(9, 11));
      const minute = parseInt(dateString.substring(11, 13));
      
      let date;
      if (dateString.endsWith('Z')) {
        date = new Date(Date.UTC(year, month - 1, day, hour, minute));
      } else {
        date = new Date(year, month - 1, day, hour, minute);
      }
      
      const localHour = date.getHours();
      let eventDate = date.toLocaleDateString('en-CA');
      
      // 0-6ì‹œ ì´ë²¤íŠ¸ë¥¼ ì „ë‚ ë¡œ ì²˜ë¦¬
      if (localHour >= 0 && localHour < 6) {
        const prevDay = new Date(date);
        prevDay.setDate(prevDay.getDate() - 1);
        eventDate = prevDay.toLocaleDateString('en-CA');
      }
      
      return {
        date: eventDate,
        time: date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }),
        isAllDay: false
      };
    }
  } catch (e) {
    addDebugLog(`ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜: ${dateString} - ${e.message}`);
  }
  return null;
}

// ìº˜ë¦°ë” ìƒ‰ìƒ ì—…ë°ì´íŠ¸
function updateCalendarColor(calendarId, newColor) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar) {
    calendar.color = newColor;
    renderCalendar();
    saveToStorage();
    addDebugLog(`ìº˜ë¦°ë” ìƒ‰ìƒ ë³€ê²½: ${calendar.name} â†’ ${newColor}`);
  }
}

// ìº˜ë¦°ë” ì´ë¦„ ì—…ë°ì´íŠ¸
function updateCalendarName(calendarId, newName) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar && newName.trim()) {
    calendar.name = newName.trim();
    saveToStorage();
    addDebugLog(`ìº˜ë¦°ë” ì´ë¦„ ë³€ê²½: ${newName}`);
  }
}

function updateCalendarStatus(calendarId, status, message = '') {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar) {
    calendar.status = status;
    calendar.statusMessage = message;
    updateCalendarList();
  }
}

// ìº˜ë¦°ë” ëª©ë¡ ì—…ë°ì´íŠ¸
function updateCalendarList() {
  if (calendars.length === 0) {
    calendarList.innerHTML = `
      <p style="color: #666; font-size: 12px; text-align: center; padding: 20px;">
        ì—°ë™ëœ ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ìƒ˜í”Œ ìº˜ë¦°ë”ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì•„ë˜ì—ì„œ ìº˜ë¦°ë”ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!
      </p>
    `;
    return;
  }
  
  calendarList.innerHTML = calendars.map(calendar => `
    <div class="calendar-item ${calendar.visible ? 'active' : ''}" data-id="${escapeHtml(calendar.id)}">
      <input type="color" value="${calendar.color}"
             onchange="updateCalendarColor('${calendar.id}', this.value)"
             class="calendar-color-picker"
             title="ìº˜ë¦°ë” ìƒ‰ìƒ ë³€ê²½">
      <div class="calendar-info">
        <input class="calendar-name" value="${escapeHtml(calendar.name)}"
               onchange="updateCalendarName('${calendar.id}', this.value)"
               onblur="updateCalendarName('${calendar.id}', this.value)">
        <div class="calendar-url">${escapeHtml(calendar.type === 'sample' ? 'ìƒ˜í”Œ ë°ì´í„°' :
          (calendar.url || calendar.calendarId || '').substring(0, 30))}${(calendar.url || calendar.calendarId || '').length > 30 ? '...' : ''}</div>
        <div class="calendar-status ${calendar.status}">${escapeHtml(calendar.statusMessage || calendar.status)}</div>
      </div>
      <div class="calendar-actions">
        <button class="toggle-btn ${calendar.visible ? 'visible' : 'hidden'}"
                onclick="toggleCalendarVisibility('${calendar.id}')"
                title="${calendar.visible ? 'ìˆ¨ê¸°ê¸°' : 'ë³´ì´ê¸°'}">
          ${calendar.visible ? 'ğŸ‘ï¸' : 'ğŸš«'}
        </button>
        <button class="toggle-btn reload-btn" onclick="reloadCalendar('${calendar.id}')" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
        <button class="toggle-btn remove-btn" onclick="removeCalendar('${calendar.id}')" title="ì‚­ì œ">âŒ</button>
      </div>
    </div>
  `).join('');
  
  // ë·°ë³„ ìº˜ë¦°ë” ì„¤ì •ë„ ì—…ë°ì´íŠ¸
  updateViewCalendarSettings();
}

// ë·°ë³„ ìº˜ë¦°ë” ì„¤ì • ì—…ë°ì´íŠ¸
function updateViewCalendarSettings() {
  const container = document.getElementById('viewCalendarSettings');
  if (!container) return;
  
  if (calendars.length === 0) {
    container.innerHTML = '<p style="color: #666; font-size: 12px; text-align: center; padding: 10px;">ì—°ë™ëœ ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  
  const views = [
    { key: 'day', name: 'ì¼ê°„ë·°' },
    { key: 'week', name: 'ì£¼ê°„ë·°' },
    { key: 'month', name: 'ì›”ê°„ë·°' }
  ];
  
  container.innerHTML = views.map(view => `
    <div class="view-calendar-section">
      <div style="font-weight: bold; margin-bottom: 8px; color: #333;">${escapeHtml(view.name)}</div>
      <div class="view-calendar-list">
        ${calendars.map(calendar => `
          <label class="view-calendar-item">
            <input type="checkbox"
                   ${viewCalendarSettings[view.key].includes(calendar.id) ? 'checked' : ''}
                   onchange="toggleViewCalendar('${view.key}', '${calendar.id}')"
                   style="margin-right: 8px;">
            <span class="calendar-color-dot" style="background-color: ${calendar.color}; width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 6px;"></span>
            <span>${escapeHtml(calendar.name)}</span>
          </label>
        `).join('')}
      </div>
      <div style="margin-top: 8px;">
        <button class="btn btn-secondary" onclick="selectAllViewCalendars('${view.key}')" style="font-size: 11px; padding: 4px 8px;">ì „ì²´ ì„ íƒ</button>
        <button class="btn btn-secondary" onclick="deselectAllViewCalendars('${view.key}')" style="font-size: 11px; padding: 4px 8px; margin-left: 4px;">ì „ì²´ í•´ì œ</button>
      </div>
    </div>
  `).join('');
}

// ë·°ë³„ ìº˜ë¦°ë” í† ê¸€
function toggleViewCalendar(viewType, calendarId) {
  const index = viewCalendarSettings[viewType].indexOf(calendarId);
  if (index > -1) {
    viewCalendarSettings[viewType].splice(index, 1);
  } else {
    viewCalendarSettings[viewType].push(calendarId);
  }
  saveToStorage();
  renderCalendar();
  addDebugLog(`${viewType}ë·° ìº˜ë¦°ë” ì„¤ì • ë³€ê²½: ${calendarId}`);
}

// ì „ì²´ ì„ íƒ/í•´ì œ
function selectAllViewCalendars(viewType) {
  viewCalendarSettings[viewType] = calendars.map(cal => cal.id);
  updateViewCalendarSettings();
  saveToStorage();
  renderCalendar();
  addDebugLog(`${viewType}ë·° ëª¨ë“  ìº˜ë¦°ë” ì„ íƒ`);
}

function deselectAllViewCalendars(viewType) {
  viewCalendarSettings[viewType] = [];
  updateViewCalendarSettings();
  saveToStorage();
  renderCalendar();
  addDebugLog(`${viewType}ë·° ëª¨ë“  ìº˜ë¦°ë” í•´ì œ`);
}

// ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
async function reloadCalendar(calendarId) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (!calendar) return;
  
  if (calendar.type === 'sample') {
    // ìƒ˜í”Œ ìº˜ë¦°ë”ëŠ” ìƒˆ ë°ì´í„° ìƒì„±
    calendar.events = generateSampleEvents();
    updateCalendarStatus(calendarId, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
    renderCalendar();
    saveToStorage();
    addDebugLog(`ìƒ˜í”Œ ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ: ${calendar.name}`);
    return;
  }
  
  updateCalendarStatus(calendarId, 'loading', 'ìƒˆë¡œê³ ì¹¨ ì¤‘...');
  addDebugLog(`ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨: ${calendar.name}`);
  
  try {
    calendar.events = [];
    await loadCalendarEvents(calendar);
    updateCalendarStatus(calendarId, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
    renderCalendar();
    saveToStorage();
    addDebugLog(`ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ: ${calendar.name}`);
  } catch (error) {
    updateCalendarStatus(calendarId, 'error', error.message);
    addDebugLog(`ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${calendar.name} - ${error.message}`);
  }
}

// ìº˜ë¦°ë” ê°€ì‹œì„± í† ê¸€
function toggleCalendarVisibility(calendarId) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar) {
    calendar.visible = !calendar.visible;
    updateCalendarList();
    renderCalendar();
    saveToStorage();
    addDebugLog(`ìº˜ë¦°ë” ê°€ì‹œì„± ë³€ê²½: ${calendar.name} - ${calendar.visible ? 'ë³´ì„' : 'ìˆ¨ê¹€'}`);
  }
}

// í†µí•© í† ê¸€ í•¨ìˆ˜
function toggleSection(contentId, iconId) {
  const content = document.getElementById(contentId);
  const icon = document.getElementById(iconId);
  
  content.classList.toggle('expanded');
  icon.classList.toggle('expanded');
}

// ìº˜ë¦°ë” ì‚­ì œ
function removeCalendar(calendarId) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar) {
    calendars = calendars.filter(c => c.id !== calendarId);
    updateCalendarList();
    renderCalendar();
    saveToStorage();
    addDebugLog(`ìº˜ë¦°ë” ì‚­ì œë¨: ${calendar.name}`);
  }
}

// ìº˜ë¦°ë” ë Œë”ë§
function renderCalendar() {
  if (currentView === 'month') {
    renderMonthView();
  } else if (currentView === 'week') {
    renderWeekView();
  } else if (currentView === 'day') {
    renderDayView();
  }
}

// renderCalendar í•¨ìˆ˜ì—ì„œ ì¤‘ë³µ ì œê±°
function removeDuplicateEvents(events) {
    const seen = new Set();
    return events.filter(event => {
        const key = `${event.title}_${event.date}_${event.startTime}`;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
    });
}

// ì›”ê°„ ë·°
function renderMonthView() {
  const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
  const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
  const startDate = new Date(firstDay);
  const sundayOffset = firstDay.getDay(); // ì¼ìš”ì¼ ê¸°ì¤€
  startDate.setDate(startDate.getDate() - sundayOffset);

  const grid = document.createElement('div');
  grid.className = 'calendar-grid month-view';

  // ìš”ì¼ í—¤ë” (ì¼ìš”ì¼ë¶€í„° ì‹œì‘)
  const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
  weekdays.forEach(day => {
    const header = document.createElement('div');
    header.className = 'week-header';
    header.textContent = day;
    grid.appendChild(header);
  });
  
  // ë‚ ì§œ ì…€
  const today = new Date();
  for (let i = 0; i < 42; i++) {
    const cellDate = new Date(startDate);
    cellDate.setDate(startDate.getDate() + i);
    
    const cell = document.createElement('div');
    cell.className = 'calendar-day';
    
    if (cellDate.getMonth() !== currentDate.getMonth()) {
      cell.classList.add('other-month');
    }
    
    if (cellDate.toDateString() === today.toDateString()) {
      cell.classList.add('today');
    }
    
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = cellDate.getDate();
    cell.appendChild(dayNumber);
    
    // ëª¨ë“  ì´ë²¤íŠ¸ í‘œì‹œ (ì‹œê°„ìˆœ ì •ë ¬)
    const dayEvents = getAllEventsForDate(cellDate);

    // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ì¢…ì¼ ì´ë²¤íŠ¸ê°€ ë¨¼ì €, ê·¸ ë‹¤ìŒ ì‹œê°„ìˆœ)
    dayEvents.sort((a, b) => {
      if (a.time === 'ì¢…ì¼' && b.time !== 'ì¢…ì¼') return -1;
      if (a.time !== 'ì¢…ì¼' && b.time === 'ì¢…ì¼') return 1;
      if (a.time === 'ì¢…ì¼' && b.time === 'ì¢…ì¼') return 0;

      const timeA = a.startTime || a.time || '00:00';
      const timeB = b.startTime || b.time || '00:00';
      return timeA.localeCompare(timeB);
    });

    dayEvents.forEach(event => {
      const eventDiv = document.createElement('div');
      eventDiv.className = 'event';
      eventDiv.style.backgroundColor = event.color;
      eventDiv.style.color = eventTextColor;
      eventDiv.style.fontSize = eventFontSize;
      eventDiv.textContent = event.title;
      eventDiv.title = `${event.title}\nì‹œê°„: ${formatEventTimeInfo(event)}\nìº˜ë¦°ë”: ${event.calendarName}${event.location ? '\nìœ„ì¹˜: ' + event.location : ''}${event.description && event.description !== 'This is an event reminder' ? '\nì„¤ëª…: ' + event.description : ''}`;
      cell.appendChild(eventDiv);
    });
    
    grid.appendChild(cell);
  }
  
  calendarContent.innerHTML = '';
  calendarContent.appendChild(grid);
}



// ê³µí†µ ìƒìˆ˜ (24ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½)
const SLOT_START_HOUR = 6;  // ì˜¤ì „ 6ì‹œ ì‹œì‘
const TOTAL_HOURS = 24;     // 24ì‹œê°„ í‘œì‹œ
const SLOT_COUNT = TOTAL_HOURS;

const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

// ì‹œê°„ í‘œì‹œ í—¬í¼ í•¨ìˆ˜ (24ì‹œê°„ -> ì‹¤ì œ ì‹œê°„ ë³€í™˜)
function getDisplayHour(slotIndex) {
  const hour = (SLOT_START_HOUR + slotIndex) % 24;
  return hour;
}

// ì‹¤ì œ ì‹œê°„ -> ìŠ¬ë¡¯ ì¸ë±ìŠ¤ ë³€í™˜
function getSlotIndex(hour) {
  if (hour >= SLOT_START_HOUR) {
    return hour - SLOT_START_HOUR;  // 6-23ì‹œ: 0-17
  } else {
    return hour + (24 - SLOT_START_HOUR);  // 0-5ì‹œ: 18-23
  }
}

// ì‹œê°„ì„ ì •í™•í•œ ìŠ¬ë¡¯ ìœ„ì¹˜ë¡œ ë³€í™˜ (ë¶„ ë‹¨ìœ„ê¹Œì§€ ê³ ë ¤)
function getExactSlotPosition(hour, minute) {
  const slotIndex = getSlotIndex(hour);
  return slotIndex + (minute / 60);
}

// ê²¹ì¹˜ëŠ” ì´ë²¤íŠ¸ë“¤ì˜ ëª¨ì„œë¦¬ë¥¼ ì ì ˆíˆ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
function applyRoundedCorners(eventsInSlot) {
  if (eventsInSlot.length === 0) return;

  eventsInSlot.forEach((eventDiv, index) => {
    const isFirst = index === 0;
    const isLast = index === eventsInSlot.length - 1;
    
    // ëª¨ë“  ì´ë²¤íŠ¸ì— ê¸°ë³¸ ë‘¥ê·¼ ëª¨ì„œë¦¬ ì ìš©
    if (eventsInSlot.length === 1) {
      eventDiv.style.borderRadius = '6px';
    } else {
      // ê²¹ì¹˜ëŠ” ê²½ìš°ì—ë„ ê° ì´ë²¤íŠ¸ë§ˆë‹¤ ì ë‹¹í•œ ë‘¥ê·¼ ëª¨ì„œë¦¬ ì ìš©
      if (isFirst) {
        borderRadius = '6px 6px 6px 6px';  // ì™„ì „íˆ ë‘¥ê¸€ê²Œ
      } else if (isLast) {
        borderRadius = '6px 6px 6px 6px';  // ì™„ì „íˆ ë‘¥ê¸€ê²Œ
      } else {
        borderRadius = '6px';  // ì¤‘ê°„ ë‘¥ê¸€ê²Œ
      }
      eventDiv.style.borderRadius = borderRadius;
    }
    
    // ì¶”ê°€: ê·¸ë¦¼ì íš¨ê³¼ë¡œ ì…ì²´ê° ë¶€ì—¬
    eventDiv.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
  });
}

// ì´ë²¤íŠ¸ê°€ ì´í‹€ì— ê±¸ì¹˜ëŠ”ì§€ í™•ì¸í•˜ê³  ë¶„í• 
function splitCrossDayEvent(event) {
  if (event.time === 'ì¢…ì¼') return [event];

  // ì´ë¯¸ ë¶„í• ëœ ì´ë²¤íŠ¸ëŠ” ë‹¤ì‹œ ë¶„í• í•˜ì§€ ì•ŠìŒ
  if (event.isFirstPart || event.isSecondPart || event.isNextDay) {
    return [event];
  }

  const startHour = getEventHour(event.startTime);
  const endHour = getEventHour(event.endTime);
  const startMinute = getEventMinute(event.startTime);
  const endMinute = getEventMinute(event.endTime);
  
  const startPosition = getExactSlotPosition(startHour, startMinute);
  const endPosition = getExactSlotPosition(endHour, endMinute);
  
  // ì´í‹€ì— ê±¸ì¹˜ì§€ ì•ŠëŠ” ê²½ìš°
  if (startPosition < endPosition) {
    return [event];
  }
  
  // ì´í‹€ì— ê±¸ì¹˜ëŠ” ê²½ìš° - ë¶„í•  (6ì‹œ ê¸°ì¤€)
  const events = [];

  // ì²«ì§¸ ë‚  ë¶€ë¶„ (ì‹œì‘ì‹œê°„ ~ 5:59)
  // ì‹œì‘ ì‹œê°„ì´ 6ì‹œ ì´í›„ë©´ ì²«ì§¸ ë‚ ì— í‘œì‹œ
  events.push({
    ...event,
    endTime: '05:59',
    title: event.title,
    isFirstPart: true
  });

  // ë‘˜ì§¸ ë‚  ë¶€ë¶„ (6:00 ~ ì¢…ë£Œì‹œê°„)
  // ì¢…ë£Œ ì‹œê°„ì´ 6ì‹œ ì´ì „ì´ë©´ ë‘˜ì§¸ ë‚ (ë‹¤ìŒ ë‚ )ì— í‘œì‹œ
  // ë‹¤ìŒ ë‚  ë‚ ì§œ ê³„ì‚°
  const [year, month, day] = event.date.split('-').map(Number);
  const eventDate = new Date(year, month - 1, day);
  eventDate.setDate(eventDate.getDate() + 1);
  const nextYear = eventDate.getFullYear();
  const nextMonth = String(eventDate.getMonth() + 1).padStart(2, '0');
  const nextDay = String(eventDate.getDate()).padStart(2, '0');
  const nextDayDate = `${nextYear}-${nextMonth}-${nextDay}`;

  events.push({
    ...event,
    date: nextDayDate,  // ë‹¤ìŒ ë‚  ë‚ ì§œë¡œ ë³€ê²½
    startTime: '06:00',
    title: event.title,
    isSecondPart: true,
    isNextDay: true
  });

  return events;
}

// ì£¼ê°„ ë·° ë Œë”ë§ (24ì‹œê°„ ë²„ì „)
function renderWeekView() {
  const startOfWeek = new Date(currentDate);
  const hour = new Date().getHours();
  
  // 0-6ì‹œë©´ ì£¼ê°„ ë·° ì‹œì‘ì¼ ì¡°ì •
  if (hour < 6) {
    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay() + 1);
  } else {
    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
  }

  const container = document.createElement('div');
  container.style.padding = '0 0 10px 0';
  container.style.overflow = 'visible';
  container.style.height = '100%';

  const grid = document.createElement('div');
  grid.className = 'time-based-view week-view';
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = `80px repeat(7, 1fr)`;
  grid.style.gap = '0';

  // ì‹œê°„ í—¤ë”
  const timeHeader = document.createElement('div');
  timeHeader.className = 'week-header';
  timeHeader.textContent = 'ì‹œê°„';
  timeHeader.style.gridRow = '1';
  timeHeader.style.gridColumn = '1';
  timeHeader.style.border = '1px solid #e0e0e0';
  timeHeader.style.backgroundColor = '#f5f5f5';
  timeHeader.style.padding = '8px';
  timeHeader.style.textAlign = 'center';
  grid.appendChild(timeHeader);

  // ìš”ì¼ í—¤ë” ì €ì¥ìš© ë°°ì—´
  const dayHeaders = [];

  // ìš”ì¼ í—¤ë”
  for (let i = 0; i < 7; i++) {
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + i);

    const header = document.createElement('div');
    header.className = 'week-header';
    header.style.gridRow = '1';
    header.style.gridColumn = `${i + 2}`;
    header.style.border = '1px solid #e0e0e0';
    header.style.backgroundColor = '#f5f5f5';
    header.style.padding = '8px';
    header.style.textAlign = 'center';
    header.style.position = 'relative'; // ë°°ì§€ ìœ„ì¹˜ ê¸°ì¤€ì 

    if (date.toDateString() === (new Date()).toDateString()) {
      header.style.backgroundColor = accentColor;
    }

    const dayName = document.createElement('div');
    dayName.textContent = weekdays[i];
    dayName.style.fontWeight = 'bold';
    header.appendChild(dayName);

    const dayNumber = document.createElement('div');
    dayNumber.textContent = date.getDate();
    dayNumber.style.fontSize = '0.9em';
    dayNumber.style.color = '#666';
    header.appendChild(dayNumber);

    dayHeaders.push(header);
    grid.appendChild(header);
  }

  // ê° ë‚ ì§œë³„ ì…€ ì €ì¥ìš© ë°°ì—´
  const dayCells = Array.from({length: 7}, () => []);

  // ì¢…ì¼ ì¼ì • í‘œì‹œ ì¤„ ì¶”ê°€
  const allDayTimeSlot = document.createElement('div');
  allDayTimeSlot.className = 'all-day-slot';
  allDayTimeSlot.style.gridRow = '2';
  allDayTimeSlot.style.gridColumn = '1';
  allDayTimeSlot.style.border = '1px solid #e0e0e0';
  allDayTimeSlot.style.backgroundColor = '#fafafa';
  grid.appendChild(allDayTimeSlot);

  // ê° ìš”ì¼ë³„ ì¢…ì¼ ì¼ì • ì…€
  const allDayCells = [];
  for (let day = 0; day < 7; day++) {
    const cell = document.createElement('div');
    cell.className = 'all-day-slot';
    cell.style.gridRow = '2';
    cell.style.gridColumn = `${day + 2}`;
    cell.style.border = '1px solid #e0e0e0';
    cell.style.position = 'relative';
    cell.style.backgroundColor = 'white';
    allDayCells.push(cell);
    grid.appendChild(cell);
  }

  // 24ì‹œê°„ ìŠ¬ë¡¯ ìƒì„±
  for (let slotIndex = 0; slotIndex < SLOT_COUNT; slotIndex++) {
    const displayHour = getDisplayHour(slotIndex);

    // ì‹œê°„ ë¼ë²¨
    const timeSlot = document.createElement('div');
    timeSlot.className = 'time-slot';
    timeSlot.textContent = `${displayHour.toString().padStart(2, '0')}:00`;
    timeSlot.style.gridRow = `${slotIndex + 3}`;
    timeSlot.style.gridColumn = '1';
    timeSlot.style.border = '1px solid #e0e0e0';
    timeSlot.style.padding = '8px';
    timeSlot.style.fontSize = '0.8em';
    timeSlot.style.textAlign = 'center';
    timeSlot.style.backgroundColor = '#fafafa';
    grid.appendChild(timeSlot);

    // ê° ìš”ì¼ë³„ ê¸°ë³¸ ë°°ê²½
    for (let day = 0; day < 7; day++) {
      const cell = document.createElement('div');
      cell.className = 'day-cell';
      cell.dataset.day = day;
      cell.dataset.slot = slotIndex;
      cell.style.gridRow = `${slotIndex + 3}`;
      cell.style.gridColumn = `${day + 2}`;
      cell.style.border = '1px solid #e0e0e0';
      cell.style.position = 'relative';  // ì¤‘ìš”: ìì‹ ìš”ì†Œë“¤ì˜ absolute positioning ê¸°ì¤€ì 
      cell.style.backgroundColor = 'white';

      // ìì • ì´í›„ ì‹œê°„ëŒ€ëŠ” ë‹¤ë¥¸ ìŠ¤íƒ€ì¼
      if (slotIndex >= 18) {
        cell.style.backgroundColor = '#f9f9f9';
      }

      dayCells[day][slotIndex] = cell;
      grid.appendChild(cell);
    }
  }

  // ì´ë²¤íŠ¸ ë Œë”ë§
  for (let day = 0; day < 7; day++) {
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + day);

    const dayEvents = getAllEventsForDate(date);
    const eventCounts = Array(SLOT_COUNT).fill(0); // ê° ìŠ¬ë¡¯ë³„ ì´ë²¤íŠ¸ ê°œìˆ˜
    const slotEventDivs = Array(SLOT_COUNT).fill().map(() => []); // ê° ìŠ¬ë¡¯ë³„ ì´ë²¤íŠ¸ div ì €ì¥
    const allDayEvents = []; // ì¢…ì¼ ì¼ì • ìˆ˜ì§‘

    dayEvents.forEach((event) => {
      const splitEvents = splitCrossDayEvent(event);

      splitEvents.forEach((splitEvent) => {
        // ë¶„í• ëœ ì´ë²¤íŠ¸ì˜ ë‚ ì§œê°€ í˜„ì¬ ë Œë”ë§í•˜ëŠ” ë‚ ì§œì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const dayOfMonth = String(date.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${dayOfMonth}`;
        if (splitEvent.date !== dateString) return; // ë‚ ì§œê°€ ë‹¤ë¥´ë©´ ìŠ¤í‚µ

        if (splitEvent.time === 'ì¢…ì¼') {
          // ì¢…ì¼ ì¼ì • ìˆ˜ì§‘
          allDayEvents.push(event);
        } else {
          const startHour = getEventHour(splitEvent.startTime);
          const endHour = getEventHour(splitEvent.endTime);
          const startMinute = getEventMinute(splitEvent.startTime);
          const endMinute = getEventMinute(splitEvent.endTime);

          let startPosition = getExactSlotPosition(startHour, startMinute);
          const endPosition = getExactSlotPosition(endHour, endMinute);

          // ì´ë™ì‹œê°„ ê³„ì‚° (ì´ˆ â†’ ìŠ¬ë¡¯ ìœ„ì¹˜)
          const travelTimeMinutes = event.travelTime ? event.travelTime / 60 : 0;
          const travelTimeSlots = travelTimeMinutes / 60; // 1ì‹œê°„ = 1ìŠ¬ë¡¯
          const actualStartPosition = startPosition; // ì‹¤ì œ ì¼ì • ì‹œì‘

          // ì´ë™ì‹œê°„ì´ ìˆìœ¼ë©´ ë¸”ë¡ì„ ìœ„ë¡œ í™•ì¥
          if (travelTimeSlots > 0) {
            startPosition = Math.max(0, startPosition - travelTimeSlots);
          }

          // ê·¸ë¦¬ë“œ ë²”ìœ„ ì œí•œ
          const clampedEndPosition = Math.min(endPosition, SLOT_COUNT);
          const startSlot = Math.floor(startPosition);
          
          // í˜„ì¬ ìŠ¬ë¡¯ì˜ ì´ë²¤íŠ¸ ê°œìˆ˜
          const currentEventIndex = eventCounts[startSlot];
          eventCounts[startSlot]++;

          const eventDiv = document.createElement('div');
          eventDiv.className = 'time-event';

          // ì´ë™ì‹œê°„ì´ ìˆìœ¼ë©´ gradient ë°°ê²½ ì ìš©
          if (travelTimeSlots > 0) {
            const totalHeight = clampedEndPosition - startPosition;
            const travelPercentage = (travelTimeSlots / totalHeight) * 100;
            const lighterColor = lightenColor(event.color, 40); // 40% ë°ê²Œ
            eventDiv.style.background = `linear-gradient(to bottom, ${lighterColor} 0%, ${lighterColor} ${travelPercentage}%, ${event.color} ${travelPercentage}%, ${event.color} 100%)`;
          } else {
            eventDiv.style.backgroundColor = event.color;
          }

          eventDiv.style.color = eventTextColor;
          eventDiv.style.fontSize = eventFontSize;
          eventDiv.style.overflow = 'hidden';
          eventDiv.style.textOverflow = 'clip';
          eventDiv.style.whiteSpace = 'normal';
          eventDiv.style.position = 'absolute';
          eventDiv.style.boxSizing = 'border-box';
          eventDiv.style.display = 'flex';
          eventDiv.style.flexDirection = 'column';

          // ì´ë™ì‹œê°„ì´ ìˆìœ¼ë©´ í…ìŠ¤íŠ¸ë¥¼ ì‹¤ì œ ì¼ì • ë¶€ë¶„ì—ë§Œ í‘œì‹œ
          if (travelTimeSlots > 0) {
            const totalHeight = clampedEndPosition - startPosition;
            const travelPercentage = (travelTimeSlots / totalHeight) * 100;
            eventDiv.style.paddingTop = `${travelPercentage}%`;
            eventDiv.style.paddingLeft = '6px';
            eventDiv.style.paddingRight = '6px';
            eventDiv.style.paddingBottom = '2px';
          } else {
            eventDiv.style.padding = '2px 6px';
          }

          eventDiv.style.alignItems = textAlignHorizontal === 'left' ? 'flex-start' : 'center';
          eventDiv.style.justifyContent = textAlignVertical === 'top' ? 'flex-start' : 'center';
                  //ì¶”ê°€
          eventDiv.style.textAlign = 'center';
          eventDiv.style.wordWrap = 'break-word';
          eventDiv.style.wordBreak = 'normal';
          eventDiv.style.lineHeight = '1.2';
          eventDiv.style.minHeight = '20px';     // ìµœì†Œ ë†’ì´ ë³´ì¥
          
          // z-index: ë‚˜ì¤‘ì— ì¶”ê°€ëœ ì´ë²¤íŠ¸(ì•„ë˜ìª½)ê°€ ë” ìœ„ë¡œ ì˜¤ë„ë¡
          eventDiv.style.zIndex = 100 + currentEventIndex;

          // ì •í™•í•œ ìœ„ì¹˜ì™€ ë†’ì´ ê³„ì‚°
          const cellHeight = 24; // ê·¸ë¦¬ë“œ í–‰ ë†’ì´
          const topOffset = (startPosition - startSlot) * cellHeight;
          const height = (clampedEndPosition - startPosition) * cellHeight;
          
          eventDiv.style.top = `${topOffset}px`;
          eventDiv.style.height = `${Math.max(height, 20)}px`; // ìµœì†Œ ë†’ì´ ë³´ì¥
          
          // ê²¹ì¹˜ëŠ” ì´ë²¤íŠ¸ë“¤ì„ ê·¸ë¦¬ë“œì— ë”± ë§ê²Œ ë°°ì¹˜
          const totalEvents = Math.max(eventCounts[startSlot], 1);
          const eventWidth = Math.floor(100 / totalEvents); // ê· ë“±í•˜ê²Œ ë¶„í• 
          const leftPosition = currentEventIndex * eventWidth;
          
          eventDiv.style.left = `${leftPosition}%`;
          eventDiv.style.width = `${eventWidth}%`;

          eventDiv.textContent = splitEvent.title;
          eventDiv.title = `${event.title}\nì‹œê°„: ${formatEventTimeInfo(event)}\nìº˜ë¦°ë”: ${event.calendarName}${event.location ? '\nìœ„ì¹˜: ' + event.location : ''}${event.description && event.description !== 'This is an event reminder' ? '\nì„¤ëª…: ' + event.description : ''}`;
          // ì‹œì‘ ìŠ¬ë¡¯ì˜ ì…€ì— ì¶”ê°€
          if (dayCells[day][startSlot]) {
            dayCells[day][startSlot].appendChild(eventDiv);
            slotEventDivs[startSlot].push(eventDiv);
          }
        }
      });
    });

    // ì¢…ì¼ ì¼ì • í‘œì‹œ
    if (allDayEvents.length > 0) {
      allDayEvents.forEach((event, index) => {
        const bar = document.createElement('div');
        bar.className = 'all-day-event-bar';
        bar.style.backgroundColor = event.color;

        // ì—¬ëŸ¬ ì¢…ì¼ ì¼ì •ì´ ê²¹ì¹˜ë©´ ë„ˆë¹„ë¥¼ ë‚˜ëˆ„ê¸°
        const totalEvents = allDayEvents.length;
        const eventWidth = Math.floor(100 / totalEvents);
        const leftPosition = index * eventWidth;

        bar.style.left = `${leftPosition}%`;
        bar.style.width = `${eventWidth}%`;
        bar.textContent = event.title;
        bar.title = `${event.title}\nì‹œê°„: ì¢…ì¼\nìº˜ë¦°ë”: ${event.calendarName}${event.location ? '\nìœ„ì¹˜: ' + event.location : ''}${event.description && event.description !== 'This is an event reminder' ? '\nì„¤ëª…: ' + event.description : ''}`;

        allDayCells[day].appendChild(bar);
      });
    }

    // ê° ìŠ¬ë¡¯ì˜ ì´ë²¤íŠ¸ë“¤ì— ì ì ˆí•œ ëª¨ì„œë¦¬ ì²˜ë¦¬ ì ìš©
    for (let slot = 0; slot < SLOT_COUNT; slot++) {
      if (slotEventDivs[slot].length > 0) {
        applyRoundedCorners(slotEventDivs[slot]);
      }
    }
  }

  container.appendChild(grid);
  calendarContent.innerHTML = '';
  calendarContent.appendChild(container);
}

// ì¼ê°„ ë·°
function renderDayView() {
  const container = document.createElement('div');
  container.style.padding = '0 0 10px 0';
  container.style.overflow = 'visible';
  container.style.height = '100%';

  const grid = document.createElement('div');
  grid.className = 'time-based-view day-view';
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = `80px 1fr`;
  grid.style.gap = '0';
  grid.style.position = 'relative'; 

  // í—¤ë”ë“¤ (ì´ì „ê³¼ ë™ì¼)
  const timeHeader = document.createElement('div');
  timeHeader.className = 'week-header';
  timeHeader.textContent = 'ì‹œê°„';
  timeHeader.style.gridRow = '1';
  timeHeader.style.gridColumn = '1';
  timeHeader.style.border = '1px solid #e0e0e0';
  timeHeader.style.backgroundColor = '#f5f5f5';
  timeHeader.style.padding = '8px';
  timeHeader.style.textAlign = 'center';
  grid.appendChild(timeHeader);

  const dayHeader = document.createElement('div');
  dayHeader.className = 'week-header';
  
  // 0-6ì‹œ ì¡°ì • ì¶”ê°€
  const displayDate = new Date(currentDate);
  const hour = new Date().getHours();
  const today = new Date();
  
  // 0-6ì‹œì´ê³  ì˜¤ëŠ˜ì„ ë³´ê³  ìˆë‹¤ë©´ ë‚ ì§œ í‘œì‹œ ì¡°ì •
  if (hour < 6 && currentDate.toDateString() === today.toDateString()) {
    displayDate.setDate(displayDate.getDate() + 1);
  }
  
  if (displayDate.toDateString() === today.toDateString()) {
    dayHeader.style.backgroundColor = accentColor;
  } else {
    dayHeader.style.backgroundColor = '#f5f5f5';
  }

  const options = { month: 'short', day: 'numeric', weekday: 'short' };
  const dayName = document.createElement('div');
  dayName.textContent = currentDate.toLocaleDateString('ko-KR', options);
  dayHeader.appendChild(dayName);
  dayHeader.style.gridRow = '1';
  dayHeader.style.gridColumn = '2';
  dayHeader.style.border = '1px solid #e0e0e0';
  dayHeader.style.padding = '8px';
  dayHeader.style.textAlign = 'center';
  dayHeader.style.position = 'relative'; // ë°°ì§€ ìœ„ì¹˜ ê¸°ì¤€ì 
  grid.appendChild(dayHeader);

  // ì¢…ì¼ ì¼ì • í‘œì‹œ ì¤„ ì¶”ê°€
  const allDayTimeSlot = document.createElement('div');
  allDayTimeSlot.className = 'all-day-slot';
  allDayTimeSlot.style.gridRow = '2';
  allDayTimeSlot.style.gridColumn = '1';
  allDayTimeSlot.style.border = '1px solid #e0e0e0';
  allDayTimeSlot.style.backgroundColor = '#fafafa';
  grid.appendChild(allDayTimeSlot);

  const allDayCell = document.createElement('div');
  allDayCell.className = 'all-day-slot';
  allDayCell.style.gridRow = '2';
  allDayCell.style.gridColumn = '2';
  allDayCell.style.border = '1px solid #e0e0e0';
  allDayCell.style.position = 'relative';
  allDayCell.style.backgroundColor = 'white';
  grid.appendChild(allDayCell);

  // ì…€ ì €ì¥ìš© ë°°ì—´
  const dayCells = [];

  // 24ì‹œê°„ ìŠ¬ë¡¯
  for (let slotIndex = 0; slotIndex < SLOT_COUNT; slotIndex++) {
    const displayHour = getDisplayHour(slotIndex);

    const timeSlot = document.createElement('div');
    timeSlot.className = 'time-slot';
    timeSlot.textContent = `${displayHour.toString().padStart(2, '0')}:00`;
    timeSlot.style.gridRow = `${slotIndex + 3}`;
    timeSlot.style.gridColumn = '1';
    timeSlot.style.border = '1px solid #e0e0e0';
    timeSlot.style.padding = '8px';
    timeSlot.style.fontSize = '0.8em';
    timeSlot.style.textAlign = 'center';
    timeSlot.style.backgroundColor = '#fafafa';
    grid.appendChild(timeSlot);

    const cell = document.createElement('div');
    cell.className = 'day-cell';
    cell.dataset.slot = slotIndex;
    cell.style.gridRow = `${slotIndex + 3}`;
    cell.style.gridColumn = '2';
    cell.style.border = '1px solid #e0e0e0';
    cell.style.position = 'relative';
    cell.style.backgroundColor = 'white';
    
    if (slotIndex >= 18) {
      cell.style.backgroundColor = '#f9f9f9';
    }
    
    dayCells[slotIndex] = cell;
    grid.appendChild(cell);
  }

  // ì´ë²¤íŠ¸ ì²˜ë¦¬ (ì£¼ê°„ë·°ì™€ ë™ì¼í•œ ë¡œì§)
  const dayEvents = getAllEventsForDate(currentDate);
  const eventCounts = Array(SLOT_COUNT).fill(0);
  const slotEventDivs = Array(SLOT_COUNT).fill().map(() => []);
  const allDayEvents = []; // ì¢…ì¼ ì¼ì • ìˆ˜ì§‘

  dayEvents.forEach((event) => {
    const splitEvents = splitCrossDayEvent(event);

    splitEvents.forEach((splitEvent) => {
      // ë¶„í• ëœ ì´ë²¤íŠ¸ì˜ ë‚ ì§œê°€ í˜„ì¬ ë Œë”ë§í•˜ëŠ” ë‚ ì§œì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
      const year = currentDate.getFullYear();
      const month = String(currentDate.getMonth() + 1).padStart(2, '0');
      const dayOfMonth = String(currentDate.getDate()).padStart(2, '0');
      const dateString = `${year}-${month}-${dayOfMonth}`;
      if (splitEvent.date !== dateString) return; // ë‚ ì§œê°€ ë‹¤ë¥´ë©´ ìŠ¤í‚µ

      if (splitEvent.time === 'ì¢…ì¼') {
        // ì¢…ì¼ ì¼ì • ìˆ˜ì§‘
        allDayEvents.push(event);
      } else {
        const startHour = getEventHour(splitEvent.startTime);
        const endHour = getEventHour(splitEvent.endTime);
        const startMinute = getEventMinute(splitEvent.startTime);
        const endMinute = getEventMinute(splitEvent.endTime);

        let startPosition = getExactSlotPosition(startHour, startMinute);
        const endPosition = getExactSlotPosition(endHour, endMinute);

        // ì´ë™ì‹œê°„ ê³„ì‚° (ì´ˆ â†’ ìŠ¬ë¡¯ ìœ„ì¹˜)
        const travelTimeMinutes = event.travelTime ? event.travelTime / 60 : 0;
        const travelTimeSlots = travelTimeMinutes / 60; // 1ì‹œê°„ = 1ìŠ¬ë¡¯
        const actualStartPosition = startPosition; // ì‹¤ì œ ì¼ì • ì‹œì‘

        // ì´ë™ì‹œê°„ì´ ìˆìœ¼ë©´ ë¸”ë¡ì„ ìœ„ë¡œ í™•ì¥
        if (travelTimeSlots > 0) {
          startPosition = Math.max(0, startPosition - travelTimeSlots);
        }

        const clampedEndPosition = Math.min(endPosition, SLOT_COUNT);
        const startSlot = Math.floor(startPosition);

        const currentEventIndex = eventCounts[startSlot];
        eventCounts[startSlot]++;

        const eventDiv = document.createElement('div');
        eventDiv.className = 'time-event';

        // ì´ë™ì‹œê°„ì´ ìˆìœ¼ë©´ gradient ë°°ê²½ ì ìš©
        if (travelTimeSlots > 0) {
          const totalHeight = clampedEndPosition - startPosition;
          const travelPercentage = (travelTimeSlots / totalHeight) * 100;
          const lighterColor = lightenColor(event.color, 40); // 40% ë°ê²Œ
          eventDiv.style.background = `linear-gradient(to bottom, ${lighterColor} 0%, ${lighterColor} ${travelPercentage}%, ${event.color} ${travelPercentage}%, ${event.color} 100%)`;
        } else {
          eventDiv.style.backgroundColor = event.color;
        }

        eventDiv.style.color = eventTextColor;
        eventDiv.style.fontSize = eventFontSize;
        eventDiv.style.overflow = 'hidden';
        eventDiv.style.textOverflow = 'clip';
        eventDiv.style.whiteSpace = 'normal';
        eventDiv.style.position = 'absolute';
        eventDiv.style.boxSizing = 'border-box';
        eventDiv.style.display = 'flex';
        eventDiv.style.flexDirection = 'column';

        // ì´ë™ì‹œê°„ì´ ìˆìœ¼ë©´ í…ìŠ¤íŠ¸ë¥¼ ì‹¤ì œ ì¼ì • ë¶€ë¶„ì—ë§Œ í‘œì‹œ
        if (travelTimeSlots > 0) {
          const totalHeight = clampedEndPosition - startPosition;
          const travelPercentage = (travelTimeSlots / totalHeight) * 100;
          eventDiv.style.paddingTop = `${travelPercentage}%`;
          eventDiv.style.paddingLeft = '6px';
          eventDiv.style.paddingRight = '6px';
          eventDiv.style.paddingBottom = '2px';
        } else {
          eventDiv.style.padding = '2px 6px';
        }

        eventDiv.style.alignItems = textAlignHorizontal === 'left' ? 'flex-start' : 'center';
        eventDiv.style.justifyContent = textAlignVertical === 'top' ? 'flex-start' : 'center';
        eventDiv.style.zIndex = 100 + currentEventIndex;
        //ì¶”ê°€
        eventDiv.style.textAlign = 'center';
        eventDiv.style.wordWrap = 'break-word';
        eventDiv.style.wordBreak = 'normal';
        eventDiv.style.lineHeight = '1.2';
        eventDiv.style.minHeight = '20px';     // ìµœì†Œ ë†’ì´ ë³´ì¥

        const cellHeight = 24; // ê·¸ë¦¬ë“œ í–‰ ë†’ì´
        const topOffset = (startPosition - startSlot) * cellHeight;
        const height = (clampedEndPosition - startPosition) * cellHeight;
        
        eventDiv.style.top = `${topOffset}px`;
        eventDiv.style.height = `${Math.max(height, 20)}px`;
        
        const totalEvents = Math.max(eventCounts[startSlot], 1);
        const eventWidth = Math.floor(100 / totalEvents);
        const leftPosition = currentEventIndex * eventWidth;
        
        eventDiv.style.left = `${leftPosition}%`;
        eventDiv.style.width = `${eventWidth}%`;

        eventDiv.textContent = splitEvent.title;
        eventDiv.title = `${event.title}\nì‹œê°„: ${formatEventTimeInfo(event)}\nìº˜ë¦°ë”: ${event.calendarName}${event.location ? '\nìœ„ì¹˜: ' + event.location : ''}${event.description && event.description !== 'This is an event reminder' ? '\nì„¤ëª…: ' + event.description : ''}`;
        if (dayCells[startSlot]) {
          dayCells[startSlot].appendChild(eventDiv);
          slotEventDivs[startSlot].push(eventDiv);
        }
      }
    });
  });

  // ì¢…ì¼ ì¼ì • í‘œì‹œ
  if (allDayEvents.length > 0) {
    allDayEvents.forEach((event, index) => {
      const bar = document.createElement('div');
      bar.className = 'all-day-event-bar';
      bar.style.backgroundColor = event.color;

      // ì—¬ëŸ¬ ì¢…ì¼ ì¼ì •ì´ ê²¹ì¹˜ë©´ ë„ˆë¹„ë¥¼ ë‚˜ëˆ„ê¸°
      const totalEvents = allDayEvents.length;
      const eventWidth = Math.floor(100 / totalEvents);
      const leftPosition = index * eventWidth;

      bar.style.left = `${leftPosition}%`;
      bar.style.width = `${eventWidth}%`;
      bar.textContent = event.title;
      bar.title = `${event.title}\nì‹œê°„: ì¢…ì¼\nìº˜ë¦°ë”: ${event.calendarName}${event.location ? '\nìœ„ì¹˜: ' + event.location : ''}${event.description && event.description !== 'This is an event reminder' ? '\nì„¤ëª…: ' + event.description : ''}`;

      allDayCell.appendChild(bar);
    });
  }

  // ê° ìŠ¬ë¡¯ì˜ ì´ë²¤íŠ¸ë“¤ì— ì ì ˆí•œ ëª¨ì„œë¦¬ ì²˜ë¦¬ ì ìš©
  for (let slot = 0; slot < SLOT_COUNT; slot++) {
    if (slotEventDivs[slot].length > 0) {
      applyRoundedCorners(slotEventDivs[slot]);
    }
  }

  // í˜„ì¬ ì‹œê°„ ì„  ì¶”ê°€ (ì˜¤ëŠ˜ ë‚ ì§œì¼ ë•Œë§Œ, 6ì‹œ ê¸°ì¤€ ê³ ë ¤)
  const now = new Date();
  const nowHour = now.getHours();
  const adjustedToday = new Date();
  if (nowHour < 6) {
    adjustedToday.setDate(adjustedToday.getDate() - 1);
  }

  if (currentDate.toDateString() === adjustedToday.toDateString()) {
    const currentTimeLine = document.createElement('div');
    currentTimeLine.id = 'current-time-line';
    currentTimeLine.style.gridColumn = '2'; // ì´ë²¤íŠ¸ ì¹¸ì—ë§Œ í‘œì‹œ
    currentTimeLine.style.position = 'absolute';
    currentTimeLine.style.left = '1px';
    currentTimeLine.style.right = '1px';
    currentTimeLine.style.height = '2px';
    currentTimeLine.style.backgroundColor = '#cc3333';
    currentTimeLine.style.zIndex = '100';
    currentTimeLine.style.pointerEvents = 'none';

    // í˜„ì¬ ì‹œê°„ í‘œì‹œ ë¼ë²¨ (ì„  ìœ„)
    const timeLabel = document.createElement('div');
    timeLabel.id = 'current-time-label';
    timeLabel.style.position = 'absolute';
    timeLabel.style.right = '4px';
    timeLabel.style.top = '-14px';
    timeLabel.style.fontSize = '9px';
    timeLabel.style.color = '#cc3333';
    timeLabel.style.fontWeight = 'bold';
    timeLabel.style.pointerEvents = 'none';
    currentTimeLine.appendChild(timeLabel);

    // ë‹¤ìŒ ì¼ì •ê¹Œì§€ ë‚¨ì€ ì‹œê°„ í‘œì‹œ ë¼ë²¨ (ì„  ì•„ë˜)
    const nextEventLabel = document.createElement('div');
    nextEventLabel.id = 'next-event-label';
    nextEventLabel.style.position = 'absolute';
    nextEventLabel.style.right = '4px';
    nextEventLabel.style.top = '6px';
    nextEventLabel.style.fontSize = '9px';
    nextEventLabel.style.color = '#333';
    nextEventLabel.style.fontWeight = 'bold';
    nextEventLabel.style.pointerEvents = 'none';
    currentTimeLine.appendChild(nextEventLabel);

    // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    const updateCurrentTimeLine = () => {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const slotIndex = getSlotIndex(hours);
      const minuteOffset = minutes / 60;

      const position = (slotIndex + minuteOffset) * 24 + 30; // 24px per slot + 30px header
      currentTimeLine.style.top = position + 'px';

      // í˜„ì¬ ì‹œê°„ í‘œì‹œ
      timeLabel.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;

      // ì§„í–‰ ì¤‘ì¸ ì¼ì • ë˜ëŠ” ë‹¤ìŒ ì¼ì • ì°¾ê¸° (ì¼ê°„ë·°ì— í‘œì‹œëœ ìº˜ë¦°ë”ì˜ ì´ë²¤íŠ¸ë§Œ)
      const currentTimeInMinutes = hours * 60 + minutes;
      const dayEvents = getAllEventsForDate(currentDate);

      let ongoingEvent = null;
      let nextEvent = null;
      let minTimeDiff = Infinity;

      dayEvents.forEach(event => {
        const startTime = event.startTime || event.time;
        const endTime = event.endTime;

        if (startTime && startTime !== 'ì¢…ì¼') {
          const startHour = getEventHour(startTime);
          const startMinute = getEventMinute(startTime);
          const startTimeInMinutes = startHour * 60 + startMinute;

          // ì¢…ë£Œ ì‹œê°„ í™•ì¸
          if (endTime && endTime !== 'ì¢…ì¼') {
            const endHour = getEventHour(endTime);
            const endMinute = getEventMinute(endTime);
            let endTimeInMinutes = endHour * 60 + endMinute;

            // ì¢…ë£Œ ì‹œê°„ì´ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ì‘ìœ¼ë©´ ë‹¤ìŒë‚ ë¡œ ê°„ì£¼
            if (endTimeInMinutes <= startTimeInMinutes) {
              endTimeInMinutes += 24 * 60;
            }

            // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì¼ì •ì¸ì§€ í™•ì¸
            if (startTimeInMinutes <= currentTimeInMinutes && currentTimeInMinutes < endTimeInMinutes) {
              ongoingEvent = event;
              ongoingEvent.endTimeInMinutes = endTimeInMinutes;
            }
          }

          // ë‹¤ìŒ ì¼ì • ì°¾ê¸°
          if (startTimeInMinutes > currentTimeInMinutes) {
            const diff = startTimeInMinutes - currentTimeInMinutes;
            if (diff < minTimeDiff) {
              minTimeDiff = diff;
              nextEvent = event;
            }
          }
        }
      });

      // ì§„í–‰ ì¤‘ì¸ ì¼ì •ì´ ìˆìœ¼ë©´ ì¢…ë£Œê¹Œì§€ ë‚¨ì€ ì‹œê°„ í‘œì‹œ
      if (ongoingEvent) {
        const timeDiff = ongoingEvent.endTimeInMinutes - currentTimeInMinutes;
        const hoursUntil = Math.floor(timeDiff / 60);
        const minutesUntil = timeDiff % 60;
        nextEventLabel.textContent = `-${hoursUntil.toString().padStart(2, '0')}:${minutesUntil.toString().padStart(2, '0')}`;
        nextEventLabel.title = `ì§„í–‰ ì¤‘: ${ongoingEvent.summary}`;
        nextEventLabel.style.display = 'block';
      } else if (nextEvent) {
        // ì§„í–‰ ì¤‘ì¸ ì¼ì •ì´ ì—†ìœ¼ë©´ ë‹¤ìŒ ì¼ì •ê¹Œì§€ ì‹œê°„ í‘œì‹œ
        const hoursUntil = Math.floor(minTimeDiff / 60);
        const minutesUntil = minTimeDiff % 60;
        nextEventLabel.textContent = `-${hoursUntil.toString().padStart(2, '0')}:${minutesUntil.toString().padStart(2, '0')}`;
        nextEventLabel.title = `ë‹¤ìŒ ì¼ì •: ${nextEvent.summary}`;
        nextEventLabel.style.display = 'block';
      } else {
        // ì§„í–‰ ì¤‘ì¸ ì¼ì •ë„ ë‹¤ìŒ ì¼ì •ë„ ì—†ìœ¼ë©´ Free
        nextEventLabel.textContent = 'Free';
        nextEventLabel.title = '';
        nextEventLabel.style.display = 'block';
      }
    };

    updateCurrentTimeLine();
    grid.appendChild(currentTimeLine);

    // 1ë¶„ë§ˆë‹¤ ì—…ë°ì´íŠ¸
    if (window.currentTimeLineInterval) {
      clearInterval(window.currentTimeLineInterval);
    }
    window.currentTimeLineInterval = setInterval(updateCurrentTimeLine, 60000);
  } else {
    // ì˜¤ëŠ˜ì´ ì•„ë‹Œ ë‚ ì§œë¥¼ ë³´ê³  ìˆìœ¼ë©´ ì¸í„°ë²Œ ì œê±°
    if (window.currentTimeLineInterval) {
      clearInterval(window.currentTimeLineInterval);
      window.currentTimeLineInterval = null;
    }
  }

  container.appendChild(grid);
  calendarContent.innerHTML = '';
  calendarContent.appendChild(container);
}

// ê¸°ì¡´ í—¬í¼ í•¨ìˆ˜ë“¤
function getEventHour(timeString) {
  if (timeString === 'ì¢…ì¼') return SLOT_START_HOUR;
  const parts = timeString.split(':');
  return parseInt(parts[0], 10) || 0;
}

function getEventMinute(timeString) {
  if (timeString === 'ì¢…ì¼') return 0;
  const parts = timeString.split(':');
  return parseInt(parts[1], 10) || 0;
}

// ì‹œê°„ ì •ë³´ë¥¼ í¬ë§·í•˜ëŠ” í•¨ìˆ˜ (íˆ´íŒìš©)
function formatEventTimeInfo(event) {
  if (event.time === 'ì¢…ì¼' || event.startTime === 'ì¢…ì¼') {
    return 'ì¢…ì¼';
  }

  const startTime = event.startTime || event.time;
  const endTime = event.endTime;

  if (!endTime || endTime === 'ì¢…ì¼') {
    return startTime;
  }

  // ì‹œê°„ ì°¨ì´ ê³„ì‚°
  const startHour = getEventHour(startTime);
  const startMinute = getEventMinute(startTime);
  const endHour = getEventHour(endTime);
  const endMinute = getEventMinute(endTime);

  const startTotalMinutes = startHour * 60 + startMinute;
  let endTotalMinutes = endHour * 60 + endMinute;

  // ì¢…ë£Œ ì‹œê°„ì´ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ì‘ìœ¼ë©´ ë‹¤ìŒë‚ ë¡œ ê°„ì£¼
  if (endTotalMinutes <= startTotalMinutes) {
    endTotalMinutes += 24 * 60;
  }

  const durationMinutes = endTotalMinutes - startTotalMinutes;
  const durationHours = Math.floor(durationMinutes / 60);
  const durationMins = durationMinutes % 60;

  let durationText = '';
  if (durationHours > 0 && durationMins > 0) {
    durationText = `${durationHours}ì‹œê°„ ${durationMins}ë¶„`;
  } else if (durationHours > 0) {
    durationText = `${durationHours}ì‹œê°„`;
  } else {
    durationText = `${durationMins}ë¶„`;
  }

  return `${startTime}-${endTime} (${durationText})`;
}

function getAllEventsForDate(date) {
  const allEvents = [];
  const activeCalendarIds = viewCalendarSettings[currentView];
  const seenEvents = new Map(); // ì¤‘ë³µ ì²´í¬ìš©

  // ë¡œì»¬ ì‹œê°„ëŒ€ë¡œ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± (YYYY-MM-DD)
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const dateString = `${year}-${month}-${day}`;

  // ì „ë‚  ë‚ ì§œë„ ê³„ì‚° (6ì‹œ ë„˜ì–´ì˜¤ëŠ” ì´ë²¤íŠ¸ í¬í•¨)
  const prevDate = new Date(date);
  prevDate.setDate(prevDate.getDate() - 1);
  const prevYear = prevDate.getFullYear();
  const prevMonth = String(prevDate.getMonth() + 1).padStart(2, '0');
  const prevDay = String(prevDate.getDate()).padStart(2, '0');
  const prevDateString = `${prevYear}-${prevMonth}-${prevDay}`;

  calendars.forEach(calendar => {
    if (!calendar.visible || !calendar.events) return;
    if (activeCalendarIds.length > 0 && !activeCalendarIds.includes(calendar.id)) return;

    // ë‹¹ì¼ ì´ë²¤íŠ¸
    const events = calendar.events.filter(event => {
      return event.date === dateString;
    });

    // ì „ë‚  ì´ë²¤íŠ¸ ì¤‘ 6ì‹œ ë„˜ì–´ê°€ëŠ” ê²ƒë“¤
    const prevEvents = calendar.events.filter(event => {
      if (event.date !== prevDateString) return false;
      if (event.time === 'ì¢…ì¼') return false;

      // 6ì‹œ ë„˜ì–´ê°€ëŠ”ì§€ í™•ì¸
      const startHour = getEventHour(event.startTime);
      const endHour = getEventHour(event.endTime);
      const startMinute = getEventMinute(event.startTime);
      const endMinute = getEventMinute(event.endTime);
      const startPosition = getExactSlotPosition(startHour, startMinute);
      const endPosition = getExactSlotPosition(endHour, endMinute);

      return startPosition >= endPosition; // 6ì‹œ ë„˜ì–´ê°€ë©´ true
    });

    // ì „ë‚  ì´ë²¤íŠ¸ë¥¼ ë¶„í• í•´ì„œ ë‹¤ìŒë‚  ë¶€ë¶„ë§Œ ì¶”ê°€
    prevEvents.forEach(event => {
      const splitEvents = splitCrossDayEvent({
        ...event,
        color: calendar.color,
        calendarName: calendar.name
      });

      // isNextDay ë¶€ë¶„ë§Œ ì¶”ê°€ (ë‚ ì§œê°€ dateStringê³¼ ì¼ì¹˜í•˜ëŠ” ê²ƒ)
      splitEvents.forEach(splitEvent => {
        if (splitEvent.date === dateString) {
          const eventKey = `${event.uid || event.id}_${splitEvent.date}_${splitEvent.startTime}`;
          if (!seenEvents.has(eventKey)) {
            seenEvents.set(eventKey, true);
            allEvents.push(splitEvent);
          }
        }
      });
    });
    
    events.forEach(event => {
      // ë°˜ë³µ ì¼ì •ì˜ ê²½ìš° recurringIdë¡œ ì¤‘ë³µ ì²´í¬
      const eventKey = event.recurringId || 
                      `${event.uid || event.id}_${event.date}_${event.startTime}`;
      
      // ì´ë¯¸ ìˆëŠ” ì´ë²¤íŠ¸ì¸ì§€ ì²´í¬
      if (!seenEvents.has(eventKey)) {
        seenEvents.set(eventKey, true);
        allEvents.push({
          ...event,
          color: calendar.color,
          calendarName: calendar.name
        });
      } else {
        // ìˆ˜ì •ëœ ë²„ì „ì´ë©´ êµì²´
        if (event.isModified) {
          const index = allEvents.findIndex(e => 
            (e.recurringId === eventKey) || 
            (`${e.uid || e.id}_${e.date}_${e.startTime}` === eventKey)
          );
          if (index >= 0) {
            allEvents[index] = {
              ...event,
              color: calendar.color,
              calendarName: calendar.name
            };
          }
        }
      }
    });
  });
  
  return allEvents;
}


async function refreshAllCalendars() {
  addDebugLog('ëª¨ë“  ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
  
  for (const calendar of calendars) {
    if (calendar.type !== 'sample') {
      updateCalendarStatus(calendar.id, 'loading', 'ìƒˆë¡œê³ ì¹¨ ì¤‘...');
      try {
        calendar.events = [];
        await loadCalendarEvents(calendar);
        updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
      } catch (error) {
        updateCalendarStatus(calendar.id, 'error', error.message);
        addDebugLog(`ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${calendar.name} - ${error.message}`);
      }
    }
  }
  
  renderCalendar();
  saveToStorage();
  addDebugLog('ëª¨ë“  ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
}



// ìº˜ë¦°ë” ì¶”ê°€
async function addCalendar() {
  const type = document.getElementById('calendarType').value;
  const name = document.getElementById('calendarName').value.trim();
  const color = document.getElementById('calendarColor').value;
  
  if (!name) {
    alert('ìº˜ë¦°ë” ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  let url = '';
  let calendarId = '';
  let apiKey = '';
  let notionApiKey = '';
  let notionDatabaseId = '';
  let notionDateProperty = '';
  let notionTitleProperty = '';

  if (type === 'ical') {
    url = document.getElementById('icalUrl').value.trim();
    if (!url || !url.includes('.ics')) {
      alert('ì˜¬ë°”ë¥¸ iCal ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  } else if (type === 'googlePublic') {
    calendarId = document.getElementById('googleCalendarId').value.trim();
    if (!calendarId) {
      alert('êµ¬ê¸€ ìº˜ë¦°ë” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  } else if (type === 'api') {
    apiKey = document.getElementById('apiKey').value.trim();
    calendarId = document.getElementById('calendarId').value.trim() || 'primary';
    if (!apiKey) {
      alert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  } else if (type === 'notion') {
    notionApiKey = document.getElementById('notionApiKey').value.trim();
    notionDatabaseId = document.getElementById('notionDatabaseId').value.trim();
    notionDateProperty = document.getElementById('notionDateProperty').value.trim() || 'Date';
    notionTitleProperty = document.getElementById('notionTitleProperty').value.trim() || 'Name';
    if (!notionApiKey || !notionDatabaseId) {
      alert('Notion API Keyì™€ Database IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  }

  const calendar = {
    id: Date.now().toString(),
    name: name,
    type: type,
    color: color,
    visible: true,
    url: url,
    calendarId: calendarId,
    apiKey: apiKey,
    notionApiKey: notionApiKey,
    notionDatabaseId: notionDatabaseId,
    notionDateProperty: notionDateProperty,
    notionTitleProperty: notionTitleProperty,
    events: [],
    status: 'loading',
    statusMessage: 'ë¡œë”© ì¤‘...'
  };

  addDebugLog(`ìº˜ë¦°ë” ì¶”ê°€ ì‹œì‘: ${name} (${type})`);

  calendars.push(calendar);

  // ìƒˆ ìº˜ë¦°ë”ë¥¼ ëª¨ë“  ë·°ì— ìë™ìœ¼ë¡œ ì¶”ê°€
  if (!viewCalendarSettings.day.includes(calendar.id)) {
    viewCalendarSettings.day.push(calendar.id);
  }
  if (!viewCalendarSettings.week.includes(calendar.id)) {
    viewCalendarSettings.week.push(calendar.id);
  }
  if (!viewCalendarSettings.month.includes(calendar.id)) {
    viewCalendarSettings.month.push(calendar.id);
  }

  updateCalendarList();
  
  // ìº˜ë¦°ë” ë°ì´í„° ë¡œë“œ
  try {
    await loadCalendarEvents(calendar);
    updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
    addDebugLog(`ìº˜ë¦°ë” ë¡œë“œ ì„±ê³µ: ${name}, ${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
    renderCalendar();
    saveToStorage();
    
    // ì…ë ¥ í¼ ì´ˆê¸°í™”
    document.getElementById('calendarName').value = '';
    document.getElementById('icalUrl').value = '';
    document.getElementById('googleCalendarId').value = '';
    document.getElementById('apiKey').value = '';
    document.getElementById('calendarId').value = '';
    
    closeSettings();
  } catch (error) {
    updateCalendarStatus(calendar.id, 'error', error.message);
    addDebugLog(`ìº˜ë¦°ë” ë¡œë“œ ì‹¤íŒ¨: ${name} - ${error.message}`);
    alert('ìº˜ë¦°ë”ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
}

// ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
function saveToStorage() {
  try {
    const data = {
      view: currentView,
      currentDate: currentDate.toISOString(),
      accentColor: accentColor,
      accentHoverColor: accentHoverColor,
      viewCalendarSettings: viewCalendarSettings,
      textAlignHorizontal: textAlignHorizontal,
      textAlignVertical: textAlignVertical,
      eventTextColor: eventTextColor,
      eventFontSize: eventFontSize,
      calendars: calendars.map(cal => ({
        ...cal,
        events: cal.events || []
    }))
};
    
    localStorage.setItem('multiCalendarData', JSON.stringify(data));
    addDebugLog('ì„¤ì •ì´ localStorageì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (e) {
    addDebugLog(`ì €ì¥ ì‹¤íŒ¨: ${e.message}`);
  }
}

function toggleViewCalendarSettings() {
  const content = document.getElementById('viewCalendarSettings');
  const icon = document.getElementById('viewToggleIcon');
  
  content.classList.toggle('expanded');
  icon.classList.toggle('expanded');
}

// ìº˜ë¦°ë” ì„¤ì • ë‚´ë³´ë‚´ê¸°
function exportCalendarSettings() {
  try {
    const exportData = {
      version: '1.0',
      exportDate: new Date().toISOString(),
      view: currentView,
      currentDate: currentDate.toISOString(),
      accentColor: accentColor,
      accentHoverColor: accentHoverColor,
      viewCalendarSettings: viewCalendarSettings,
      textAlignHorizontal: textAlignHorizontal,
      textAlignVertical: textAlignVertical,
      eventTextColor: eventTextColor,
      eventFontSize: eventFontSize,
      calendars: calendars.map(cal => ({
        id: cal.id,
        name: cal.name,
        type: cal.type,
        color: cal.color,
        visible: cal.visible,
        url: cal.url,
        calendarId: cal.calendarId,
        apiKey: cal.apiKey,
        status: cal.status,
        statusMessage: cal.statusMessage
        // eventsëŠ” ì œì™¸ (ìš©ëŸ‰ ì ˆì•½ ë° ë³´ì•ˆ)
      }))
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `ìº˜ë¦°ë”ì„¤ì •_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    addDebugLog(`ìº˜ë¦°ë” ì„¤ì • ë‚´ë³´ë‚´ê¸° ì™„ë£Œ: ${calendars.length}ê°œ ìº˜ë¦°ë”`);
    alert('ìº˜ë¦°ë” ì„¤ì •ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
    
  } catch (error) {
    addDebugLog(`ì„¤ì • ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ${error.message}`);
    alert('ì„¤ì • ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
}

// ìº˜ë¦°ë” ì„¤ì • ê°€ì ¸ì˜¤ê¸°
async function importCalendarSettings(fileInput) {
  const file = fileInput.files[0];
  if (!file) return;
  
  try {
    const text = await file.text();
    const importData = JSON.parse(text);
    
    // ë²„ì „ í™•ì¸
    if (!importData.version) {
      throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì„¤ì • íŒŒì¼ì…ë‹ˆë‹¤.');
    }
    
    addDebugLog(`ì„¤ì • íŒŒì¼ ê°€ì ¸ì˜¤ê¸° ì‹œì‘: ${importData.calendars?.length || 0}ê°œ ìº˜ë¦°ë”`);
    
    // ê¸°ì¡´ ìº˜ë¦°ë” ë°±ì—… (sample ì œì™¸)
    const backupCalendars = calendars.filter(cal => cal.type === 'sample');
    
    // ì„¤ì • ë³µì›
    currentView = importData.view || 'day';
    if (importData.currentDate) {
      currentDate = new Date(importData.currentDate);
    }
    if (importData.accentColor) {
      setAccentColor(importData.accentColor);
    }
    if (importData.viewCalendarSettings) {
      viewCalendarSettings = importData.viewCalendarSettings;
    }

    // í…ìŠ¤íŠ¸ ì„¤ì • ë³µì›
    if (importData.textAlignHorizontal) {
      textAlignHorizontal = importData.textAlignHorizontal;
      document.getElementById('textAlignHorizontal').value = textAlignHorizontal;
    }
    if (importData.textAlignVertical) {
      textAlignVertical = importData.textAlignVertical;
      document.getElementById('textAlignVertical').value = textAlignVertical;
    }
    if (importData.eventTextColor) {
      eventTextColor = importData.eventTextColor;
      document.getElementById('eventTextColor').value = eventTextColor;
    }
    if (importData.eventFontSize) {
      eventFontSize = importData.eventFontSize;
      document.getElementById('eventFontSize').value = eventFontSize;
    }

    // ìº˜ë¦°ë” ë³µì› ë° ì´ë²¤íŠ¸ ë¡œë“œ
    calendars = [...backupCalendars]; // sample ìº˜ë¦°ë”ëŠ” ìœ ì§€
    
    if (importData.calendars && Array.isArray(importData.calendars)) {
      for (const calData of importData.calendars) {
        if (calData.type === 'sample') continue; // sampleì€ ê±´ë„ˆë›°ê¸°
        
        const calendar = {
          id: calData.id || Date.now().toString() + Math.random(),
          name: calData.name || 'ì´ë¦„ ì—†ìŒ',
          type: calData.type,
          color: calData.color || '#D1D1D1',
          visible: calData.visible !== false,
          url: calData.url,
          calendarId: calData.calendarId,
          apiKey: calData.apiKey,
          events: [],
          status: 'loading',
          statusMessage: 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'
        };
        
        calendars.push(calendar);
        updateCalendarStatus(calendar.id, 'loading', 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        
        // ì´ë²¤íŠ¸ ë¡œë“œ
        try {
          await loadCalendarEvents(calendar);
          updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
          addDebugLog(`ìº˜ë¦°ë” ë³µì› ì„±ê³µ: ${calendar.name}`);
        } catch (error) {
          updateCalendarStatus(calendar.id, 'error', error.message);
          addDebugLog(`ìº˜ë¦°ë” ë³µì› ì‹¤íŒ¨: ${calendar.name} - ${error.message}`);
        }
      }
    }
    
    // UI ì—…ë°ì´íŠ¸
    document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(currentView + 'Btn').classList.add('active');
    
    updateCurrentDateDisplay();
    updateCalendarList();
    renderCalendar();
    saveToStorage();
    
    addDebugLog('ìº˜ë¦°ë” ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ');
    alert(`ìº˜ë¦°ë” ì„¤ì •ì„ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.\në³µì›ëœ ìº˜ë¦°ë”: ${importData.calendars?.length || 0}ê°œ`);
    
  } catch (error) {
    addDebugLog(`ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}`);
    alert('ì„¤ì • íŒŒì¼ì„ ì½ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
  
  // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
  fileInput.value = '';
}

function loadFromStorage() {
  try {
    const data = localStorage.getItem('multiCalendarData');
    if (data) {
      const parsed = JSON.parse(data);
      currentView = parsed.view || 'day';
      if (parsed.currentDate) {
        currentDate = new Date(parsed.currentDate);
      }
      accentColor = parsed.accentColor || '#D1D1D1';
      accentHoverColor = parsed.accentHoverColor || darkenColor(accentColor, 15);
      viewCalendarSettings = parsed.viewCalendarSettings || { day: [], week: [], month: [] };
      textAlignHorizontal = parsed.textAlignHorizontal || 'center';
      textAlignVertical = parsed.textAlignVertical || 'center';
      eventTextColor = parsed.eventTextColor || 'white';
      eventFontSize = parsed.eventFontSize || '0.6em';
      calendars = parsed.calendars || [];

      // ì €ì¥ëœ ìº˜ë¦°ë”ë“¤ì„ ë·° ì„¤ì •ì— ìë™ìœ¼ë¡œ ì¶”ê°€ (ì—†ëŠ” ê²½ìš°)
      calendars.forEach(calendar => {
        if (!viewCalendarSettings.day.includes(calendar.id)) {
          viewCalendarSettings.day.push(calendar.id);
        }
        if (!viewCalendarSettings.week.includes(calendar.id)) {
          viewCalendarSettings.week.push(calendar.id);
        }
        if (!viewCalendarSettings.month.includes(calendar.id)) {
          viewCalendarSettings.month.push(calendar.id);
        }
      });

      // UI ë³µì›
      document.getElementById('textAlignHorizontal').value = textAlignHorizontal;
      document.getElementById('textAlignVertical').value = textAlignVertical;
      document.getElementById('eventTextColor').value = eventTextColor;
      document.getElementById('eventFontSize').value = eventFontSize;
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(currentView + 'Btn').classList.add('active');
      
      // ì €ì¥ëœ ìº˜ë¦°ë”ë“¤ì˜ ì´ë²¤íŠ¸ ë‹¤ì‹œ ë¡œë“œ (API ê¸°ë°˜ ìº˜ë¦°ë”ë§Œ)
      calendars.forEach(async (calendar) => {
        if (calendar.type !== 'sample' && (!calendar.events || calendar.events.length === 0)) {
          updateCalendarStatus(calendar.id, 'loading', 'ë¡œë”© ì¤‘...');
          try {
            await loadCalendarEvents(calendar);
            updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
          } catch (error) {
            updateCalendarStatus(calendar.id, 'error', error.message);
            addDebugLog(`ì €ì¥ëœ ìº˜ë¦°ë” ë¡œë“œ ì‹¤íŒ¨: ${calendar.name} - ${error.message}`);
          }
        } else {
          // ì´ë¯¸ ì €ì¥ëœ ì´ë²¤íŠ¸ê°€ ìˆìœ¼ë©´ ì„±ê³µ ìƒíƒœë¡œ í‘œì‹œ
          updateCalendarStatus(calendar.id, 'success', `${(calendar.events || []).length}ê°œ ì´ë²¤íŠ¸`);
        }
      });
      
      addDebugLog('ì„¤ì •ì´ localStorageì—ì„œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
  } catch (e) {
    addDebugLog(`ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}`);
  }
}

// í•œêµ­ ê³µíœ´ì¼ ìƒ˜í”Œ ì¶”ê°€
function addKoreanHolidays() {
  const holidayCalendar = {
    id: 'korean-holidays-' + Date.now(),
    name: 'í•œêµ­ ê³µíœ´ì¼',
    type: 'googlePublic',
    color: '#ea4335',
    visible: true,
    calendarId: 'ko.south_korea#holiday@group.v.calendar.google.com',
    events: [],
    status: 'loading',
    statusMessage: 'ë¡œë”© ì¤‘...'
  };
  
  calendars.push(holidayCalendar);
  updateCalendarList();
  
  loadCalendarEvents(holidayCalendar)
    .then(() => {
      updateCalendarStatus(holidayCalendar.id, 'success', `${holidayCalendar.events.length}ê°œ ì´ë²¤íŠ¸`);
      renderCalendar();
      saveToStorage();
      addDebugLog('í•œêµ­ ê³µíœ´ì¼ ìº˜ë¦°ë” ì¶”ê°€ ì™„ë£Œ');
    })
    .catch(error => {
      updateCalendarStatus(holidayCalendar.id, 'error', error.message);
      addDebugLog(`í•œêµ­ ê³µíœ´ì¼ ìº˜ë¦°ë” ì¶”ê°€ ì‹¤íŒ¨: ${error.message}`);
    });
}

// ìƒ˜í”Œ ìº˜ë¦°ë” ì¶”ê°€ í•¨ìˆ˜
function addSampleCalendar() {
  const today = new Date();
  const sampleCalendar = {
    id: 'sample-' + Date.now(),
    name: 'ìƒ˜í”Œ ìº˜ë¦°ë”',
    type: 'ical',
    color: '#4285f4',
    visible: true,
    events: [
      {
        id: 'sample-1',
        title: 'ìƒ˜í”Œ ì¼ì • 1',
        date: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`,
        startTime: '09:00',
        endTime: '10:00',
        time: '09:00',
        color: '#4285f4',
        description: 'ìƒ˜í”Œ ì¼ì •ì…ë‹ˆë‹¤',
        location: '',
        travelTime: 0
      },
      {
        id: 'sample-2',
        title: 'ìƒ˜í”Œ ì¢…ì¼ ì¼ì •',
        date: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate() + 1).padStart(2, '0')}`,
        startTime: 'ì¢…ì¼',
        endTime: 'ì¢…ì¼',
        time: 'ì¢…ì¼',
        color: '#4285f4',
        description: 'ì¢…ì¼ ì¼ì • ìƒ˜í”Œì…ë‹ˆë‹¤',
        location: '',
        travelTime: 0
      }
    ],
    status: 'success',
    statusMessage: '2ê°œ ì´ë²¤íŠ¸'
  };

  calendars.push(sampleCalendar);
  updateCalendarList();
  renderCalendar();
  saveToStorage();
  addDebugLog('ìƒ˜í”Œ ìº˜ë¦°ë” ì¶”ê°€ ì™„ë£Œ');
}

// ì´ˆê¸°í™” ì‹¤í–‰
init();

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  
  switch(e.key) {
    case 'ArrowLeft':
      navigateCalendar(-1);
      e.preventDefault();
      break;
    case 'ArrowRight':
      navigateCalendar(1);
      e.preventDefault();
      break;
    case 't':
    case 'T':
      goToToday();
      break;
    case 'm':
    case 'M':
      setView('month');
      break;
    case 'w':
    case 'W':
      setView('week');
      break;
    case 'd':
    case 'D':
      setView('day');
      break;
    case 'Escape':
      closeSettings();
      break;
  }
});

// ìº˜ë¦°ë” ìƒ‰ìƒ ìë™ í• ë‹¹
document.getElementById('calendarColor').addEventListener('focus', function() {
  this.value = calendarColors[calendars.length % calendarColors.length];
});

// ë””ë²„ê·¸ìš© í•¨ìˆ˜ë“¤
window.debugCalendar = {
  showCalendars: () => console.table(calendars),
  showEvents: (calendarId) => {
    const calendar = calendars.find(c => c.id === calendarId || c.name === calendarId);
    if (calendar) {
      console.table(calendar.events);
    } else {
      console.log('ìº˜ë¦°ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
  },
  clearStorage: () => {
    localStorage.removeItem('multiCalendarData');
    location.reload();
  },
  addKoreanHolidays: addKoreanHolidays,
  addSampleCalendar: addSampleCalendar
};
  

// ë„ì›€ë§ í‘œì‹œ
console.log('%cë©€í‹° ìº˜ë¦°ë” ë·°ì–´ ë””ë²„ê·¸ ë„êµ¬%c\n' +
  'debugCalendar.showCalendars() - ëª¨ë“  ìº˜ë¦°ë” ì •ë³´ í‘œì‹œ\n' +
  'debugCalendar.showEvents(ìº˜ë¦°ë”ID) - íŠ¹ì • ìº˜ë¦°ë”ì˜ ì´ë²¤íŠ¸ í‘œì‹œ\n' +
  'debugCalendar.clearStorage() - ì €ì¥ëœ ë°ì´í„° ì‚­ì œ ë° ìƒˆë¡œê³ ì¹¨\n' +
  'debugCalendar.addKoreanHolidays() - í•œêµ­ ê³µíœ´ì¼ ìº˜ë¦°ë” ì¶”ê°€\n' +
  'debugCalendar.addSampleCalendar() - ìƒ˜í”Œ ìº˜ë¦°ë” ì¶”ê°€', 
  'color: #D1D1D1; font-weight: bold; font-size: 14px;',
  'color: #333; font-size: 12px;');
</script>
</div>
</body>
</html>
