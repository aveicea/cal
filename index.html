<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>멀티 구글 캘린더 뷰어 (노션 임베드용)</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
  #calendar { max-width: 900px; margin: 20px auto; }
  #controls { text-align:center; margin: 10px; }
  input, button { padding: 8px; margin: 5px; width: 80%; max-width:400px; }
</style>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js"></script>
</head>
<body>
<div id="controls">
  <input type="text" id="ics-url" placeholder="ICS URL 입력 후 Enter">
  <button id="add-calendar">캘린더 추가</button>
</div>
<div id="calendar"></div>

<script>
const calendarEl = document.getElementById('calendar');
const calendar = new FullCalendar.Calendar(calendarEl, {
  initialView: 'dayGridMonth',
  height: 'auto',
  events: []
});
calendar.render();

const corsProxy = 'https://cors-anywhere.herokuapp.com/'; // CORS 프록시
const colorPalette = ['#f94144','#f3722c','#f9c74f','#90be6d','#43aa8b','#577590','#b56576'];
let colorIndex = 0;

async function fetchICS(url) {
  try {
    const res = await fetch(corsProxy + url);
    if (!res.ok) throw new Error('ICS fetch 실패');
    const text = await res.text();
    return ICAL.parse(text);
  } catch(e) {
    alert('ICS 불러오기 실패: ' + e.message);
    return null;
  }
}

function parseEvents(icalData, color) {
  const comp = new ICAL.Component(icalData);
  const vevents = comp.getAllSubcomponents('vevent');
  return vevents.map(ve => {
    const event = new ICAL.Event(ve);
    return {
      title: event.summary,
      start: event.startDate.toString(),
      end: event.endDate.toString(),
      color: color
    };
  });
}

async function addCalendar(url) {
  const icalData = await fetchICS(url);
  if (!icalData) return;
  const color = colorPalette[colorIndex % colorPalette.length];
  colorIndex++;
  const events = parseEvents(icalData, color);
  events.forEach(ev => calendar.addEvent(ev));
}

document.getElementById('add-calendar').addEventListener('click', () => {
  const url = document.getElementById('ics-url').value.trim();
  if (url) addCalendar(url);
  document.getElementById('ics-url').value = '';
});

document.getElementById('ics-url').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    const url = e.target.value.trim();
    if (url) addCalendar(url);
    e.target.value = '';
  }
});
</script>
</body>
</html>
