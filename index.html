<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>구글 캘린더 뷰어</title>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #calendar { max-width: 900px; margin: 0 auto; }
  #controls { margin-bottom: 20px; }
  input, select, button { margin-right: 10px; padding: 5px; }
  #calendarList { margin-top: 10px; }
  .calendar-item { margin-bottom: 5px; }
  .calendar-item button { margin-left: 10px; }
</style>
</head>
<body>

<div id="controls">
  <input type="text" id="icsUrl" placeholder="ICS URL 입력">
  <input type="color" id="colorPicker" value="#3788d8">
  <button id="addCalendar">캘린더 추가</button>
  <div id="calendarList"></div>
</div>

<div id="calendar"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 700,
    eventSources: []
  });
  calendar.render();

  const calendars = []; // 추가된 캘린더 목록 저장

  async function addICS(url, color) {
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error('ICS 불러오기 실패');
      const text = await res.text();
      const jcal = ICAL.parse(text);
      const comp = new ICAL.Component(jcal);
      const vevents = comp.getAllSubcomponents('vevent');

      const events = vevents.map(event => {
        const e = new ICAL.Event(event);
        return {
          title: e.summary,
          start: e.startDate.toJSDate(),
          end: e.endDate.toJSDate(),
          allDay: e.startDate.isDate,
          color: color
        };
      });

      const source = calendar.addEventSource(events);
      calendars.push({ url, color, source });
      renderCalendarList();
    } catch (err) {
      alert('ICS 로드 실패: ' + err.message);
    }
  }

  function removeCalendar(index) {
    const cal = calendars[index];
    cal.source.remove();
    calendars.splice(index, 1);
    renderCalendarList();
  }

  function renderCalendarList() {
    const listEl = document.getElementById('calendarList');
    listEl.innerHTML = '';
    calendars.forEach((cal, idx) => {
      const div = document.createElement('div');
      div.className = 'calendar-item';
      div.innerHTML = `<span style="color:${cal.color}">●</span> ${cal.url} 
                       <button onclick="removeCalendar(${idx})">삭제</button>`;
      listEl.appendChild(div);
    });
  }

  // removeCalendar 함수 외부에서도 호출 가능하게
  window.removeCalendar = removeCalendar;

  document.getElementById('addCalendar').addEventListener('click', function() {
    const url = document.getElementById('icsUrl').value.trim();
    const color = document.getElementById('colorPicker').value;
    if (url) {
      addICS(url, color);
      document.getElementById('icsUrl').value = '';
    }
  });
});
</script>

</body>
</html>
