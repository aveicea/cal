<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>멀티 캘린더 뷰어</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #ffffff;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  
  /* 헤더 영역 */
  .header {
    position: sticky;
    top: 0;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: saturate(180%) blur(6px);
    border-bottom: 1px solid #eee;
    z-index: 100;
  }
  
  .header-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 64px;
    padding: 0 16px;
  }
  
  .left-controls {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .view-toggle {
    display: inline-flex;
    align-items: center;
    border: 1px solid #e0e0e0;
    border-radius: 999px;
    overflow: hidden;
  }
  
  .view-btn {
    padding: 8px 14px;
    font-size: 14px;
    border: none;
    background: transparent;
    cursor: pointer;
  }
  
  .view-btn.active {
    background: var(--accent-color, #4285f4);
    color: white;
    border-color: var(--accent-color, #4285f4);
  }
  
  .nav-controls {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-right: 20px;
  }
  
  .nav-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .nav-btn:hover {
    background: #f8f9fa;
  }
  
  .current-date {
    font-weight: 600;
    font-size: 15px;
  }
  
  .right-controls {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .settings-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #e0e0e0;
    background: white;
    border-radius: 6px;
    cursor: pointer;
  }
  
  /* 캘린더 컨테이너 */
  .calendar-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 12px;
  }
  
  .calendar-content {
    flex: 1;
    position: relative;
    background: white;
    border: 1px solid #eee;
    border-radius: 12px;
    overflow: hidden;
  }
  
  /* 월간 뷰 */
  .calendar-grid.month-view {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: 40px repeat(6, 1fr);
    height: 100%;
  }
  
  .weekday-name {
    padding: 8px 10px;
    background: #f7f7f8;
    border-bottom: 1px solid #eee;
    font-weight: 600;
    font-size: 13px;
  }
  
  .calendar-cell {
    border: 1px solid #f0f0f0;
    padding: 4px 6px;
    position: relative;
  }
  
  .date-number {
    font-size: 12px;
    color: #555;
    margin-bottom: 6px;
  }
  
  .event {
    position: relative;
    margin: 2px 0;
    padding: 4px 6px;
    border-radius: 6px;
    font-size: 12px;
    color: #222;
    background: #e3f2fd;
    line-height: 1.2;
    cursor: default;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  
  .more-events {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
  }
  
  /* 주간/일간 공통 */
  .calendar-grid.week-view,
  .calendar-grid.day-view {
    display: grid;
    grid-template-columns: 80px repeat(7, 1fr);
    grid-auto-rows: 40px;
    height: 100%;
  }
  
  .calendar-grid.day-view {
    grid-template-columns: 80px 1fr;
  }
  
  .week-header {
    background: #f7f7f8;
    border-bottom: 1px solid #eee;
    border-right: 1px solid #eee;
    padding: 8px 10px;
    font-weight: 600;
    font-size: 13px;
  }
  
  .time-header {
    position: sticky;
    left: 0;
    z-index: 2;
  }
  
  .time-slot {
    border-right: 1px solid #f0f0f0;
    background: #fcfcfc;
    color: #666;
    font-size: 12px;
    padding: 8px 10px;
  }
  
  .week-day {
    border: 1px solid #f0f0f0;
    position: relative;
    height: 40px;
  }
  
  /* 이벤트 배치용 (주/일) */
  .week-day .event,
  .day-view .event {
    position: absolute;
    left: 4px;
    right: 4px;
    height: 36px;
  }
  
  /* 설정 패널 */
  .settings-panel {
    position: fixed;
    right: 16px;
    top: 72px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    width: 450px;
    z-index: 1000;
    display: none;
    max-height: 70vh;
    overflow-y: auto;
  }
  
  .settings-title {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 12px;
  }
  
  .form-row {
    display: grid;
    grid-template-columns: 110px 1fr;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }
  
  .form-row input[type="text"],
  .form-row input[type="url"],
  .form-row select {
    padding: 8px 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
  }
  
  .calendar-list {
    margin-top: 14px;
    border-top: 1px dashed #e5e5e5;
    padding-top: 10px;
  }
  
  .calendar-item {
    display: grid;
    grid-template-columns: 18px 1fr 80px 100px 28px;
    align-items: center;
    gap: 8px;
    padding: 6px 0;
    border-bottom: 1px dotted #eee;
  }
  
  .calendar-color {
    width: 14px;
    height: 14px;
    border-radius: 4px;
    border: 1px solid #ddd;
  }
  
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 999px;
    background: #f1f5ff;
    color: #2a5bd7;
    font-size: 11px;
  }
  
  .danger {
    color: #c0392b;
  }
  
  .debug-log {
    margin-top: 12px;
    padding: 10px;
    background: #fafafa;
    border: 1px solid #eee;
    border-radius: 8px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 12px;
    color: #444;
    white-space: pre-wrap;
  }
</style>
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <div class="left-controls">
        <div class="view-toggle" role="tablist" aria-label="뷰 전환">
          <button class="view-btn" id="btnMonth" aria-selected="false">월</button>
          <button class="view-btn" id="btnWeek" aria-selected="true">주</button>
          <button class="view-btn" id="btnDay" aria-selected="false">일</button>
        </div>
        
        <div class="nav-controls">
          <button class="nav-btn" id="btnPrev" aria-label="이전">◀</button>
          <button class="nav-btn" id="btnToday">오늘</button>
          <button class="nav-btn" id="btnNext" aria-label="다음">▶</button>
        </div>
        <div class="current-date" id="currentDate"></div>
      </div>
      
      <div class="right-controls">
        <button class="settings-btn" id="btnSettings">⚙️</button>
      </div>
    </div>
  </div>

  <!-- 설정 패널 -->
  <div class="settings-panel" id="settingsPanel" aria-hidden="true">
    <div class="settings-title">캘린더 추가/관리</div>
    <div class="form-row">
      <label for="calendarType">캘린더 종류</label>
      <select id="calendarType">
        <option value="ics">iCalendar (.ics)</option>
        <option value="google">Google 공개 캘린더</option>
        <option value="api">Custom API (JSON)</option>
      </select>
    </div>

    <div class="form-row">
      <label for="calendarName">캘린더 이름</label>
      <input type="text" id="calendarName" placeholder="예: 개인 일정" />
    </div>

    <div class="form-row">
      <label for="calendarUrl">URL</label>
      <input type="url" id="calendarUrl" placeholder=".ics 또는 API URL" />
    </div>

    <div class="form-row">
      <label for="calendarColor">색상</label>
      <input type="text" id="calendarColor" placeholder="#4285f4" />
    </div>

    <div class="form-row">
      <label for="calendarStatus">상태</label>
      <select id="calendarStatus">
        <option value="visible">표시</option>
        <option value="hidden">숨김</option>
      </select>
    </div>

    <div class="form-row">
      <button id="btnAddCalendar">캘린더 추가</button>
      <button id="btnReloadCalendars">새로고침</button>
    </div>

    <div class="calendar-list" id="calendarList"></div>

    <div class="settings-title" style="margin-top:14px;">테마</div>
    <div class="form-row">
      <label>포인트 컬러</label>
      <div>
        <input type="color" id="accentColorPicker" value="#4285f4"/>
        <input type="text" id="accentColorText" value="#4285f4" style="width: 100px; margin-left: 6px;"/>
        <button id="btnApplyAccent">적용</button>
      </div>
    </div>

    <div class="debug-log" id="debugLog" aria-live="polite"></div>
  </div>

  <div class="calendar-container">
    <div class="calendar-content" id="calendarContent">
      <!-- 초기 표시 공간 -->
      <div class="calendar-grid day-view" id="emptyCalendar">
        <div class="week-header time-header">시간</div>
        <div class="week-header">일간 뷰</div>
      </div>
    </div>
  </div>

<script>
  // ===== 전역 상태 =====
  let currentView = 'week';
  let currentDate = new Date();
  let calendars = [];
  let eventsCache = [];

  const calendarContent = document.getElementById('calendarContent');
  const currentDateElement = document.getElementById('currentDate');
  const debugLog = document.getElementById('debugLog');

  // ===== 유틸 =====
  function addDebugLog(msg) {
    const time = new Date().toLocaleTimeString('ko-KR');
    debugLog.textContent += `[${time}] ${msg}\n`;
    debugLog.scrollTop = debugLog.scrollHeight;
  }
  function clearDebugLog() {
    debugLog.textContent = '';
  }
  function darkenColor(hex, amount = 0.15) {
    try {
      const num = parseInt(hex.replace('#', ''), 16);
      const r = Math.max(0, (num >> 16) - Math.round(255 * amount));
      const g = Math.max(0, ((num >> 8) & 0x00FF) - Math.round(255 * amount));
      const b = Math.max(0, (num & 0x0000FF) - Math.round(255 * amount));
      return `#${(r << 16 | g << 8 | b).toString(16).padStart(6, '0')}`;
    } catch (e) {
      return hex;
    }
  }

  // ===== 초기화 =====
  function init() {
    document.getElementById('btnMonth').addEventListener('click', () => setView('month'));
    document.getElementById('btnWeek').addEventListener('click', () => setView('week'));
    document.getElementById('btnDay').addEventListener('click', () => setView('day'));

    document.getElementById('btnPrev').addEventListener('click', () => navigateCalendar(-1));
    document.getElementById('btnNext').addEventListener('click', () => navigateCalendar(1));
    document.getElementById('btnToday').addEventListener('click', goToToday);

    document.getElementById('btnSettings').addEventListener('click', toggleSettings);
    document.getElementById('btnAddCalendar').addEventListener('click', addCalendar);
    document.getElementById('btnReloadCalendars').addEventListener('click', reloadCalendar);

    document.getElementById('accentColorPicker').addEventListener('input', updateColorFromPicker);
    document.getElementById('accentColorText').addEventListener('input', updateColorFromText);
    document.getElementById('btnApplyAccent').addEventListener('click', setAccentColor);

    loadFromStorage();
    updateCurrentDateDisplay();
    renderCalendar();
  }

  // ===== 설정 패널 =====
  function toggleSettings() {
    const panel = document.getElementById('settingsPanel');
    const hidden = panel.style.display === 'none' || panel.style.display === '';
    panel.style.display = hidden ? 'block' : 'none';
    panel.setAttribute('aria-hidden', String(!hidden));
  }

  // ===== 뷰 전환 & 날짜 네비게이션 =====
  function setView(view) {
    currentView = view;
    document.getElementById('btnMonth').classList.toggle('active', view === 'month');
    document.getElementById('btnWeek').classList.toggle('active', view === 'week');
    document.getElementById('btnDay').classList.toggle('active', view === 'day');
    renderCalendar();
  }

  function navigateCalendar(step) {
    if (currentView === 'month') {
      currentDate.setMonth(currentDate.getMonth() + step);
    } else if (currentView === 'week') {
      currentDate.setDate(currentDate.getDate() + step * 7);
    } else if (currentView === 'day') {
      currentDate.setDate(currentDate.getDate() + step);
    }
    updateCurrentDateDisplay();
    renderCalendar();
  }

  function goToToday() {
    currentDate = new Date();
    updateCurrentDateDisplay();
    renderCalendar();
  }

  function updateCurrentDateDisplay() {
    const options = { year: 'numeric', month: 'long' };
    if (currentView === 'month') {
      currentDateElement.textContent = currentDate.toLocaleDateString('ko-KR', options);
    } else if (currentView === 'week') {
      // 주간: 시작~끝
      const start = new Date(currentDate);
      const end = new Date(currentDate);
      start.setDate(currentDate.getDate() - currentDate.getDay());
      end.setDate(start.getDate() + 6);
      const format = (d) => d.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' });
      currentDateElement.textContent = `${format(start)} ~ ${format(end)}`;
    } else {
      const options2 = { month: 'long', day: 'numeric', weekday: 'short' };
      const formatted = currentDate.toLocaleDateString('ko-KR', options2);
      currentDateElement.textContent = formatted.replace(/(\d+일)\s*(\([^)]+\))/, '$1 $2');
    }
  }

  // ===== 캘린더 목록/색상/저장 =====
  function updateCalendarInputs() {
    const listEl = document.getElementById('calendarList');
    listEl.innerHTML = '';

    calendars.forEach((cal, idx) => {
      const row = document.createElement('div');
      row.className = 'calendar-item';

      const color = document.createElement('div');
      color.className = 'calendar-color';
      color.style.background = cal.color || '#9e9e9e';

      const name = document.createElement('div');
      name.textContent = cal.name || '(이름 없음)';

      const badge = document.createElement('div');
      badge.innerHTML = `<span class="badge">${cal.type}</span>`;

      const status = document.createElement('select');
      status.innerHTML = `<option value="visible">표시</option><option value="hidden">숨김</option>`;
      status.value = cal.status || 'visible';
      status.addEventListener('change', (e) => updateCalendarStatus(idx, e.target.value));

      const removeBtn = document.createElement('button');
      removeBtn.textContent = '✕';
      removeBtn.className = 'danger';
      removeBtn.addEventListener('click', () => removeCalendar(idx));

      row.append(color, name, badge, status, removeBtn);
      listEl.appendChild(row);
    });
  }

  function setAccentColor() {
    const val = document.getElementById('accentColorText').value.trim();
    if (!/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(val)) {
      alert('올바른 HEX 색상을 입력하세요. 예: #4285f4');
      return;
    }
    document.documentElement.style.setProperty('--accent-color', val);
    addDebugLog(`포인트 컬러 적용: ${val}`);
  }
  function updateColorFromPicker(e) {
    document.getElementById('accentColorText').value = e.target.value;
  }
  function updateColorFromText(e) {
    document.getElementById('accentColorPicker').value = e.target.value;
  }

  function addCalendar() {
    const type = document.getElementById('calendarType').value;
    const name = document.getElementById('calendarName').value.trim() || '캘린더';
    const url = document.getElementById('calendarUrl').value.trim();
    const color = document.getElementById('calendarColor').value.trim() || '#64b5f6';

    if (!url) {
      alert('URL을 입력하세요');
      return;
    }

    calendars.push({ type, name, url, color, status: 'visible' });
    saveToStorage();
    updateCalendarInputs();
    loadCalendarEvents();
    addDebugLog(`캘린더 추가: ${name} (${type})`);
  }

  function updateCalendarStatus(idx, status) {
    calendars[idx].status = status;
    saveToStorage();
    renderCalendar();
  }

  function removeCalendar(idx) {
    const removed = calendars.splice(idx, 1);
    saveToStorage();
    updateCalendarInputs();
    loadCalendarEvents();
    addDebugLog(`캘린더 삭제: ${removed[0]?.name || ''}`);
  }

  function saveToStorage() {
    localStorage.setItem('calendars', JSON.stringify(calendars));
  }
  function loadFromStorage() {
    const raw = localStorage.getItem('calendars');
    calendars = raw ? JSON.parse(raw) : [];
    updateCalendarInputs();
    loadCalendarEvents();
  }

  // ===== 이벤트 로딩 =====
  async function loadCalendarEvents() {
    eventsCache = [];
    clearDebugLog();

    for (const cal of calendars) {
      if (cal.status === 'hidden') continue;
      try {
        addDebugLog(`로드 시도: ${cal.name} (${cal.type})`);
        if (cal.type === 'ics') {
          await loadIcalEvents(cal);
        } else if (cal.type === 'google') {
          await loadGooglePublicEvents(cal);
        } else if (cal.type === 'api') {
          await loadApiEvents(cal);
        }
      } catch (e) {
        addDebugLog(`오류: ${e?.message || e}`);
      }
    }

    renderCalendar();
  }

  async function loadIcalEvents(cal) {
    const res = await fetch(cal.url);
    if (!res.ok) throw new Error('ICS 로드 실패');
    const text = await res.text();
    const events = parseIcalData(text, cal);
    eventsCache.push(...events);
    addDebugLog(`${cal.name}: ${events.length}개 이벤트`);
  }

  // 구글 공개 캘린더: "https://calendar.google.com/calendar/ical/.../public/basic.ics" 도 ics로 처리 가능
  async function loadGooglePublicEvents(cal) {
    return loadIcalEvents(cal);
  }

  async function loadApiEvents(cal) {
    const res = await fetch(cal.url);
    if (!res.ok) throw new Error('API 로드 실패');
    const data = await res.json();
    // 예시: [{title, start, end, allDay}]
    const events = (data || []).map(ev => ({
      title: ev.title,
      date: ev.allDay ? new Date(ev.start) : new Date(ev.start),
      startTime: ev.allDay ? null : new Date(ev.start).toTimeString().slice(0,5),
      endTime: ev.allDay ? null : new Date(ev.end).toTimeString().slice(0,5),
      time: ev.allDay ? '종일' : `${new Date(ev.start).toTimeString().slice(0,5)} - ${new Date(ev.end).toTimeString().slice(0,5)}`,
      color: cal.color || '#64b5f6',
      calendarName: cal.name,
      allDay: !!ev.allDay,
    }));
    eventsCache.push(...events);
    addDebugLog(`${cal.name}: ${events.length}개 이벤트(API)`);
  }

  // ===== ICS 파서 =====
  function parseIcalData(icsText, cal) {
    // 간단 파서 (RRULE/반복 제외)
    const lines = decodeIcalText(icsText).split(/\r?\n/);
    const events = [];
    let cur = null;

    const pushEvent = () => {
      if (!cur) return;
      const start = parseIcalDate(cur.DTSTART);
      const end = parseIcalDate(cur.DTEND || cur.DTSTART);
      const isAllDay = /VALUE=DATE/.test(cur.DTSTART || '') || (!cur.DTSTART && !cur.DTEND);

      const ev = {
        title: cur.SUMMARY || '(제목 없음)',
        date: start,
        startTime: isAllDay ? null : start.toTimeString().slice(0,5),
        endTime: isAllDay ? null : end.toTimeString().slice(0,5),
        time: isAllDay ? '종일' : `${start.toTimeString().slice(0,5)} - ${end.toTimeString().slice(0,5)}`,
        color: cal.color || '#64b5f6',
        calendarName: cal.name,
        allDay: isAllDay,
      };
      events.push(ev);
      cur = null;
    };

    for (let raw of lines) {
      const line = raw.trim();
      if (line === 'BEGIN:VEVENT') {
        cur = {};
      } else if (line === 'END:VEVENT') {
        pushEvent();
      } else if (cur) {
        const idx = line.indexOf(':');
        if (idx > -1) {
          const key = line.slice(0, idx);
          const val = line.slice(idx + 1);
          const shortKey = key.split(';')[0];
          cur[shortKey] = val;
        }
      }
    }

    return events;
  }

  function decodeIcalText(text) {
    // unfold
    const unfolded = text.replace(/\r?\n[ \t]/g, '');
    return unfolded;
  }

  function parseIcalDate(v) {
    if (!v) return new Date();
    // 예: 20250130T090000Z 또는 20250130T090000
    const tz = v.endsWith('Z');
    const m = v.match(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z?/);
    if (m) {
      const [_, y, mo, d, h, mi, s] = m;
      if (tz) {
        return new Date(Date.UTC(+y, +mo - 1, +d, +h, +mi, +s));
      }
      return new Date(+y, +mo - 1, +d, +h, +mi, +s);
    }
    // all-day (YYYYMMDD)
    const m2 = v.match(/(\d{4})(\d{2})(\d{2})/);
    if (m2) {
      const [_, y, mo, d] = m2;
      return new Date(+y, +mo - 1, +d);
    }
    return new Date(v);
  }

  // ===== 렌더링 =====
  function renderCalendar() {
    if (currentView === 'month') {
      renderMonthView();
    } else if (currentView === 'week') {
      renderWeekView();
    } else {
      renderDayView();
    }
  }

  function renderMonthView() {
    const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
    const grid = document.createElement('div');
    grid.className = 'calendar-grid month-view';

    // 헤더
    weekdays.forEach(day => {
      const header = document.createElement('div');
      header.className = 'weekday-name';
      header.textContent = day;
      grid.appendChild(header);
    });

    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const startDay = new Date(firstDay);
    startDay.setDate(1 - firstDay.getDay());

    for (let i = 0; i < 42; i++) {
      const cellDate = new Date(startDay);
      cellDate.setDate(startDay.getDate() + i);

      const cell = document.createElement('div');
      cell.className = 'calendar-cell';

      const dayNumber = document.createElement('div');
      dayNumber.className = 'date-number';
      dayNumber.textContent = cellDate.getDate();
      cell.appendChild(dayNumber);

      const dayEvents = getAllEventsForDate(cellDate);
      const maxShow = 4;
      dayEvents.slice(0, maxShow).forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event';
        eventDiv.style.background = darkenColor(event.color, 0.1);
        eventDiv.textContent = event.title;
        eventDiv.title = `${event.title}\n시간: ${event.time}\n캘린더: ${event.calendarName}`;
        cell.appendChild(eventDiv);
      });

      if (dayEvents.length > maxShow) {
        const moreDiv = document.createElement('div');
        moreDiv.className = 'more-events';
        moreDiv.textContent = `+${dayEvents.length - maxShow}개 더`;
        cell.appendChild(moreDiv);
      }

      grid.appendChild(cell);
    }

    calendarContent.innerHTML = '';
    calendarContent.appendChild(grid);
  }

  function renderWeekView() {
    const startOfWeek = new Date(currentDate);
    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

    const grid = document.createElement('div');
    grid.className = 'calendar-grid week-view';

    // 시간 헤더
    const timeHeader = document.createElement('div');
    timeHeader.className = 'week-header time-header';
    timeHeader.textContent = '시간';
    grid.appendChild(timeHeader);

    // 요일 헤더
    const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
    for (let i = 0; i < 7; i++) {
      const date = new Date(startOfWeek);
      date.setDate(startOfWeek.getDate() + i);

      const header = document.createElement('div');
      header.className = 'week-header';
      header.innerHTML = `${weekdays[i]}<br><small>${date.getDate()}</small>`;
      grid.appendChild(header);
    }

    // 시간 슬롯 (6시-23시)
    for (let hour = 6; hour <= 23; hour++) {
      const timeSlot = document.createElement('div');
      timeSlot.className = 'time-slot';
      timeSlot.textContent = `${hour}:00`;
      grid.appendChild(timeSlot);

      for (let day = 0; day < 7; day++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + day);

        const cell = document.createElement('div');
        cell.className = 'week-day';

        const dayEvents = getAllEventsForDate(date);
        dayEvents.forEach(event => {
          const startHour = getEventHour(event.startTime);
          const endHour = getEventHour(event.endTime);

          if (event.time === '종일') {
            if (hour === 6) {
              const eventDiv = document.createElement('div');
              eventDiv.className = 'event';
              eventDiv.style.backgroundColor = event.color;
              eventDiv.textContent = event.title;
              eventDiv.title = `${event.title}\n시간: ${event.time}\n캘린더: ${event.calendarName}`;
              eventDiv.style.top = '0px';
              eventDiv.style.height = '36px';
              cell.appendChild(eventDiv);
            }
          } else if (startHour <= hour && hour < endHour) {
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event';
            eventDiv.style.backgroundColor = event.color;
            eventDiv.textContent = hour === startHour ? event.title : '';
            eventDiv.title = `${event.title}\n시간: ${event.startTime} - ${event.endTime}\n캘린더: ${event.calendarName}`;

            if (hour === startHour) {
              const startMinute = getEventMinute(event.startTime);
              eventDiv.style.top = `${startMinute * 40 / 60}px`;
            } else {
              eventDiv.style.top = '0px';
            }

            if (hour === endHour - 1) {
              const endMinute = getEventMinute(event.endTime);
              eventDiv.style.height = `${40 - (endMinute * 40 / 60)}px`;
            } else {
              eventDiv.style.height = '36px';
            }

            cell.appendChild(eventDiv);
          }
        });

        grid.appendChild(cell);
      }
    }

    calendarContent.innerHTML = '';
    calendarContent.appendChild(grid);
  }

  function renderDayView() {
    const grid = document.createElement('div');
    grid.className = 'calendar-grid day-view';

    // 헤더
    const timeHeader = document.createElement('div');
    timeHeader.className = 'week-header time-header';
    timeHeader.textContent = '시간';
    grid.appendChild(timeHeader);

    const dayHeader = document.createElement('div');
    dayHeader.className = 'week-header';
    const options = { month: 'long', day: 'numeric', weekday: 'short' };
    const formatted = currentDate.toLocaleDateString('ko-KR', options);
    dayHeader.textContent = formatted.replace(/(\d+일)\s*(\([^)]+\))/, '$1 $2');
    grid.appendChild(dayHeader);

    // 시간 슬롯 (6시-23시)
    for (let hour = 6; hour <= 23; hour++) {
      const timeSlot = document.createElement('div');
      timeSlot.className = 'time-slot';
      timeSlot.textContent = `${hour}:00`;
      grid.appendChild(timeSlot);

      const cell = document.createElement('div');
      cell.className = 'week-day';

      const dayEvents = getAllEventsForDate(currentDate);
      dayEvents.forEach(event => {
        const startHour = getEventHour(event.startTime);
        const endHour = getEventHour(event.endTime);

        if (event.time === '종일') {
          if (hour === 6) {
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event';
            eventDiv.style.backgroundColor = event.color;
            eventDiv.textContent = event.title;
            eventDiv.title = `${event.title}\n시간: ${event.time}\n캘린더: ${event.calendarName}`;
            eventDiv.style.top = '0px';
            eventDiv.style.height = '36px';
            cell.appendChild(eventDiv);
          }
        } else if (startHour <= hour && hour < endHour) {
          const eventDiv = document.createElement('div');
          eventDiv.className = 'event';
          eventDiv.style.backgroundColor = event.color;
          eventDiv.textContent = hour === startHour ? event.title : '';
          eventDiv.title = `${event.title}\n시간: ${event.startTime} - ${event.endTime}\n캘린더: ${event.calendarName}`;

          if (hour === startHour) {
            const startMinute = getEventMinute(event.startTime);
            eventDiv.style.top = `${startMinute * 40 / 60}px`;
          } else {
            eventDiv.style.top = '0px';
          }

          if (hour === endHour - 1) {
            const endMinute = getEventMinute(event.endTime);
            eventDiv.style.height = `${40 - (endMinute * 40 / 60)}px`;
          } else {
            eventDiv.style.height = '36px';
          }

          cell.appendChild(eventDiv);
        }
      });

      grid.appendChild(cell);
    }

    calendarContent.innerHTML = '';
    calendarContent.appendChild(grid);
  }

  // ===== 헬퍼 =====
  function getEventHour(t) {
    if (!t) return 0;
    const h = parseInt(t.split(':')[0], 10);
    return Number.isFinite(h) ? h : 0;
  }
  function getEventMinute(t) {
    if (!t) return 0;
    const m = parseInt(t.split(':')[1], 10);
    return Number.isFinite(m) ? m : 0;
  }
  function getAllEventsForDate(date) {
    const y = date.getFullYear();
    const m = date.getMonth();
    const d = date.getDate();
    return eventsCache.filter(ev => {
      const evDate = new Date(ev.date);
      return evDate.getFullYear() === y && evDate.getMonth() === m && evDate.getDate() === d;
    });
  }

  // ===== 시작 =====
  init();
</script>
</body>
</html>
