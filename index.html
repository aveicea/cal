<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>멀티 캘린더 뷰어</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #ffffff;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  
  .header {
    padding: 10px 20px;
    background: #fff;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
  }
  
  .view-selector {
    display: flex;
    gap: 8px;
    align-items: center;
    flex: 1;
    justify-content: center;
  }
  
  .view-btn {
    padding: 6px 12px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #666;
  }
  
  .view-btn.active {
    background: var(--accent-color, #4285f4);
    color: white;
    border-color: var(--accent-color, #4285f4);
  }
  
  .nav-controls {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-right: 20px;
  }
  
  .nav-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .nav-btn:hover {
    background: #f8f9fa;
  }
  
  .current-date {
    padding: 6px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    color: #333;
    min-width: 120px;
    text-align: center;
  }
  
  .settings-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: #f8f9fa;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    transition: all 0.2s ease;
  }
  
  .settings-btn:hover {
    background: #e8eaed;
    color: #333;
  }
  
  .settings-panel {
    position: absolute;
    top: 45px;
    right: 20px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    width: 450px;
    z-index: 1000;
    display: none;
    max-height: 70vh;
    overflow-y: auto;
  }
  
  .settings-title {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 15px;
    color: #333;
  }
  
  .color-picker-group {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .color-picker-title {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 10px;
    color: #333;
  }
  
  .color-input-row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .color-picker-input {
    width: 40px;
    height: 30px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    padding: 0;
  }
  
  .color-text-input {
    flex: 1;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 12px;
    font-family: monospace;
  }
  
  .preset-colors {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 4px;
  }
  
  .preset-color {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .preset-color:hover {
    transform: scale(1.1);
    border-color: #333;
  }
  
  .calendar-list-section {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .calendar-item {
    display: flex;
    align-items: center;
    padding: 8px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    margin-bottom: 8px;
    background: #f8f9fa;
  }
  
  .calendar-item.active {
    border-color: var(--accent-color, #4285f4);
    background: #e3f2fd;
  }
  
  .calendar-color {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    margin-right: 8px;
    border: 2px solid white;
    box-shadow: 0 0 0 1px #ddd;
  }
  
  .calendar-info {
    flex: 1;
  }
  
  .calendar-name {
    font-size: 13px;
    font-weight: 500;
    color: #333;
  }
  
  .calendar-url {
    font-size: 11px;
    color: #666;
    word-break: break-all;
    margin-top: 2px;
  }

  .calendar-status {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    margin-top: 2px;
    display: inline-block;
  }

  .calendar-status.success {
    background: #e8f5e8;
    color: #2e7d32;
  }

  .calendar-status.error {
    background: #ffebee;
    color: #c62828;
  }

  .calendar-status.loading {
    background: #e3f2fd;
    color: #1976d2;
  }
  
  .calendar-actions {
    display: flex;
    gap: 4px;
  }
  
  .toggle-btn {
    width: 20px;
    height: 20px;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.2s ease;
  }
  
  .toggle-btn.visible {
    background: var(--accent-color, #4285f4);
    color: white;
  }
  
  .toggle-btn.hidden {
    background: #ccc;
    color: white;
  }
  
  .remove-btn {
    background: #f44336;
    color: white;
  }

  .reload-btn {
    background: #ff9800;
    color: white;
    font-size: 10px;
  }
  
  .add-calendar-section {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .input-group {
    margin-bottom: 10px;
  }
  
  .input-group label {
    display: block;
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
  }
  
  .input-group input, .input-group textarea, .input-group select {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 12px;
    box-sizing: border-box;
    resize: vertical;
  }
  
  .help-text {
    font-size: 11px;
    color: #888;
    margin-top: 4px;
    line-height: 1.4;
  }
  
  .btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-right: 8px;
    margin-bottom: 8px;
  }
  
  .btn-primary {
    background: var(--accent-color, #4285f4);
    color: white;
  }
  
  .btn-primary:hover {
    background: var(--accent-hover-color, #3367d6);
  }
  
  .btn-secondary {
    background: #f8f9fa;
    color: #666;
    border: 1px solid #ddd;
  }
  
  .calendar-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .calendar-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #f8f9fa;
  }
  
  .calendar-grid {
    display: grid;
    gap: 1px;
    background: #e0e0e0;
    border: 1px solid #e0e0e0;
  }
  
  .calendar-day {
    background: white;
    min-height: 100px;
    padding: 8px;
    position: relative;
  }
  
  .calendar-day.other-month {
    background: #f8f9fa;
    color: #999;
  }
  
  .calendar-day.today {
    background: #e3f2fd;
  }
  
  .day-number {
    font-weight: 500;
    margin-bottom: 4px;
  }
  
  .event {
    padding: 2px 4px;
    border-radius: 2px;
    font-size: 11px;
    margin-bottom: 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: white;
    cursor: pointer;
  }
  
  .week-view {
    display: grid;
    grid-template-columns: 60px repeat(7, 1fr);
    gap: 1px;
    background: #e0e0e0;
  }
  
  .time-slot {
    background: white;
    padding: 4px;
    font-size: 12px;
    color: #666;
    border-right: 1px solid #e0e0e0;
  }
  
  .week-day {
    background: white;
    min-height: 60px;
    position: relative;
  }
  
  .week-header {
    background: #f5f5f5;
    padding: 8px;
    font-weight: 500;
    text-align: center;
    font-size: 14px;
  }
  
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: #666;
  }
  
  .error-message {
    background: #ffebee;
    border: 1px solid #ffcdd2;
    border-radius: 8px;
    padding: 16px;
    margin: 20px;
    color: #c62828;
    font-size: 12px;
  }
  
  .setup-message {
    background: white;
    border-radius: 12px;
    padding: 40px;
    margin: 40px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }
  
  .setup-icon {
    font-size: 48px;
    margin-bottom: 16px;
  }
  
  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.1);
    z-index: 999;
    display: none;
  }

  .debug-section {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
  }

  .debug-log {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 10px;
    font-family: monospace;
    font-size: 11px;
    max-height: 200px;
    overflow-y: auto;
    margin-top: 10px;
  }
  
  @media (max-width: 768px) {
    .settings-panel {
      right: 10px;
      left: 10px;
      width: auto;
    }
    .nav-controls {
      margin-right: 10px;
    }
    .calendar-grid {
      grid-template-columns: repeat(7, 1fr);
    }
    .calendar-day {
      min-height: 80px;
    }
  }
  
  /* 월간 뷰 */
  .month-view {
    grid-template-columns: repeat(7, 1fr);
  }
  
  /* 주간 뷰 헤더 */
  .week-view .week-header {
    grid-column: span 1;
  }
  
  .week-view .time-header {
    background: #f5f5f5;
    grid-column: 1;
  }
  
  .url-example {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 8px;
    font-family: monospace;
    font-size: 11px;
    color: #666;
    margin-top: 8px;
    word-break: break-all;
  }
</style>
</head>
<body>
  <div class="header">
    <div class="view-selector">
      <button class="view-btn active" onclick="setView('month')" id="monthBtn">월간</button>
      <button class="view-btn" onclick="setView('week')" id="weekBtn">주간</button>
      <button class="view-btn" onclick="setView('day')" id="dayBtn">일간</button>
    </div>
    
    <div class="nav-controls">
      <button class="nav-btn" onclick="navigateCalendar(-1)">‹</button>
      <div class="current-date" id="currentDate"></div>
      <button class="nav-btn" onclick="navigateCalendar(1)">›</button>
      <button class="nav-btn" onclick="goToToday()">오늘</button>
    </div>
    
    <button class="settings-btn" onclick="toggleSettings()">⚙️</button>
    
    <div class="settings-panel" id="settingsPanel">
      <div class="settings-title">멀티 캘린더 설정</div>
      
      <div class="color-picker-group">
        <div class="color-picker-title">테마 색상</div>
        <div class="color-input-row">
          <input type="color" class="color-picker-input" id="colorPicker" onchange="updateColorFromPicker()">
          <input type="text" class="color-text-input" id="colorText" placeholder="#4285F4" oninput="updateColorFromText()" maxlength="7">
        </div>
        <div class="preset-colors">
          <div class="preset-color" style="background-color: #4285f4;" onclick="setPresetColor('#4285f4')"></div>
          <div class="preset-color" style="background-color: #34a853;" onclick="setPresetColor('#34a853')"></div>
          <div class="preset-color" style="background-color: #ea4335;" onclick="setPresetColor('#ea4335')"></div>
          <div class="preset-color" style="background-color: #fbbc04;" onclick="setPresetColor('#fbbc04')"></div>
          <div class="preset-color" style="background-color: #9c27b0;" onclick="setPresetColor('#9c27b0')"></div>
          <div class="preset-color" style="background-color: #ff6d00;" onclick="setPresetColor('#ff6d00')"></div>
          <div class="preset-color" style="background-color: #607d8b;" onclick="setPresetColor('#607d8b')"></div>
          <div class="preset-color" style="background-color: #795548;" onclick="setPresetColor('#795548')"></div>
          <div class="preset-color" style="background-color: #e91e63;" onclick="setPresetColor('#e91e63')"></div>
          <div class="preset-color" style="background-color: #00bcd4;" onclick="setPresetColor('#00bcd4')"></div>
          <div class="preset-color" style="background-color: #8bc34a;" onclick="setPresetColor('#8bc34a')"></div>
          <div class="preset-color" style="background-color: #ffc107;" onclick="setPresetColor('#ffc107')"></div>
        </div>
      </div>
      
      <div class="calendar-list-section">
        <div class="color-picker-title">연동된 캘린더 목록</div>
        <div id="calendarList">
          <p style="color: #666; font-size: 12px; text-align: center; padding: 20px;">
            연동된 캘린더가 없습니다.<br>아래에서 캘린더를 추가해보세요!
          </p>
        </div>
      </div>
      
      <div class="add-calendar-section">
        <div class="color-picker-title">캘린더 추가</div>
        <div class="input-group">
          <label>캘린더 유형</label>
          <select id="calendarType" onchange="updateCalendarInputs()">
            <option value="ical">iCal 링크 (.ics)</option>
            <option value="googlePublic">구글 캘린더 공개 링크</option>
            <option value="api">구글 캘린더 API</option>
          </select>
        </div>
        
        <div class="input-group">
          <label>캘린더 이름</label>
          <input type="text" id="calendarName" placeholder="예: 개인 일정, 업무 캘린더">
        </div>
        
        <div class="input-group">
          <label>캘린더 색상</label>
          <input type="color" id="calendarColor" value="#4285f4">
        </div>
        
        <div id="icalInputs" class="calendar-inputs">
          <div class="input-group">
            <label>iCal 링크</label>
            <textarea id="icalUrl" rows="3" placeholder="https://calendar.google.com/calendar/ical/.../basic.ics"></textarea>
            <div class="help-text">
              구글 캘린더 설정 → 통합 및 공유 → 비공개 주소의 iCal 링크를 복사하세요.
            </div>
          </div>
        </div>
        
        <div id="googlePublicInputs" class="calendar-inputs" style="display: none;">
          <div class="input-group">
            <label>구글 캘린더 ID</label>
            <input type="text" id="googleCalendarId" placeholder="캘린더ID@group.calendar.google.com">
            <div class="help-text">
              공개된 구글 캘린더의 캘린더 ID를 입력하세요.<br>
              예: ko.south_korea#holiday@group.v.calendar.google.com (한국 공휴일)
            </div>
          </div>
        </div>
        
        <div id="apiInputs" class="calendar-inputs" style="display: none;">
          <div class="input-group">
            <label>API 키</label>
            <input type="text" id="apiKey" placeholder="Google Calendar API 키">
          </div>
          <div class="input-group">
            <label>캘린더 ID</label>
            <input type="text" id="calendarId" placeholder="primary 또는 이메일@gmail.com">
          </div>
        </div>
        
        <button class="btn btn-primary" onclick="addCalendar()">캘린더 추가</button>
        <button class="btn btn-secondary" onclick="addSampleCalendar()">샘플 캘린더 추가</button>
      </div>

      <div class="debug-section">
        <div class="color-picker-title">디버그 정보</div>
        <button class="btn btn-secondary" onclick="clearDebugLog()">로그 지우기</button>
        <div id="debugLog" class="debug-log"></div>
      </div>
    </div>
  </div>
  
  <div class="overlay" id="overlay" onclick="closeSettings()"></div>
  
  <div class="calendar-container">
    <div class="calendar-content" id="calendarContent">
      <div class="setup-message">
        <div class="setup-icon">🗓️</div>
        <h2>멀티 캘린더 뷰어</h2>
        <p>여러 캘린더를 한 화면에서 함께 확인하세요!</p>
        <p style="font-size: 14px; color: #666; margin-top: 16px;">
          우상단 설정 버튼을 클릭하여 캘린더를 추가해보세요.<br>
          <strong>iCal 링크</strong>, <strong>구글 캘린더 공개</strong>, <strong>API 연동</strong> 모두 지원합니다.
        </p>
      </div>
    </div>
  </div>

<script>
  // 전역 변수
  let currentView = 'month';
  let currentDate = new Date();
  let accentColor = '#4285f4';
  let accentHoverColor = '#3367d6';
  let calendars = [];
  let debugMessages = [];
  
  // 캘린더 색상 팔레트
  const calendarColors = [
    '#4285f4', '#34a853', '#ea4335', '#fbbc04', '#9c27b0', '#ff6d00',
    '#607d8b', '#795548', '#e91e63', '#00bcd4', '#8bc34a', '#ffc107'
  ];
  
  // DOM 요소
  const settingsPanel = document.getElementById("settingsPanel");
  const overlay = document.getElementById("overlay");
  const colorPicker = document.getElementById("colorPicker");
  const colorText = document.getElementById("colorText");
  const currentDateElement = document.getElementById("currentDate");
  const calendarContent = document.getElementById("calendarContent");
  const calendarList = document.getElementById("calendarList");
  const debugLog = document.getElementById("debugLog");
  
  // 디버그 로그 함수
  function addDebugLog(message) {
    const timestamp = new Date().toLocaleTimeString();
    debugMessages.push(`[${timestamp}] ${message}`);
    if (debugMessages.length > 50) debugMessages.shift();
    
    debugLog.innerHTML = debugMessages.map(msg => `<div>${msg}</div>`).join('');
    debugLog.scrollTop = debugLog.scrollHeight;
    console.log(message);
  }

  function clearDebugLog() {
    debugMessages = [];
    debugLog.innerHTML = '';
  }
  
  // 초기화
  function init() {
    loadFromStorage();
    updateCurrentDateDisplay();
    setAccentColor(accentColor);
    updateCalendarList();
    renderCalendar();
    addDebugLog('캘린더 뷰어가 시작되었습니다.');
  }
  
  // 설정 패널
  function toggleSettings() {
    const isVisible = settingsPanel.style.display === 'block';
    if (isVisible) {
      closeSettings();
    } else {
      openSettings();
    }
  }
  
  function openSettings() {
    settingsPanel.style.display = 'block';
    overlay.style.display = 'block';
  }
  
  function closeSettings() {
    settingsPanel.style.display = 'none';
    overlay.style.display = 'none';
  }
  
  // 뷰 변경
  function setView(viewMode) {
    currentView = viewMode;
    document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(viewMode + 'Btn').classList.add('active');
    updateCurrentDateDisplay();
    renderCalendar();
    saveToStorage();
  }
  
  // 날짜 네비게이션
  function navigateCalendar(direction) {
    if (currentView === 'month') {
      currentDate.setMonth(currentDate.getMonth() + direction);
    } else if (currentView === 'week') {
      currentDate.setDate(currentDate.getDate() + (direction * 7));
    } else if (currentView === 'day') {
      currentDate.setDate(currentDate.getDate() + direction);
    }
    updateCurrentDateDisplay();
    renderCalendar();
  }
  
  function goToToday() {
    currentDate = new Date();
    updateCurrentDateDisplay();
    renderCalendar();
  }
  
  function updateCurrentDateDisplay() {
    const options = { year: 'numeric', month: 'long', locale: 'ko-KR' };
    if (currentView === 'day') {
      options.day = 'numeric';
      options.weekday = 'long';
    }
    currentDateElement.textContent = currentDate.toLocaleDateString('ko-KR', options);
  }
  
  // 색상 관리
  function darkenColor(hex, percent) {
    const num = parseInt(hex.replace("#", ""), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) - amt;
    const G = (num >> 8 & 0x00FF) - amt;
    const B = (num & 0x0000FF) - amt;
    return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
      (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
      (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
  }
  
  function setAccentColor(color) {
    accentColor = color;
    accentHoverColor = darkenColor(color, 15);
    
    document.documentElement.style.setProperty('--accent-color', color);
    document.documentElement.style.setProperty('--accent-hover-color', accentHoverColor);
    
    colorPicker.value = color;
    colorText.value = color.toUpperCase();
    
    saveToStorage();
  }
  
  function setPresetColor(color) {
    setAccentColor(color);
  }
  
  function updateColorFromPicker() {
    setAccentColor(colorPicker.value);
  }
  
  function updateColorFromText() {
    let color = colorText.value.trim();
    if (!color.startsWith('#')) color = '#' + color;
    if (/^#[0-9A-F]{6}$/i.test(color)) {
      setAccentColor(color);
    }
  }
  
  // 캘린더 입력 폼 업데이트
  function updateCalendarInputs() {
    const type = document.getElementById('calendarType').value;
    
    document.querySelectorAll('.calendar-inputs').forEach(input => {
      input.style.display = 'none';
    });
    
    document.getElementById(type + 'Inputs').style.display = 'block';
  }
  
  // 캘린더 상태 업데이트
  function updateCalendarStatus(calendarId, status, message = '') {
    const calendar = calendars.find(c => c.id === calendarId);
    if (calendar) {
      calendar.status = status;
      calendar.statusMessage = message;
      updateCalendarList();
    }
  }
  
  // 캘린더 추가
  async function addCalendar() {
    const type = document.getElementById('calendarType').value;
    const name = document.getElementById('calendarName').value.trim();
    const color = document.getElementById('calendarColor').value;
    
    if (!name) {
      alert('캘린더 이름을 입력해주세요.');
      return;
    }
    
    let url = '';
    let calendarId = '';
    let apiKey = '';
    
    if (type === 'ical') {
      url = document.getElementById('icalUrl').value.trim();
      if (!url || !url.includes('.ics')) {
        alert('올바른 iCal 링크를 입력해주세요.');
        return;
      }
    } else if (type === 'googlePublic') {
      calendarId = document.getElementById('googleCalendarId').value.trim();
      if (!calendarId) {
        alert('구글 캘린더 ID를 입력해주세요.');
        return;
      }
    } else if (type === 'api') {
      apiKey = document.getElementById('apiKey').value.trim();
      calendarId = document.getElementById('calendarId').value.trim() || 'primary';
      if (!apiKey) {
        alert('API 키를 입력해주세요.');
        return;
      }
    }
    
    const calendar = {
      id: Date.now().toString(),
      name: name,
      type: type,
      color: color,
      visible: true,
      url: url,
      calendarId: calendarId,
      apiKey: apiKey,
      events: [],
      status: 'loading',
      statusMessage: '로딩 중...'
    };
    
    addDebugLog(`캘린더 추가 시작: ${name} (${type})`);
    
    calendars.push(calendar);
    updateCalendarList();
    
    // 캘린더 데이터 로드
    try {
      await loadCalendarEvents(calendar);
      updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}개 이벤트`);
      addDebugLog(`캘린더 로드 성공: ${name}, ${calendar.events.length}개 이벤트`);
      renderCalendar();
      saveToStorage();
      
      // 입력 폼 초기화
      document.getElementById('calendarName').value = '';
      document.getElementById('icalUrl').value = '';
      document.getElementById('googleCalendarId').value = '';
      document.getElementById('apiKey').value = '';
      document.getElementById('calendarId').value = '';
      
      closeSettings();
    } catch (error) {
      updateCalendarStatus(calendar.id, 'error', error.message);
      addDebugLog(`캘린더 로드 실패: ${name} - ${error.message}`);
      alert('캘린더를 불러오는데 실패했습니다: ' + error.message);
    }
  }
  
  // 샘플 캘린더 추가
  function addSampleCalendar() {
    const sampleCalendar = {
      id: Date.now().toString(),
      name: '샘플 캘린더',
      type: 'sample',
      color: calendarColors[calendars.length % calendarColors.length],
      visible: true,
      url: '',
      events: generateSampleEvents(),
      status: 'success',
      statusMessage: '샘플 데이터'
    };
    
    calendars.push(sampleCalendar);
    updateCalendarList();
    renderCalendar();
    saveToStorage();
    addDebugLog(`샘플 캘린더 추가됨: ${sampleCalendar.events.length}개 이벤트`);
    closeSettings();
  }
  
  // 캘린더 이벤트 로드
  async function loadCalendarEvents(calendar) {
    addDebugLog(`이벤트 로드 시작: ${calendar.name} (${calendar.type})`);
    
    if (calendar.type === 'ical') {
      await loadIcalEvents(calendar);
    } else if (calendar.type === 'googlePublic') {
      await loadGooglePublicEvents(calendar);
    } else if (calendar.type === 'api') {
      await loadApiEvents(calendar);
    }
  }
  
  // iCal 이벤트 로드
  async function loadIcalEvents(calendar) {
    const proxies = [
      `https://cors-anywhere.herokuapp.com/${calendar.url}`,
      `https://api.allorigins.win/get?url=${encodeURIComponent(calendar.url)}`,
      `https://corsproxy.io/?${encodeURIComponent(calendar.url)}`,
      `https://cors.sh/${calendar.url}`,
      `https://proxy.cors.sh/${calendar.url}`
    ];
    
    let lastError = null;
    
    for (const proxyUrl of proxies) {
      try {
        addDebugLog(`프록시 시도: ${proxyUrl.split('/')[2]}`);
        
        const response = await fetch(proxyUrl, {
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        let icalData;
        if (proxyUrl.includes('allorigins')) {
          const data = await response.json();
          icalData = data.contents;
        } else {
          icalData = await response.text();
        }
        
        if (!icalData || !icalData.includes('BEGIN:VCALENDAR')) {
          throw new Error('유효하지 않은 iCal 데이터');
        }
        
        calendar.events = parseIcalData(icalData);
        addDebugLog(`iCal 파싱 완료: ${calendar.events.length}개 이벤트`);
        return;
        
      } catch (error) {
        lastError = error;
        addDebugLog(`프록시 실패: ${proxyUrl.split('/')[2]} - ${error.message}`);
        continue;
      }
    }
    
    throw new Error(`모든 프록시 실패. 마지막 오류: ${lastError.message}`);
  }
  
  // 구글 공개 캘린더 로드
  async function loadGooglePublicEvents(calendar) {
    const timeMin = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1).toISOString();
    const timeMax = new Date(currentDate.getFullYear(), currentDate.getMonth() + 2, 0).toISOString();
    
    // 공개 API 키 (제한적이지만 공개 캘린더용)
    const apiKey = 'AIzaSyBNlYH01_9Hc5S1J9vuFmu2nUqBZJNAXxs'; // 데모용 키
    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendar.calendarId)}/events?key=${apiKey}&timeMin=${timeMin}&timeMax=${timeMax}&orderBy=startTime&singleEvents=true`;
    
    try {
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`API 오류: ${response.status} - ${response.statusText}`);
      }
      
      const data = await response.json();
      
      if (!data.items) {
        throw new Error('이벤트 데이터가 없습니다');
      }
      
      calendar.events = data.items.map(event => {
        const startDate = event.start.dateTime || event.start.date;
        const date = new Date(startDate);
        
        return {
          title: event.summary || '제목 없음',
          date: date.toISOString().split('T')[0],
          time: event.start.dateTime ? 
            date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
            '종일',
          color: calendar.color,
          description: event.description || ''
        };
      });
      
      addDebugLog(`구글 공개 캘린더 로드 완료: ${calendar.events.length}개 이벤트`);
      
    } catch (error) {
      addDebugLog(`구글 공개 캘린더 로드 실패: ${error.message}`);
      throw error;
    }
  }
  
  // API 이벤트 로드
  async function loadApiEvents(calendar) {
    const timeMin = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1).toISOString();
    const timeMax = new Date(currentDate.getFullYear(), currentDate.getMonth() + 2, 0).toISOString();
    
    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendar.calendarId)}/events?key=${calendar.apiKey}&timeMin=${timeMin}&timeMax=${timeMax}&orderBy=startTime&singleEvents=true`;
    
    try {
      const response = await fetch(url);
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(`API 오류 ${response.status}: ${errorData.error?.message || response.statusText}`);
      }
      
      const data = await response.json();
      
      calendar.events = data.items.map(event => {
        const startDate = event.start.dateTime || event.start.date;
        const date = new Date(startDate);
        
        return {
          title: event.summary || '제목 없음',
          date: date.toISOString().split('T')[0],
          time: event.start.dateTime ? 
            date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
            '종일',
          color: calendar.color,
          description: event.description || ''
        };
      });
      
      addDebugLog(`API 캘린더 로드 완료: ${calendar.events.length}개 이벤트`);
      
    } catch (error) {
      addDebugLog(`API 캘린더 로드 실패: ${error.message}`);
      throw error;
    }
  }
  
  // iCal 데이터 파싱 함수 (개선된 버전)
  function parseIcalData(icalText) {
    const events = [];
    const lines = icalText.split(/\r?\n/);
    let currentEvent = null;
    
    addDebugLog(`iCal 파싱 시작: ${lines.length}줄`);
    
    for (let i = 0; i < lines.length; i++) {
      let line = lines[i].trim();
      
      // 멀티라인 처리
      while (i + 1 < lines.length && lines[i + 1].match(/^\s/)) {
        i++;
        line += lines[i].trim();
      }
      
      if (line === 'BEGIN:VEVENT') {
        currentEvent = {};
      } else if (line === 'END:VEVENT' && currentEvent) {
        if (currentEvent.summary && currentEvent.dtstart) {
          events.push({
            title: currentEvent.summary,
            date: currentEvent.date,
            time: currentEvent.time || '종일',
            description: currentEvent.description || ''
          });
        }
        currentEvent = null;
      } else if (currentEvent) {
        const colonIndex = line.indexOf(':');
        if (colonIndex > 0) {
          const key = line.substring(0, colonIndex).split(';')[0];
          const value = line.substring(colonIndex + 1);
          
          switch (key) {
            case 'SUMMARY':
              currentEvent.summary = decodeIcalText(value);
              break;
            case 'DESCRIPTION':
              currentEvent.description = decodeIcalText(value);
              break;
            case 'DTSTART':
              const startDate = parseIcalDate(value);
              if (startDate) {
                currentEvent.dtstart = startDate.date;
                currentEvent.date = startDate.date;
                currentEvent.time = startDate.time;
              }
              break;
          }
        }
      }
    }
    
    addDebugLog(`iCal 파싱 완료: ${events.length}개 이벤트 추출`);
    return events;
  }
  
  // iCal 텍스트 디코딩
  function decodeIcalText(text) {
    return text
      .replace(/\\n/g, ' ')
      .replace(/\\,/g, ',')
      .replace(/\\;/g, ';')
      .replace(/\\\\/g, '\\')
      .trim();
  }
  
  // iCal 날짜 파싱 함수 (개선된 버전)
  function parseIcalDate(dateString) {
    try {
      // YYYYMMDD 형식 (종일 이벤트)
      if (dateString.length === 8) {
        const year = parseInt(dateString.substring(0, 4));
        const month = parseInt(dateString.substring(4, 6));
        const day = parseInt(dateString.substring(6, 8));
        const date = new Date(year, month - 1, day);
        return {
          date: date.toISOString().split('T')[0],
          time: '종일'
        };
      }
      
      // YYYYMMDDTHHMMSS[Z] 형식 (시간 포함)
      if (dateString.length >= 15) {
        const year = parseInt(dateString.substring(0, 4));
        const month = parseInt(dateString.substring(4, 6));
        const day = parseInt(dateString.substring(6, 8));
        const hour = parseInt(dateString.substring(9, 11));
        const minute = parseInt(dateString.substring(11, 13));
        
        const date = new Date(year, month - 1, day, hour, minute);
        
        // UTC 시간인 경우 (Z로 끝남) 로컬 시간으로 변환
        if (dateString.endsWith('Z')) {
          const localDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
          return {
            date: localDate.toISOString().split('T')[0],
            time: localDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false })
          };
        }
        
        return {
          date: date.toISOString().split('T')[0],
          time: `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`
        };
      }
    } catch (e) {
      addDebugLog(`날짜 파싱 오류: ${dateString} - ${e.message}`);
    }
    return null;
  }
  
  // 캘린더 목록 업데이트
  function updateCalendarList() {
    if (calendars.length === 0) {
      calendarList.innerHTML = `
        <p style="color: #666; font-size: 12px; text-align: center; padding: 20px;">
          연동된 캘린더가 없습니다.<br>아래에서 캘린더를 추가해보세요!
        </p>
      `;
      return;
    }
    
    calendarList.innerHTML = calendars.map(calendar => `
      <div class="calendar-item ${calendar.visible ? 'active' : ''}" data-id="${calendar.id}">
        <div class="calendar-color" style="background-color: ${calendar.color}"></div>
        <div class="calendar-info">
          <div class="calendar-name">${calendar.name}</div>
          <div class="calendar-url">${calendar.type === 'sample' ? '샘플 데이터' : 
            (calendar.url || calendar.calendarId || '').substring(0, 30)}${(calendar.url || calendar.calendarId || '').length > 30 ? '...' : ''}</div>
          <div class="calendar-status ${calendar.status}">${calendar.statusMessage || calendar.status}</div>
        </div>
        <div class="calendar-actions">
          <button class="toggle-btn ${calendar.visible ? 'visible' : 'hidden'}" 
                  onclick="toggleCalendarVisibility('${calendar.id}')" 
                  title="${calendar.visible ? '숨기기' : '보이기'}">
            ${calendar.visible ? '👁️' : '🚫'}
          </button>
          <button class="toggle-btn reload-btn" onclick="reloadCalendar('${calendar.id}')" title="새로고침">🔄</button>
          <button class="toggle-btn remove-btn" onclick="removeCalendar('${calendar.id}')" title="삭제">❌</button>
        </div>
      </div>
    `).join('');
  }
  
  // 캘린더 새로고침
  async function reloadCalendar(calendarId) {
    const calendar = calendars.find(c => c.id === calendarId);
    if (!calendar || calendar.type === 'sample') return;
    
    updateCalendarStatus(calendarId, 'loading', '새로고침 중...');
    addDebugLog(`캘린더 새로고침: ${calendar.name}`);
    
    try {
      calendar.events = [];
      await loadCalendarEvents(calendar);
      updateCalendarStatus(calendarId, 'success', `${calendar.events.length}개 이벤트`);
      renderCalendar();
      saveToStorage();
      addDebugLog(`캘린더 새로고침 완료: ${calendar.name}`);
    } catch (error) {
      updateCalendarStatus(calendarId, 'error', error.message);
      addDebugLog(`캘린더 새로고침 실패: ${calendar.name} - ${error.message}`);
    }
  }
  
  // 캘린더 가시성 토글
  function toggleCalendarVisibility(calendarId) {
    const calendar = calendars.find(c => c.id === calendarId);
    if (calendar) {
      calendar.visible = !calendar.visible;
      updateCalendarList();
      renderCalendar();
      saveToStorage();
      addDebugLog(`캘린더 가시성 변경: ${calendar.name} - ${calendar.visible ? '보임' : '숨김'}`);
    }
  }
  
  // 캘린더 삭제
  function removeCalendar(calendarId) {
    const calendar = calendars.find(c => c.id === calendarId);
    if (calendar && confirm(`'${calendar.name}' 캘린더를 삭제하시겠습니까?`)) {
      calendars = calendars.filter(c => c.id !== calendarId);
      updateCalendarList();
      renderCalendar();
      saveToStorage();
      addDebugLog(`캘린더 삭제됨: ${calendar.name}`);
    }
  }
  
  // 캘린더 렌더링
  function renderCalendar() {
    if (calendars.length === 0) {
      calendarContent.innerHTML = `
        <div class="setup-message">
          <div class="setup-icon">🗓️</div>
          <h2>멀티 캘린더 뷰어</h2>
          <p>여러 캘린더를 한 화면에서 함께 확인하세요!</p>
          <p style="font-size: 14px; color: #666; margin-top: 16px;">
            우상단 설정 버튼을 클릭하여 캘린더를 추가해보세요.<br>
            <strong>iCal 링크</strong>, <strong>구글 캘린더 공개</strong>, <strong>API 연동</strong> 모두 지원합니다.
          </p>
        </div>
      `;
      return;
    }
    
    if (currentView === 'month') {
      renderMonthView();
    } else if (currentView === 'week') {
      renderWeekView();
    } else if (currentView === 'day') {
      renderDayView();
    }
  }
  
  function renderMonthView() {
    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const grid = document.createElement('div');
    grid.className = 'calendar-grid month-view';
    
    // 요일 헤더
    const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
    weekdays.forEach(day => {
      const header = document.createElement('div');
      header.className = 'week-header';
      header.textContent = day;
      grid.appendChild(header);
    });
    
    // 날짜 셀
    const today = new Date();
    for (let i = 0; i < 42; i++) {
      const cellDate = new Date(startDate);
      cellDate.setDate(startDate.getDate() + i);
      
      const cell = document.createElement('div');
      cell.className = 'calendar-day';
      
      if (cellDate.getMonth() !== currentDate.getMonth()) {
        cell.classList.add('other-month');
      }
      
      if (cellDate.toDateString() === today.toDateString()) {
        cell.classList.add('today');
      }
      
      const dayNumber = document.createElement('div');
      dayNumber.className = 'day-number';
      dayNumber.textContent = cellDate.getDate();
      cell.appendChild(dayNumber);
      
      // 모든 캘린더의 이벤트 표시
      const dayEvents = getAllEventsForDate(cellDate);
      dayEvents.slice(0, 4).forEach(event => { // 최대 4개만 표시
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event';
        eventDiv.style.backgroundColor = event.color;
        eventDiv.textContent = event.title;
        eventDiv.title = `${event.title}\n시간: ${event.time}\n캘린더: ${event.calendarName}${event.description ? '\n설명: ' + event.description : ''}`;
        cell.appendChild(eventDiv);
      });
      
      // 더 많은 이벤트가 있으면 표시
      if (dayEvents.length > 4) {
        const moreDiv = document.createElement('div');
        moreDiv.className = 'event';
        moreDiv.style.backgroundColor = '#999';
        moreDiv.textContent = `+${dayEvents.length - 4}개 더`;
        cell.appendChild(moreDiv);
      }
      
      grid.appendChild(cell);
    }
    
    calendarContent.innerHTML = '';
    calendarContent.appendChild(grid);
  }
  
  function renderWeekView() {
    const startOfWeek = new Date(currentDate);
    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
    
    const grid = document.createElement('div');
    grid.className = 'calendar-grid week-view';
    
    // 시간 헤더
    const timeHeader = document.createElement('div');
    timeHeader.className = 'week-header time-header';
    timeHeader.textContent = '시간';
    grid.appendChild(timeHeader);
    
    // 요일 헤더
    const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
    for (let i = 0; i < 7; i++) {
      const date = new Date(startOfWeek);
      date.setDate(startOfWeek.getDate() + i);
      
      const header = document.createElement('div');
      header.className = 'week-header';
      header.innerHTML = `${weekdays[i]}<br><small>${date.getDate()}</small>`;
      grid.appendChild(header);
    }
    
    // 시간 슬롯 (6시-23시)
    for (let hour = 6; hour <= 23; hour++) {
      const timeSlot = document.createElement('div');
      timeSlot.className = 'time-slot';
      timeSlot.textContent = `${hour}:00`;
      grid.appendChild(timeSlot);
      
      for (let day = 0; day < 7; day++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + day);
        
        const cell = document.createElement('div');
        cell.className = 'week-day';
        
        const dayEvents = getAllEventsForDate(date).filter(event => {
          if (event.time === '종일') return hour === 6;
          const eventHour = parseInt(event.time.split(':')[0]);
          return eventHour === hour;
        });
        
        dayEvents.forEach(event => {
          const eventDiv = document.createElement('div');
          eventDiv.className = 'event';
          eventDiv.style.backgroundColor = event.color;
          eventDiv.textContent = event.title;
          eventDiv.title = `${event.title}\n시간: ${event.time}\n캘린더: ${event.calendarName}`;
          cell.appendChild(eventDiv);
        });
        
        grid.appendChild(cell);
      }
    }
    
    calendarContent.innerHTML = '';
    calendarContent.appendChild(grid);
  }
  
  function renderDayView() {
    const grid = document.createElement('div');
    grid.className = 'calendar-grid week-view';
    grid.style.gridTemplateColumns = '60px 1fr';
    
    // 헤더
    const timeHeader = document.createElement('div');
    timeHeader.className = 'week-header';
    timeHeader.textContent = '시간';
    grid.appendChild(timeHeader);
    
    const dayHeader = document.createElement('div');
    dayHeader.className = 'week-header';
    dayHeader.textContent = currentDate.toLocaleDateString('ko-KR', { 
      weekday: 'long', 
      month: 'long', 
      day: 'numeric' 
    });
    grid.appendChild(dayHeader);
    
    // 시간 슬롯 (6시-23시)
    for (let hour = 6; hour <= 23; hour++) {
      const timeSlot = document.createElement('div');
      timeSlot.className = 'time-slot';
      timeSlot.textContent = `${hour}:00`;
      grid.appendChild(timeSlot);
      
      const cell = document.createElement('div');
      cell.className = 'week-day';
      cell.style.minHeight = '60px';
      
      const dayEvents = getAllEventsForDate(currentDate).filter(event => {
        if (event.time === '종일') return hour === 6;
        const eventHour = parseInt(event.time.split(':')[0]);
        return eventHour === hour;
      });
      
      dayEvents.forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event';
        eventDiv.style.backgroundColor = event.color;
        eventDiv.textContent = event.title;
        eventDiv.title = `${event.title}\n시간: ${event.time}\n캘린더: ${event.calendarName}`;
        cell.appendChild(eventDiv);
      });
      
      grid.appendChild(cell);
    }
    
    calendarContent.innerHTML = '';
    calendarContent.appendChild(grid);
  }
  
  // 모든 캘린더의 특정 날짜 이벤트 가져오기
  function getAllEventsForDate(date) {
    const allEvents = [];
    
    calendars.forEach(calendar => {
      if (!calendar.visible || !calendar.events) return;
      
      const events = calendar.events.filter(event => {
        const eventDate = new Date(event.date + 'T00:00:00');
        return eventDate.toDateString() === date.toDateString();
      });
      
      events.forEach(event => {
        allEvents.push({
          ...event,
          color: calendar.color,
          calendarName: calendar.name
        });
      });
    });
    
    // 시간순 정렬
    allEvents.sort((a, b) => {
      if (a.time === '종일' && b.time !== '종일') return -1;
      if (a.time !== '종일' && b.time === '종일') return 1;
      if (a.time === '종일' && b.time === '종일') return 0;
      return a.time.localeCompare(b.time);
    });
    
    return allEvents;
  }
  
  // 샘플 이벤트 생성
  function generateSampleEvents() {
    const events = [];
    const today = new Date();
    
    // 이번 달의 샘플 이벤트들
    for (let i = 0; i < 20; i++) {
      const eventDate = new Date(today.getFullYear(), today.getMonth(), Math.floor(Math.random() * 28) + 1);
      const hour = Math.floor(Math.random() * 12) + 9; // 9시-20시
      const minute = Math.random() > 0.5 ? '00' : '30';
      
      const sampleTitles = [
        '팀 미팅', '프로젝트 리뷰', '클라이언트 미팅', '프레젠테이션', '워크숍',
        '교육 세션', '점심 약속', '병원 예약', '개인 시간', '운동',
        '독서 모임', '쇼핑', '영화 관람', '친구 만남', '가족 시간',
        '회의', '브레인스토밍', '코드 리뷰', '출장', '컨퍼런스'
      ];
      
      events.push({
        title: sampleTitles[Math.floor(Math.random() * sampleTitles.length)],
        date: eventDate.toISOString().split('T')[0],
        time: Math.random() > 0.2 ? `${hour.toString().padStart(2, '0')}:${minute}` : '종일',
        description: '샘플 이벤트입니다.'
      });
    }
    
    return events;
  }
  
  // 저장/불러오기
  function saveToStorage() {
    try {
      const data = JSON.stringify({
        view: currentView,
        accentColor: accentColor,
        accentHoverColor: accentHoverColor,
        calendars: calendars.map(cal => ({
          ...cal,
          // 샘플이 아닌 캘린더는 이벤트를 저장하지 않음 (다시 로드)
          events: cal.type === 'sample' ? cal.events : []
        }))
      });
      
      // 메모리에 저장 (localStorage 대신)
      window.calendarStorage = data;
      addDebugLog('설정이 메모리에 저장되었습니다.');
    } catch (e) {
      addDebugLog(`저장 실패: ${e.message}`);
    }
  }
  
  function loadFromStorage() {
    if (window.calendarStorage) {
      try {
        const data = JSON.parse(window.calendarStorage);
        currentView = data.view || 'month';
        accentColor = data.accentColor || '#4285f4';
        accentHoverColor = data.accentHoverColor || darkenColor(accentColor, 15);
        calendars = data.calendars || [];
        
        // UI 복원
        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(currentView + 'Btn').classList.add('active');
        
        // 저장된 캘린더들의 이벤트 다시 로드 (샘플 제외)
        calendars.forEach(async (calendar) => {
          if (calendar.type !== 'sample') {
            updateCalendarStatus(calendar.id, 'loading', '로딩 중...');
            try {
              await loadCalendarEvents(calendar);
              updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}개 이벤트`);
            } catch (error) {
              updateCalendarStatus(calendar.id, 'error', error.message);
              addDebugLog(`저장된 캘린더 로드 실패: ${calendar.name} - ${error.message}`);
            }
          }
        });
        
        addDebugLog('설정이 메모리에서 복원되었습니다.');
      } catch (e) {
        addDebugLog(`불러오기 실패: ${e.message}`);
      }
    }
  }
  
  // 초기화 실행
  init();
  
  // 키보드 단축키
  document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    switch(e.key) {
      case 'ArrowLeft':
        navigateCalendar(-1);
        e.preventDefault();
        break;
      case 'ArrowRight':
        navigateCalendar(1);
        e.preventDefault();
        break;
      case 't':
      case 'T':
        goToToday();
        break;
      case 'm':
      case 'M':
        setView('month');
        break;
      case 'w':
      case 'W':
        setView('week');
        break;
      case 'd':
      case 'D':
        setView('day');
        break;
      case 'Escape':
        closeSettings();
        break;
    }
  });
  
  // 캘린더 색상 자동 할당
  document.getElementById('calendarColor').addEventListener('focus', function() {
    this.value = calendarColors[calendars.length % calendarColors.length];
  });
  
  // 한국 공휴일 샘플 추가
  function addKoreanHolidays() {
    const holidayCalendar = {
      id: 'korean-holidays-' + Date.now(),
      name: '한국 공휴일',
      type: 'googlePublic',
      color: '#ea4335',
      visible: true,
      calendarId: 'ko.south_korea#holiday@group.v.calendar.google.com',
      events: [],
      status: 'loading',
      statusMessage: '로딩 중...'
    };
    
    calendars.push(holidayCalendar);
    updateCalendarList();
    
    loadCalendarEvents(holidayCalendar)
      .then(() => {
        updateCalendarStatus(holidayCalendar.id, 'success', `${holidayCalendar.events.length}개 이벤트`);
        renderCalendar();
        saveToStorage();
        addDebugLog('한국 공휴일 캘린더 추가 완료');
      })
      .catch(error => {
        updateCalendarStatus(holidayCalendar.id, 'error', error.message);
        addDebugLog(`한국 공휴일 캘린더 추가 실패: ${error.message}`);
      });
  }
  
  // 디버그용 함수들
  window.debugCalendar = {
    showCalendars: () => console.table(calendars),
    showEvents: (calendarId) => {
      const calendar = calendars.find(c => c.id === calendarId || c.name === calendarId);
      if (calendar) {
        console.table(calendar.events);
      } else {
        console.log('캘린더를 찾을 수 없습니다.');
      }
    },
    clearStorage: () => {
      delete window.calendarStorage;
      location.reload();
    },
    addKoreanHolidays: addKoreanHolidays
  };
  
  // 도움말 표시
  console.log('%c멀티 캘린더 뷰어 디버그 도구%c\n' +
    'debugCalendar.showCalendars() - 모든 캘린더 정보 표시\n' +
    'debugCalendar.showEvents(캘린더ID) - 특정 캘린더의 이벤트 표시\n' +
    'debugCalendar.clearStorage() - 저장된 데이터 삭제 및 새로고침\n' +
    'debugCalendar.addKoreanHolidays() - 한국 공휴일 캘린더 추가', 
    'color: #4285f4; font-weight: bold; font-size: 14px;', 
    'color: #333; font-size: 12px;');
</script>
</body>
</html>
