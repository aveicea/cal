// 공통 상수 (24시간 기준으로 변경)
const SLOT_START_HOUR = 6;  // 오전 6시 시작
const TOTAL_HOURS = 24;     // 24시간 표시
const SLOT_COUNT = TOTAL_HOURS;

const weekdays = ['일', '월', '화', '수', '목', '금', '토'];

// 시간 표시 헬퍼 함수 (24시간 -> 실제 시간 변환)
function getDisplayHour(slotIndex) {
  const hour = (SLOT_START_HOUR + slotIndex) % 24;
  return hour;
}

// 실제 시간 -> 슬롯 인덱스 변환
function getSlotIndex(hour) {
  if (hour >= SLOT_START_HOUR) {
    return hour - SLOT_START_HOUR;  // 6-23시: 0-17
  } else {
    return hour + (24 - SLOT_START_HOUR);  // 0-5시: 18-23
  }
}

// 시간을 정확한 슬롯 위치로 변환 (분 단위까지 고려)
function getExactSlotPosition(hour, minute) {
  const slotIndex = getSlotIndex(hour);
  return slotIndex + (minute / 60);
}

// 이벤트가 이틀에 걸치는지 확인하고 분할
function splitCrossDayEvent(event) {
  if (event.time === '종일') return [event];
  
  const startHour = getEventHour(event.startTime);
  const endHour = getEventHour(event.endTime);
  const startMinute = getEventMinute(event.startTime);
  const endMinute = getEventMinute(event.endTime);
  
  const startPosition = getExactSlotPosition(startHour, startMinute);
  const endPosition = getExactSlotPosition(endHour, endMinute);
  
  // 이틀에 걸치지 않는 경우
  if (startPosition < endPosition) {
    return [event];
  }
  
  // 이틀에 걸치는 경우 - 분할
  const events = [];
  
  // 첫째 날 부분 (시작시간 ~ 5:59:59)
  if (startHour >= SLOT_START_HOUR) {
    events.push({
      ...event,
      endTime: '05:59',
      title: event.title,
      isFirstPart: true
    });
  }
  
  // 둘째 날 부분 (6:00 ~ 종료시간)
  if (endHour < SLOT_START_HOUR) {
    events.push({
      ...event,
      startTime: '06:00',
      title: event.title,
      isSecondPart: true,
      isNextDay: true
    });
  }
  
  return events;
}

// 주간 뷰 렌더링 (24시간 버전)
function renderWeekView() {
  const startOfWeek = new Date(currentDate);
  startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

  const container = document.createElement('div');
  container.style.padding = '20px';
  container.style.height = '100%';
  container.style.overflow = 'auto';

  const grid = document.createElement('div');
  grid.className = 'time-based-view week-view';
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = `80px repeat(7, 1fr)`;
  grid.style.gridTemplateRows = `40px repeat(${SLOT_COUNT}, 50px)`;
  grid.style.gap = '0';

  // 시간 헤더
  const timeHeader = document.createElement('div');
  timeHeader.className = 'week-header';
  timeHeader.textContent = '시간';
  timeHeader.style.gridRow = '1';
  timeHeader.style.gridColumn = '1';
  timeHeader.style.border = '1px solid #e0e0e0';
  timeHeader.style.backgroundColor = '#f5f5f5';
  timeHeader.style.padding = '8px';
  timeHeader.style.textAlign = 'center';
  grid.appendChild(timeHeader);

  // 요일 헤더
  for (let i = 0; i < 7; i++) {
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + i);

    const header = document.createElement('div');
    header.className = 'week-header';
    header.style.gridRow = '1';
    header.style.gridColumn = `${i + 2}`;
    header.style.border = '1px solid #e0e0e0';
    header.style.backgroundColor = '#f5f5f5';
    header.style.padding = '8px';
    header.style.textAlign = 'center';

    if (date.toDateString() === (new Date()).toDateString()) {
      header.style.backgroundColor = '#e3f2fd';
    }

    const dayName = document.createElement('div');
    dayName.textContent = weekdays[i];
    dayName.style.fontWeight = 'bold';
    header.appendChild(dayName);

    const dayNumber = document.createElement('div');
    dayNumber.textContent = date.getDate();
    dayNumber.style.fontSize = '0.9em';
    dayNumber.style.color = '#666';
    header.appendChild(dayNumber);

    grid.appendChild(header);
  }

  // 24시간 슬롯 생성
  for (let slotIndex = 0; slotIndex < SLOT_COUNT; slotIndex++) {
    const displayHour = getDisplayHour(slotIndex);
    
    // 시간 라벨
    const timeSlot = document.createElement('div');
    timeSlot.className = 'time-slot';
    timeSlot.textContent = `${displayHour.toString().padStart(2, '0')}:00`;
    timeSlot.style.gridRow = `${slotIndex + 2}`;
    timeSlot.style.gridColumn = '1';
    timeSlot.style.border = '1px solid #e0e0e0';
    timeSlot.style.padding = '8px';
    timeSlot.style.fontSize = '0.8em';
    timeSlot.style.textAlign = 'center';
    timeSlot.style.backgroundColor = '#fafafa';
    grid.appendChild(timeSlot);

    // 각 요일별 기본 배경
    for (let day = 0; day < 7; day++) {
      const cell = document.createElement('div');
      cell.className = 'day-cell';
      cell.style.gridRow = `${slotIndex + 2}`;
      cell.style.gridColumn = `${day + 2}`;
      cell.style.border = '1px solid #e0e0e0';
      cell.style.position = 'relative';
      cell.style.backgroundColor = 'white';
      
      // 자정 이후 시간대는 다른 스타일
      if (slotIndex >= 18) {
        cell.style.backgroundColor = '#f9f9f9';
      }
      
      grid.appendChild(cell);
    }
  }

  // 이벤트 렌더링
  for (let day = 0; day < 7; day++) {
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + day);

    const dayEvents = getAllEventsForDate(date);
    let eventIndex = 0;
    
    dayEvents.forEach((event) => {
      const splitEvents = splitCrossDayEvent(event);
      
      splitEvents.forEach((splitEvent) => {
        if (splitEvent.isNextDay) return;
        
        if (splitEvent.time === '종일') {
          const eventDiv = document.createElement('div');
          eventDiv.className = 'all-day-event';
          eventDiv.style.gridRow = '2';
          eventDiv.style.gridColumn = `${day + 2}`;
          eventDiv.style.backgroundColor = event.color;
          eventDiv.style.color = 'white';
          eventDiv.style.padding = '4px 8px';
          eventDiv.style.fontSize = '0.8em';
          eventDiv.style.borderRadius = '4px';
          eventDiv.style.margin = '2px';
          eventDiv.style.overflow = 'hidden';
          eventDiv.style.textOverflow = 'ellipsis';
          eventDiv.style.whiteSpace = 'nowrap';
          eventDiv.textContent = splitEvent.title;
          eventDiv.title = `${splitEvent.title}\n캘린더: ${event.calendarName}`;
          grid.appendChild(eventDiv);
        } else {
          const startHour = getEventHour(splitEvent.startTime);
          const endHour = getEventHour(splitEvent.endTime);
          const startMinute = getEventMinute(splitEvent.startTime);
          const endMinute = getEventMinute(splitEvent.endTime);

          const startPosition = getExactSlotPosition(startHour, startMinute);
          const endPosition = getExactSlotPosition(endHour, endMinute);
          
          // 그리드 범위 제한
          const clampedEndPosition = Math.min(endPosition, SLOT_COUNT);

          const eventDiv = document.createElement('div');
          eventDiv.className = 'time-event';
          eventDiv.style.gridRow = `${Math.floor(startPosition) + 2}`;
          eventDiv.style.gridColumn = `${day + 2}`;
          eventDiv.style.backgroundColor = event.color;
          eventDiv.style.color = 'white';
          eventDiv.style.padding = '2px 6px';
          eventDiv.style.fontSize = '0.75em';
          eventDiv.style.borderRadius = '3px';
          eventDiv.style.overflow = 'hidden';
          eventDiv.style.textOverflow = 'ellipsis';
          eventDiv.style.whiteSpace = 'nowrap';
          eventDiv.style.position = 'absolute';
          eventDiv.style.zIndex = eventIndex + 1;
          
          // 정확한 위치와 높이 계산
          const cellHeight = 50; // 그리드 행 높이
          const topOffset = (startPosition - Math.floor(startPosition)) * cellHeight;
          const height = (clampedEndPosition - startPosition) * cellHeight;
          
          eventDiv.style.top = `${topOffset}px`;
          eventDiv.style.height = `${height}px`;
          eventDiv.style.left = `${eventIndex * 2}px`;
          eventDiv.style.right = `${eventIndex * 2}px`;
          
          eventDiv.textContent = splitEvent.title;
          eventDiv.title = `${splitEvent.title}\n시간: ${splitEvent.startTime} - ${splitEvent.endTime}\n캘린더: ${event.calendarName}`;

          // 부모 셀에 추가
          const parentCell = grid.querySelector(`[style*="grid-row: ${Math.floor(startPosition) + 2}"][style*="grid-column: ${day + 2}"]`);
          if (parentCell) {
            parentCell.appendChild(eventDiv);
          }
          
          eventIndex++;
        }
      });
    });
    
    // 다음날 새벽 이벤트 처리 (동일한 방식)
    const nextDate = new Date(date);
    nextDate.setDate(date.getDate() + 1);
    const nextDayEvents = getAllEventsForDate(nextDate);
    
    nextDayEvents.forEach((event) => {
      const splitEvents = splitCrossDayEvent(event);
      
      splitEvents.forEach((splitEvent) => {
        if (!splitEvent.isSecondPart) return;
        
        if (splitEvent.time !== '종일') {
          const startHour = getEventHour(splitEvent.startTime);
          const endHour = getEventHour(splitEvent.endTime);
          
          if (startHour < SLOT_START_HOUR || endHour < SLOT_START_HOUR) {
            const startMinute = getEventMinute(splitEvent.startTime);
            const endMinute = getEventMinute(splitEvent.endTime);

            const startPosition = getExactSlotPosition(startHour, startMinute);
            const endPosition = getExactSlotPosition(endHour, endMinute);

            const eventDiv = document.createElement('div');
            eventDiv.className = 'time-event';
            eventDiv.style.gridRow = `${Math.floor(startPosition) + 2}`;
            eventDiv.style.gridColumn = `${day + 2}`;
            eventDiv.style.backgroundColor = event.color;
            eventDiv.style.color = 'white';
            eventDiv.style.padding = '2px 6px';
            eventDiv.style.fontSize = '0.75em';
            eventDiv.style.borderRadius = '3px';
            eventDiv.style.overflow = 'hidden';
            eventDiv.style.textOverflow = 'ellipsis';
            eventDiv.style.whiteSpace = 'nowrap';
            eventDiv.style.position = 'absolute';
            eventDiv.style.zIndex = eventIndex + 1;
            
            const cellHeight = 50;
            const topOffset = (startPosition - Math.floor(startPosition)) * cellHeight;
            const height = (endPosition - startPosition) * cellHeight;
            
            eventDiv.style.top = `${topOffset}px`;
            eventDiv.style.height = `${height}px`;
            eventDiv.style.left = `${eventIndex * 2}px`;
            eventDiv.style.right = `${eventIndex * 2}px`;
            
            eventDiv.textContent = splitEvent.title;
            eventDiv.title = `${splitEvent.title}\n시간: ${splitEvent.startTime} - ${splitEvent.endTime}\n캘린더: ${event.calendarName}`;

            const parentCell = grid.querySelector(`[style*="grid-row: ${Math.floor(startPosition) + 2}"][style*="grid-column: ${day + 2}"]`);
            if (parentCell) {
              parentCell.appendChild(eventDiv);
            }
            
            eventIndex++;
          }
        }
      });
    });
  }

  container.appendChild(grid);
  calendarContent.innerHTML = '';
  calendarContent.appendChild(container);
}

// 일간 뷰도 동일한 방식으로 수정
function renderDayView() {
  const container = document.createElement('div');
  container.style.padding = '20px';
  container.style.height = '100%';
  container.style.overflow = 'auto';

  const grid = document.createElement('div');
  grid.className = 'time-based-view day-view';
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = `80px 1fr`;
  grid.style.gridTemplateRows = `40px repeat(${SLOT_COUNT}, 50px)`;
  grid.style.gap = '0';

  // 헤더들...
  const timeHeader = document.createElement('div');
  timeHeader.className = 'week-header';
  timeHeader.textContent = '시간';
  timeHeader.style.gridRow = '1';
  timeHeader.style.gridColumn = '1';
  timeHeader.style.border = '1px solid #e0e0e0';
  timeHeader.style.backgroundColor = '#f5f5f5';
  timeHeader.style.padding = '8px';
  timeHeader.style.textAlign = 'center';
  grid.appendChild(timeHeader);

  const dayHeader = document.createElement('div');
  dayHeader.className = 'week-header';
  const today = new Date();
  if (currentDate.toDateString() === today.toDateString()) {
    dayHeader.style.backgroundColor = '#e3f2fd';
  } else {
    dayHeader.style.backgroundColor = '#f5f5f5';
  }
  const options = { month: 'short', day: 'numeric', weekday: 'short' };
  const dayName = document.createElement('div');
  dayName.textContent = currentDate.toLocaleDateString('ko-KR', options);
  dayHeader.appendChild(dayName);
  dayHeader.style.gridRow = '1';
  dayHeader.style.gridColumn = '2';
  dayHeader.style.border = '1px solid #e0e0e0';
  dayHeader.style.padding = '8px';
  dayHeader.style.textAlign = 'center';
  grid.appendChild(dayHeader);

  // 24시간 슬롯
  for (let slotIndex = 0; slotIndex < SLOT_COUNT; slotIndex++) {
    const displayHour = getDisplayHour(slotIndex);
    
    const timeSlot = document.createElement('div');
    timeSlot.className = 'time-slot';
    timeSlot.textContent = `${displayHour.toString().padStart(2, '0')}:00`;
    timeSlot.style.gridRow = `${slotIndex + 2}`;
    timeSlot.style.gridColumn = '1';
    timeSlot.style.border = '1px solid #e0e0e0';
    timeSlot.style.padding = '8px';
    timeSlot.style.fontSize = '0.8em';
    timeSlot.style.textAlign = 'center';
    timeSlot.style.backgroundColor = '#fafafa';
    grid.appendChild(timeSlot);

    const cell = document.createElement('div');
    cell.className = 'day-cell';
    cell.style.gridRow = `${slotIndex + 2}`;
    cell.style.gridColumn = '2';
    cell.style.border = '1px solid #e0e0e0';
    cell.style.position = 'relative';
    cell.style.backgroundColor = 'white';
    
    if (slotIndex >= 18) {
      cell.style.backgroundColor = '#f9f9f9';
    }
    
    grid.appendChild(cell);
  }

  // 이벤트 처리 (주간뷰와 동일한 로직)
  const dayEvents = getAllEventsForDate(currentDate);
  let eventIndex = 0;
  
  dayEvents.forEach((event) => {
    const splitEvents = splitCrossDayEvent(event);
    
    splitEvents.forEach((splitEvent) => {
      if (splitEvent.isNextDay) return;
      
      if (splitEvent.time === '종일') {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'all-day-event';
        eventDiv.style.gridRow = '2';
        eventDiv.style.gridColumn = '2';
        eventDiv.style.backgroundColor = event.color;
        eventDiv.style.color = 'white';
        eventDiv.style.padding = '4px 8px';
        eventDiv.style.fontSize = '0.8em';
        eventDiv.style.borderRadius = '4px';
        eventDiv.style.margin = '2px';
        eventDiv.style.overflow = 'hidden';
        eventDiv.style.textOverflow = 'ellipsis';
        eventDiv.style.whiteSpace = 'nowrap';
        eventDiv.textContent = splitEvent.title;
        eventDiv.title = `${splitEvent.title}\n캘린더: ${event.calendarName}`;
        grid.appendChild(eventDiv);
      } else {
        const startHour = getEventHour(splitEvent.startTime);
        const endHour = getEventHour(splitEvent.endTime);
        const startMinute = getEventMinute(splitEvent.startTime);
        const endMinute = getEventMinute(splitEvent.endTime);

        const startPosition = getExactSlotPosition(startHour, startMinute);
        const endPosition = getExactSlotPosition(endHour, endMinute);
        
        const clampedEndPosition = Math.min(endPosition, SLOT_COUNT);

        const eventDiv = document.createElement('div');
        eventDiv.className = 'time-event';
        eventDiv.style.gridRow = `${Math.floor(startPosition) + 2}`;
        eventDiv.style.gridColumn = '2';
        eventDiv.style.backgroundColor = event.color;
        eventDiv.style.color = 'white';
        eventDiv.style.padding = '2px 6px';
        eventDiv.style.fontSize = '0.75em';
        eventDiv.style.borderRadius = '3px';
        eventDiv.style.overflow = 'hidden';
        eventDiv.style.textOverflow = 'ellipsis';
        eventDiv.style.whiteSpace = 'nowrap';
        eventDiv.style.position = 'absolute';
        eventDiv.style.zIndex = eventIndex + 1;
        
        const cellHeight = 50;
        const topOffset = (startPosition - Math.floor(startPosition)) * cellHeight;
        const height = (clampedEndPosition - startPosition) * cellHeight;
        
        eventDiv.style.top = `${topOffset}px`;
        eventDiv.style.height = `${height}px`;
        eventDiv.style.left = `${eventIndex * 2}px`;
        eventDiv.style.right = `${eventIndex * 2}px`;
        
        eventDiv.textContent = splitEvent.title;
        eventDiv.title = `${splitEvent.title}\n시간: ${splitEvent.startTime} - ${splitEvent.endTime}\n캘린더: ${event.calendarName}`;

        const parentCell = grid.querySelector(`[style*="grid-row: ${Math.floor(startPosition) + 2}"][style*="grid-column: 2"]`);
        if (parentCell) {
          parentCell.appendChild(eventDiv);
        }
        
        eventIndex++;
      }
    });
  });

  container.appendChild(grid);
  calendarContent.innerHTML = '';
  calendarContent.appendChild(container);
}

// 기존 헬퍼 함수들
function getEventHour(timeString) {
  if (timeString === '종일') return SLOT_START_HOUR;
  const parts = timeString.split(':');
  return parseInt(parts[0], 10) || 0;
}

function getEventMinute(timeString) {
  if (timeString === '종일') return 0;
  const parts = timeString.split(':');
  return parseInt(parts[1], 10) || 0;
}

function getAllEventsForDate(date) {
  const allEvents = [];
  calendars.forEach(calendar => {
    if (!calendar.visible || !calendar.events) return;
    const events = calendar.events.filter(event => {
      const eventDate = new Date(event.date + 'T00:00:00');
      return eventDate.toDateString() === date.toDateString();
    });
    events.forEach(event => {
      allEvents.push({
        ...event,
        color: calendar.color,
        calendarName: calendar.name
      });
    });
  });
  return allEvents;
}
