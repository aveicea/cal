<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>캘린더 뷰어</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #ffffff;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  
  .header {
    padding: 10px 20px;
    background: #fff;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
  }
  
  .view-selector {
    display: flex;
    gap: 8px;
    align-items: center;
    flex: 1;
    justify-content: center;
  }
  
  .view-btn {
    padding: 6px 12px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #666;
  }
  
  .view-btn.active {
    background: var(--accent-color, #4285f4);
    color: white;
    border-color: var(--accent-color, #4285f4);
  }
  
  .nav-controls {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-right: 20px;
  }
  
  .nav-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .nav-btn:hover {
    background: #f8f9fa;
  }
  
  .current-date {
    padding: 6px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    color: #333;
    min-width: 120px;
    text-align: center;
  }
  
  .settings-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: #f8f9fa;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    transition: all 0.2s ease;
  }
  
  .settings-btn:hover {
    background: #e8eaed;
    color: #333;
  }
  
  .settings-panel {
    position: absolute;
    top: 45px;
    right: 20px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    width: 380px;
    z-index: 1000;
    display: none;
    max-height: 70vh;
    overflow-y: auto;
  }
  
  .settings-title {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 15px;
    color: #333;
  }
  
  .color-picker-group {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .color-picker-title {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 10px;
    color: #333;
  }
  
  .color-input-row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .color-picker-input {
    width: 40px;
    height: 30px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    padding: 0;
  }
  
  .color-text-input {
    flex: 1;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 12px;
    font-family: monospace;
  }
  
  .preset-colors {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 4px;
  }
  
  .preset-color {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .preset-color:hover {
    transform: scale(1.1);
    border-color: #333;
  }
  
  .api-key-section, .embed-section, .ical-section, .proxy-section {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .input-group {
    margin-bottom: 10px;
  }
  
  .input-group label {
    display: block;
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
  }
  
  .input-group input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 12px;
    box-sizing: border-box;
  }
  
  .btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .btn + .btn { margin-left: 6px; }
  
  .btn-primary {
    background: var(--accent-color, #4285f4);
    color: white;
  }
  
  .btn-primary:hover {
    background: var(--accent-hover-color, #3367d6);
  }
  
  .btn-secondary {
    background: #f8f9fa;
    color: #666;
    border: 1px solid #ddd;
  }
  
  .calendar-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .calendar-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #f8f9fa;
  }
  
  .calendar-grid {
    display: grid;
    gap: 1px;
    background: #e0e0e0;
    border: 1px solid #e0e0e0;
  }
  
  .calendar-day {
    background: white;
    min-height: 100px;
    padding: 8px;
    position: relative;
  }
  
  .calendar-day.other-month {
    background: #f8f9fa;
    color: #999;
  }
  
  .calendar-day.today {
    background: #e3f2fd;
  }
  
  .day-number {
    font-weight: 500;
    margin-bottom: 4px;
  }
  
  .event {
    background: var(--accent-color, #4285f4);
    color: white;
    padding: 2px 4px;
    border-radius: 2px;
    font-size: 11px;
    margin-bottom: 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .week-view {
    display: grid;
    grid-template-columns: 60px repeat(7, 1fr);
    gap: 1px;
    background: #e0e0e0;
  }
  
  .time-slot {
    background: white;
    padding: 4px;
    font-size: 12px;
    color: #666;
    border-right: 1px solid #e0e0e0;
  }
  
  .week-day {
    background: white;
    min-height: 60px;
    position: relative;
  }
  
  .week-header {
    background: #f5f5f5;
    padding: 8px;
    font-weight: 500;
    text-align: center;
    font-size: 14px;
  }
  
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: #666;
  }
  
  .error-message {
    background: #ffebee;
    border: 1px solid #ffcdd2;
    border-radius: 8px;
    padding: 16px;
    margin: 20px;
    color: #c62828;
  }
  
  .info-message {
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 8px;
    padding: 12px;
    margin: 10px 0;
    color: #0d47a1;
    font-size: 12px;
  }
  
  .setup-message {
    background: white;
    border-radius: 12px;
    padding: 40px;
    margin: 40px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }
  
  .setup-icon {
    font-size: 48px;
    margin-bottom: 16px;
  }
  
  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.1);
    z-index: 999;
    display: none;
  }
  
  @media (max-width: 768px) {
    .settings-panel {
      right: 10px;
      left: 10px;
      width: auto;
    }
    .nav-controls {
      margin-right: 10px;
    }
    .calendar-grid {
      grid-template-columns: repeat(7, 1fr);
    }
    .calendar-day {
      min-height: 80px;
    }
  }
  
  /* 월간 뷰 */
  .month-view {
    grid-template-columns: repeat(7, 1fr);
  }
  
  /* 주간 뷰 헤더 */
  .week-view .week-header {
    grid-column: span 1;
  }
  
  .week-view .time-header {
    background: #f5f5f5;
    grid-column: 1;
  }
</style>
</head>
<body>
  <div class="header">
    <div class="view-selector">
      <button class="view-btn" onclick="setView('day')" id="dayBtn">일간</button>
      <button class="view-btn" onclick="setView('week')" id="weekBtn">주간</button>
      <button class="view-btn active" onclick="setView('month')" id="monthBtn">월간</button>
    </div>
    
    <div class="nav-controls">
      <button class="nav-btn" onclick="navigateCalendar(-1)">‹</button>
      <div class="current-date" id="currentDate"></div>
      <button class="nav-btn" onclick="navigateCalendar(1)">›</button>
      <button class="nav-btn" onclick="goToToday()">오늘</button>
    </div>
    
    <button class="settings-btn" onclick="toggleSettings()">⚙️</button>
    
    <div class="settings-panel" id="settingsPanel">
      <div class="settings-title">설정</div>
      
      <div class="color-picker-group">
        <div class="color-picker-title">테마 색상</div>
        <div class="color-input-row">
          <input type="color" class="color-picker-input" id="colorPicker" onchange="updateColorFromPicker()">
          <input type="text" class="color-text-input" id="colorText" placeholder="#4285F4" oninput="updateColorFromText()" maxlength="7">
        </div>
        <div class="preset-colors">
          <div class="preset-color" style="background-color: #4285f4;" onclick="setPresetColor('#4285f4')"></div>
          <div class="preset-color" style="background-color: #34a853;" onclick="setPresetColor('#34a853')"></div>
          <div class="preset-color" style="background-color: #ea4335;" onclick="setPresetColor('#ea4335')"></div>
          <div class="preset-color" style="background-color: #fbbc04;" onclick="setPresetColor('#fbbc04')"></div>
          <div class="preset-color" style="background-color: #9c27b0;" onclick="setPresetColor('#9c27b0')"></div>
          <div class="preset-color" style="background-color: #ff6d00;" onclick="setPresetColor('#ff6d00')"></div>
          <div class="preset-color" style="background-color: #607d8b;" onclick="setPresetColor('#607d8b')"></div>
          <div class="preset-color" style="background-color: #795548;" onclick="setPresetColor('#795548')"></div>
          <div class="preset-color" style="background-color: #e91e63;" onclick="setPresetColor('#e91e63')"></div>
          <div class="preset-color" style="background-color: #00bcd4;" onclick="setPresetColor('#00bcd4')"></div>
          <div class="preset-color" style="background-color: #8bc34a;" onclick="setPresetColor('#8bc34a')"></div>
          <div class="preset-color" style="background-color: #ffc107;" onclick="setPresetColor('#ffc107')"></div>
        </div>
      </div>

      <div class="info-message">
        🔹 iCal(ICS) 구독은 <b>공개 캘린더</b>여야 브라우저에서 직접 불러와집니다. <br>
        🔹 CORS가 막힌 경우 아래 <b>프록시 URL</b>을 사용하세요(선택).
      </div>

      <div class="proxy-section">
        <div class="color-picker-title">프록시(선택)</div>
        <div class="input-group">
          <label>프록시 URL (예: https://your-proxy.example.com?url= )</label>
          <input type="text" id="proxyUrl" placeholder="프록시 URL을 입력하면 CORS 우회 시도">
        </div>
      </div>
      
      <div class="ical-section">
        <div class="color-picker-title">iCal(ICS) 구독 추가</div>
        <div class="input-group">
          <label>iCal 캘린더 링크 또는 Google 캘린더 <em>embed</em> 링크</label>
          <input type="text" id="calendarUrl" placeholder="예) https://calendar.google.com/calendar/ical/.../public/basic.ics 또는 .../embed?src=...">
        </div>
        <button class="btn btn-primary" onclick="addSubscribedCalendar()">캘린더 구독 추가</button>
        <button class="btn btn-secondary" onclick="showSampleData()">샘플 데이터 보기</button>
      </div>

      <div class="api-key-section">
        <div class="color-picker-title">Google Calendar API로 불러오기 (선택)</div>
        <div class="input-group">
          <label>API Key</label>
          <input type="text" id="apiKey" placeholder="Google API 키">
        </div>
        <div class="input-group">
          <label>Calendar ID (예: primary 또는 someone@gmail.com)</label>
          <input type="text" id="calendarId" placeholder="primary">
        </div>
        <button class="btn btn-primary" onclick="loadCalendarData()">API로 현재 달 불러오기</button>
      </div>

      <div class="embed-section">
        <div class="color-picker-title">Google 캘린더 임베드 보기 (옵션)</div>
        <div class="input-group">
          <label>임베드 URL (…/calendar/embed?src=...)</label>
          <input type="text" id="embedUrl" placeholder="https://calendar.google.com/calendar/embed?src=...">
        </div>
        <button class="btn btn-secondary" onclick="loadEmbeddedCalendarFromField()">임베드로 열기</button>
      </div>
      
      <div class="subscribed-calendars-section">
        <div class="color-picker-title">구독된 캘린더</div>
        <div id="subscribedCalendarsList">
          <!-- 구독된 캘린더 표시 -->
        </div>
        <div style="margin-top:8px;">
          <button class="btn btn-secondary" onclick="loadAllSubscribedEvents()">모든 구독 새로고침</button>
          <button class="btn btn-secondary" onclick="clearAllCalendars()">모두 제거</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="overlay" id="overlay" onclick="closeSettings()"></div>
  
  <div class="calendar-container">
    <div class="calendar-content" id="calendarContent">
      <div class="setup-message">
        <div class="setup-icon">📅</div>
        <h2>자체 제작 캘린더 뷰어</h2>
        <p>Google Calendar API 또는 iCal(ICS) 구독을 사용해 여러 캘린더 일정을 한 화면에 표시합니다.</p>
        <p style="font-size: 14px; color: #666; margin-top: 16px;">
          우상단 설정 버튼을 눌러 캘린더를 연동하거나 샘플 데이터를 확인해보세요.
        </p>
      </div>
    </div>
  </div>

<script>
  // ===== 전역 상태 =====
  let currentView = 'month';
  let currentDate = new Date();
  let accentColor = '#4285f4';
  let accentHoverColor = '#3367d6';
  let calendarEvents = []; // { title, date:'YYYY-MM-DD', time:'HH:MM'|'종일', calendarId, color }
  let subscribedCalendars = []; // { id, url, name, enabled, color, lastError? }

  // ===== DOM =====
  const settingsPanel = document.getElementById("settingsPanel");
  const overlay = document.getElementById("overlay");
  const colorPicker = document.getElementById("colorPicker");
  const colorText = document.getElementById("colorText");
  const currentDateElement = document.getElementById("currentDate");
  const calendarContent = document.getElementById("calendarContent");

  // ===== 초기화 =====
  async function init() {
    loadUIState();
    loadSubscribedCalendars();
    updateCurrentDateDisplay();
    setAccentColor(accentColor);
    renderCalendar();
  }

  // ===== 설정 패널 =====
  function toggleSettings() {
    const isVisible = settingsPanel.style.display === 'block';
    if (isVisible) {
      closeSettings();
    } else {
      openSettings();
    }
  }
  function openSettings() {
    settingsPanel.style.display = 'block';
    overlay.style.display = 'block';
  }
  function closeSettings() {
    settingsPanel.style.display = 'none';
    overlay.style.display = 'none';
  }

  // ===== 뷰 전환 / 네비 =====
  function setView(viewMode) {
    currentView = viewMode;
    document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(viewMode + 'Btn').classList.add('active');
    updateCurrentDateDisplay();
    renderCalendar();
    saveUIState();
  }

  function navigateCalendar(direction) {
    if (currentView === 'month') {
      currentDate.setMonth(currentDate.getMonth() + direction);
    } else if (currentView === 'week') {
      currentDate.setDate(currentDate.getDate() + (direction * 7));
    } else if (currentView === 'day') {
      currentDate.setDate(currentDate.getDate() + direction);
    }
    updateCurrentDateDisplay();
    renderCalendar();
  }

  function goToToday() {
    currentDate = new Date();
    updateCurrentDateDisplay();
    renderCalendar();
  }

  function updateCurrentDateDisplay() {
    const options = { year: 'numeric', month: 'long' };
    if (currentView === 'day') {
      options.day = 'numeric';
      options.weekday = 'long';
    }
    currentDateElement.textContent = currentDate.toLocaleDateString('ko-KR', options);
  }

  // ===== 테마 색상 =====
  function clamp(n){ return Math.max(0, Math.min(255, n)); }
  function darkenColor(hex, percent) {
    const num = parseInt(hex.replace("#", ""), 16);
    const amt = Math.round(2.55 * percent);
    const R = clamp((num >> 16) - amt);
    const G = clamp((num >> 8 & 0x00FF) - amt);
    const B = clamp((num & 0x0000FF) - amt);
    return "#" + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
  }
  function setAccentColor(color) {
    accentColor = color;
    accentHoverColor = darkenColor(color, 15);
    document.documentElement.style.setProperty('--accent-color', color);
    document.documentElement.style.setProperty('--accent-hover-color', accentHoverColor);
    if (colorPicker) colorPicker.value = color;
    if (colorText) colorText.value = color.toUpperCase();
    saveUIState();
  }
  function setPresetColor(color) { setAccentColor(color); }
  function updateColorFromPicker() { setAccentColor(colorPicker.value); }
  function updateColorFromText() {
    let color = colorText.value.trim();
    if (!color.startsWith('#')) color = '#' + color;
    if (/^#[0-9A-F]{6}$/i.test(color)) setAccentColor(color);
  }

  // ===== 렌더링 =====
  function renderCalendar() {
    if (currentView === 'month') renderMonthView();
    else if (currentView === 'week') renderWeekView();
    else renderDayView();
  }

  function renderMonthView() {
    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());

    const grid = document.createElement('div');
    grid.className = 'calendar-grid month-view';
    
    const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
    weekdays.forEach(day => {
      const header = document.createElement('div');
      header.className = 'week-header';
      header.textContent = day;
      grid.appendChild(header);
    });

    const today = new Date();
    for (let i = 0; i < 42; i++) {
      const cellDate = new Date(startDate);
      cellDate.setDate(startDate.getDate() + i);
      const cell = document.createElement('div');
      cell.className = 'calendar-day';
      if (cellDate.getMonth() !== currentDate.getMonth()) cell.classList.add('other-month');
      if (cellDate.toDateString() === today.toDateString()) cell.classList.add('today');

      const dayNumber = document.createElement('div');
      dayNumber.className = 'day-number';
      dayNumber.textContent = cellDate.getDate();
      cell.appendChild(dayNumber);

      const dayEvents = getEventsForDate(cellDate);
      dayEvents.forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event';
        eventDiv.textContent = (event.time && event.time !== '종일') ? `[${event.time}] ${event.title}` : event.title;
        eventDiv.title = `${event.title}\n${event.time || ''}`;
        if (event.calendarId && event.color) eventDiv.style.backgroundColor = event.color;
        cell.appendChild(eventDiv);
      });

      grid.appendChild(cell);
    }

    calendarContent.innerHTML = '';
    calendarContent.appendChild(grid);
  }

  function renderWeekView() {
    const startOfWeek = new Date(currentDate);
    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
    const grid = document.createElement('div');
    grid.className = 'calendar-grid week-view';

    const timeHeader = document.createElement('div');
    timeHeader.className = 'week-header time-header';
    timeHeader.textContent = '시간';
    grid.appendChild(timeHeader);

    const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
    for (let i = 0; i < 7; i++) {
      const date = new Date(startOfWeek);
      date.setDate(startOfWeek.getDate() + i);
      const header = document.createElement('div');
      header.className = 'week-header';
      header.innerHTML = `${weekdays[i]}<br><small>${date.getDate()}</small>`;
      grid.appendChild(header);
    }

    for (let hour = 6; hour <= 23; hour++) {
      const timeSlot = document.createElement('div');
      timeSlot.className = 'time-slot';
      timeSlot.textContent = `${String(hour).padStart(2,'0')}:00`;
      grid.appendChild(timeSlot);

      for (let day = 0; day < 7; day++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + day);
        const cell = document.createElement('div');
        cell.className = 'week-day';
        const dayEvents = getEventsForDate(date).filter(event => {
          if (!event.time || event.time === '종일') return false;
          const eh = parseInt(event.time.split(':')[0], 10);
          return eh === hour;
        });
        dayEvents.forEach(event => {
          const eventDiv = document.createElement('div');
          eventDiv.className = 'event';
          eventDiv.textContent = event.title;
          eventDiv.title = `${event.title}\n${event.time}`;
          if (event.color) eventDiv.style.backgroundColor = event.color;
          cell.appendChild(eventDiv);
        });
        grid.appendChild(cell);
      }
    }

    calendarContent.innerHTML = '';
    calendarContent.appendChild(grid);
  }

  function renderDayView() {
    const grid = document.createElement('div');
    grid.className = 'calendar-grid week-view';
    grid.style.gridTemplateColumns = '60px 1fr';

    const timeHeader = document.createElement('div');
    timeHeader.className = 'week-header';
    timeHeader.textContent = '시간';
    grid.appendChild(timeHeader);

    const dayHeader = document.createElement('div');
    dayHeader.className = 'week-header';
    dayHeader.textContent = currentDate.toLocaleDateString('ko-KR', { weekday: 'long', month: 'long', day: 'numeric' });
    grid.appendChild(dayHeader);

    const eventsToday = getEventsForDate(currentDate);

    for (let hour = 6; hour <= 23; hour++) {
      const timeSlot = document.createElement('div');
      timeSlot.className = 'time-slot';
      timeSlot.textContent = `${String(hour).padStart(2,'0')}:00`;
      grid.appendChild(timeSlot);

      const cell = document.createElement('div');
      cell.className = 'week-day';
      cell.style.minHeight = '60px';
      const dayEvents = eventsToday.filter(event => {
        if (!event.time || event.time === '종일') return false;
        const eh = parseInt(event.time.split(':')[0], 10);
        return eh === hour;
      });
      dayEvents.forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event';
        eventDiv.textContent = event.title;
        eventDiv.title = `${event.title}\n${event.time}`;
        if (event.color) eventDiv.style.backgroundColor = event.color;
        cell.appendChild(eventDiv);
      });
      grid.appendChild(cell);
    }

    // 종일 이벤트 표시
    if (eventsToday.some(e => e.time === '종일')) {
      const allDayLabel = document.createElement('div');
      allDayLabel.className = 'time-slot';
      allDayLabel.textContent = '종일';
      grid.prepend(allDayLabel);
      const allDayCell = document.createElement('div');
      allDayCell.className = 'week-day';
      eventsToday.filter(e => e.time === '종일').forEach(event => {
        const div = document.createElement('div');
        div.className = 'event';
        div.textContent = event.title;
        if (event.color) div.style.backgroundColor = event.color;
        allDayCell.appendChild(div);
      });
      grid.insertBefore(allDayCell, grid.children[1]);
    }

    calendarContent.innerHTML = '';
    calendarContent.appendChild(grid);
  }

  // ===== 이벤트 헬퍼 =====
  function getEventsForDate(date) {
    return calendarEvents.filter(event => {
      const eventDate = new Date(event.date);
      return eventDate.toDateString() === date.toDateString();
    });
  }

  function showSampleData() {
    calendarEvents = generateSampleEvents();
    renderCalendar();
    closeSettings();
  }

  function generateSampleEvents() {
    const events = [];
    const today = new Date();
    const sampleTitles = [
      '회의', '프레젠테이션', '프로젝트 리뷰', '팀 미팅', '클라이언트 미팅',
      '워크숍', '교육', '점심약속', '병원', '개인 시간',
      '운동', '독서', '쇼핑', '영화', '데이트'
    ];
    for (let i = 0; i < 20; i++) {
      const eventDate = new Date(today.getFullYear(), today.getMonth(), Math.floor(Math.random() * 28) + 1);
      const hour = Math.floor(Math.random() * 10) + 9; // 9~18
      const minute = Math.random() > 0.5 ? '00' : '30';
      events.push({
        title: sampleTitles[Math.floor(Math.random() * sampleTitles.length)],
        date: eventDate.toISOString().split('T')[0],
        time: `${String(hour).padStart(2,'0')}:${minute}`
      });
    }
    return events;
  }

  // ===== Google Calendar API (선택) =====
  async function loadCalendarData() {
    const apiKey = document.getElementById('apiKey')?.value.trim();
    const calendarId = document.getElementById('calendarId')?.value.trim() || 'primary';
    if (!apiKey) {
      alert('Google Calendar API를 사용하려면 API 키가 필요합니다.\n\n샘플 데이터를 확인해보세요!');
      return;
    }
    try {
      calendarContent.innerHTML = '<div class="loading">캘린더 데이터를 불러오는 중...</div>';
      const timeMin = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString();
      const timeMax = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).toISOString();
      const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?key=${encodeURIComponent(apiKey)}&timeMin=${encodeURIComponent(timeMin)}&timeMax=${encodeURIComponent(timeMax)}&orderBy=startTime&singleEvents=true`;
      const response = await fetch(url);
      if (!response.ok) throw new Error(`API 오류: ${response.status}`);
      const data = await response.json();
      const color = getRandomColor();
      const apiEvents = data.items.map(ev => {
        const startStr = ev.start.dateTime || ev.start.date;
        const d = new Date(startStr);
        return {
          title: ev.summary || '제목 없음',
          date: d.toISOString().split('T')[0],
          time: ev.start.dateTime ? d.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) : '종일',
          calendarId: `api:${calendarId}`,
          color
        };
      });
      // 기존 API 달 이벤트 덮어쓰기 위해 해당 calendarId 이벤트 제거
      calendarEvents = calendarEvents.filter(e => e.calendarId !== `api:${calendarId}`).concat(apiEvents);
      renderCalendar();
      closeSettings();
    } catch (error) {
      console.error('캘린더 로드 오류:', error);
      calendarContent.innerHTML = `
        <div class="error-message">
          <strong>캘린더 데이터를 불러올 수 없습니다</strong><br>
          ${error.message}<br><br>
          <small>
          • API 키/Calendar ID 확인<br>
          • Google Cloud Console에서 Calendar API 사용 설정 여부 확인
          </small>
        </div>
      `;
    }
  }

  // ===== 임베드 보기 (옵션) =====
  function loadEmbeddedCalendarFromField() {
    const url = document.getElementById('embedUrl')?.value.trim();
    loadEmbeddedCalendar(url);
  }
  function loadEmbeddedCalendar(url) {
    if (!url) { alert('캘린더 임베드 URL을 입력해주세요.'); return; }
    if (!url.includes('calendar.google.com')) {
      alert('올바른 구글 캘린더 임베드 URL을 입력해주세요.');
      return;
    }
    try {
      new URL(url);
      const iframe = document.createElement('iframe');
      iframe.style.width = '100%';
      iframe.style.height = '70vh';
      iframe.style.border = 'none';
      iframe.style.borderRadius = '8px';
      iframe.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
      iframe.src = url;
      iframe.title = '구글 캘린더';
      calendarContent.innerHTML = '';
      calendarContent.appendChild(iframe);
      closeSettings();
    } catch {
      alert('올바른 URL 형식이 아닙니다.');
    }
  }

  // ===== ICS 구독 =====
  function getRandomColor() {
    const colors = ['#4285f4', '#34a853', '#ea4335', '#fbbc04', '#9c27b0', '#ff6d00', '#607d8b', '#795548', '#e91e63', '#00bcd4', '#8bc34a', '#ffc107'];
    return colors[Math.floor(Math.random() * colors.length)];
  }

  function updateSubscribedCalendarsList() {
    const container = document.getElementById('subscribedCalendarsList');
    container.innerHTML = '';
    if (subscribedCalendars.length === 0) {
      container.innerHTML = '<p style="color: #666; font-size: 12px; text-align: center;">구독된 캘린더가 없습니다.</p>';
      return;
    }
    subscribedCalendars.forEach(calendar => {
      const calendarItem = document.createElement('div');
      calendarItem.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px;';
      
      const toggle = document.createElement('input');
      toggle.type = 'checkbox';
      toggle.checked = calendar.enabled;
      toggle.onchange = () => toggleCalendar(calendar.id);
      
      const colorDot = document.createElement('div');
      colorDot.style.cssText = `width: 12px; height: 12px; border-radius: 50%; background-color: ${calendar.color};`;
      
      const name = document.createElement('span');
      name.textContent = calendar.name || calendar.url;
      name.style.cssText = 'flex: 1; font-size: 12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;';
      
      const refreshBtn = document.createElement('button');
      refreshBtn.textContent = '새로고침';
      refreshBtn.className = 'btn btn-secondary';
      refreshBtn.style.cssText = 'padding: 2px 6px; font-size: 10px;';
      refreshBtn.onclick = () => loadSubscribedCalendarEvents(calendar, { replace: true });

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = '삭제';
      deleteBtn.className = 'btn btn-secondary';
      deleteBtn.style.cssText = 'padding: 2px 6px; font-size: 10px;';
      deleteBtn.onclick = () => removeCalendar(calendar.id);

      calendarItem.appendChild(toggle);
      calendarItem.appendChild(colorDot);
      calendarItem.appendChild(name);
      calendarItem.appendChild(refreshBtn);
      calendarItem.appendChild(deleteBtn);

      // 에러 표시
      if (calendar.lastError) {
        const err = document.createElement('div');
        err.className = 'info-message';
        err.style.marginTop = '6px';
        err.innerHTML = `⚠️ ${calendar.lastError}`;
        calendarItem.appendChild(err);
      }

      container.appendChild(calendarItem);
    });
  }

  function toggleCalendar(calendarId) {
    const calendar = subscribedCalendars.find(cal => cal.id === calendarId);
    if (calendar) {
      calendar.enabled = !calendar.enabled;
      updateSubscribedCalendarsList();
      loadAllSubscribedEvents();
      saveSubscribedCalendars();
    }
  }

  function removeCalendar(calendarId) {
    if (!confirm('정말로 이 캘린더를 제거하시겠습니까?')) return;
    subscribedCalendars = subscribedCalendars.filter(cal => cal.id !== calendarId);
    updateSubscribedCalendarsList();
    loadAllSubscribedEvents();
    saveSubscribedCalendars();
  }

  function clearAllCalendars() {
    if (!confirm('모든 구독 캘린더를 제거할까요?')) return;
    subscribedCalendars = [];
    calendarEvents = calendarEvents.filter(e => !e.calendarId); // 구독 이벤트 제거
    updateSubscribedCalendarsList();
    renderCalendar();
    saveSubscribedCalendars();
  }

  function ensureHttps(url) {
    try {
      const u = new URL(url);
      if (u.protocol !== 'https:' && location.protocol === 'https:') {
        // mixed content 방지용
        u.protocol = 'https:';
        return u.toString();
      }
      return url;
    } catch { return url; }
  }

  function isGoogleEmbed(url) {
    return /calendar\.google\.com\/calendar\/embed/i.test(url);
  }

  function extractGoogleEmbedSources(embedUrl) {
    // embed URL에서 src 매개변수 여러 개를 모두 뽑아 ICS로 변환
    try {
      const u = new URL(embedUrl);
      const srcs = u.searchParams.getAll('src');
      return srcs.map(s => ({
        src: s,
        ics: `https://calendar.google.com/calendar/ical/${encodeURIComponent(s)}/public/basic.ics`,
        name: decodeURIComponent(s)
      }));
    } catch { return []; }
  }

  async function addSubscribedCalendar() {
    let url = document.getElementById('calendarUrl').value.trim();
    const proxy = document.getElementById('proxyUrl')?.value.trim();
    if (!url) return alert('iCal(ICS) 링크 또는 embed 링크를 입력해주세요.');
    url = ensureHttps(url);

    // embed URL이면 src들 뽑아서 여러 캘린더 추가
    if (isGoogleEmbed(url)) {
      const entries = extractGoogleEmbedSources(url);
      if (entries.length === 0) {
        alert('embed URL에서 src를 찾지 못했습니다.');
        return;
      }
      for (const entry of entries) {
        await addOneCalendar(entry.ics, entry.name, proxy);
      }
    } else {
      // 일반 ICS로 처리 (또는 사용자가 이메일/ID만 넣었다면 google ICS로 시도)
      if (!/\.ics(\?|$)/i.test(url)) {
        // 이메일처럼 보이면 ICS로 변환 시도
        if (/@/.test(url) || /^[a-z0-9._%-]+@[a-z0-9.-]+$/i.test(url)) {
          url = `https://calendar.google.com/calendar/ical/${encodeURIComponent(url)}/public/basic.ics`;
        } else if (/calendar\.google\.com\/calendar\/ical\//i.test(url)) {
          // 이미 ICS base면 OK
        } else {
          return alert('올바른 iCal(ICS) 링크가 아닙니다. (.ics) 또는 embed URL을 사용하세요.');
        }
      }
      await addOneCalendar(url, undefined, proxy);
    }

    document.getElementById('calendarUrl').value = '';
    updateSubscribedCalendarsList();
    closeSettings();
  }

  async function addOneCalendar(url, name, proxy) {
    try {
      // 중복 체크
      if (subscribedCalendars.some(cal => cal.url === url)) {
        alert(`이미 구독된 캘린더입니다:\n${url}`);
        return;
      }
      const newCalendar = {
        id: Date.now() + Math.random(),
        url,
        name: name || deriveCalendarNameFromUrl(url),
        enabled: true,
        color: getRandomColor()
      };
      subscribedCalendars.push(newCalendar);
      saveSubscribedCalendars();
      updateSubscribedCalendarsList();
      await loadSubscribedCalendarEvents(newCalendar, { replace: false, proxy });
    } catch (e) {
      console.error(e);
      alert('캘린더 추가 중 오류가 발생했습니다.');
    }
  }

  function deriveCalendarNameFromUrl(url) {
    try {
      const u = new URL(url);
      const path = u.pathname.split('/').filter(Boolean);
      const last = path[path.length - 1] || '';
      return decodeURIComponent(last.replace(/\.ics$/i, '')) || u.hostname;
    } catch {
      return url;
    }
  }

  async function loadAllSubscribedEvents() {
    // 기존 구독 이벤트 제거 (다시 로드)
    calendarEvents = calendarEvents.filter(e => !e.calendarId || String(e.calendarId).startsWith('api:'));
    for (const calendar of subscribedCalendars.filter(cal => cal.enabled)) {
      await loadSubscribedCalendarEvents(calendar, { replace: false });
    }
    renderCalendar();
  }

  async function loadSubscribedCalendarEvents(calendar, { replace = false, proxy } = {}) {
    const finalProxy = proxy ?? document.getElementById('proxyUrl')?.value.trim();
    const fetchUrl = finalProxy ? `${finalProxy}${encodeURIComponent(calendar.url)}` : calendar.url;

    try {
      const res = await fetch(fetchUrl, { mode: finalProxy ? 'cors' : 'cors' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const icsDataRaw = await res.text();
      const events = parseICalData(icsDataRaw, calendar);

      if (replace) {
        calendarEvents = calendarEvents.filter(e => e.calendarId !== calendar.id);
      }
      calendarEvents = calendarEvents.concat(events);
      delete calendar.lastError;
      renderCalendar();
    } catch (error) {
      console.error('구독 캘린더 이벤트 로드 오류:', error);
      calendar.lastError = '불러오기 실패 (공개 여부/CORS 확인 필요). 프록시 URL을 설정해 보세요.';
      updateSubscribedCalendarsList();
    }
  }

  // ===== iCal 파서 =====
  function unfoldICSLines(raw) {
    // RFC5545: 다음 줄이 공백/탭으로 시작하면 이전 줄의 연속
    const rawLines = raw.split(/\r?\n/);
    const lines = [];
    for (let i = 0; i < rawLines.length; i++) {
      let line = rawLines[i];
      while (i + 1 < rawLines.length && (rawLines[i + 1].startsWith(' ') || rawLines[i + 1].startsWith('\t'))) {
        line += rawLines[++i].slice(1);
      }
      lines.push(line);
    }
    return lines;
  }

  function parseICalData(icsData, calendar) {
    const lines = unfoldICSLines(icsData);
    const events = [];
    let currentEvent = null;

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();

      if (line === 'BEGIN:VEVENT') {
        currentEvent = { calendarId: calendar.id, color: calendar.color };
      } else if (line === 'END:VEVENT') {
        if (currentEvent && currentEvent.title && currentEvent.date) events.push(currentEvent);
        currentEvent = null;
      } else if (currentEvent) {
        if (line.startsWith('SUMMARY')) {
          currentEvent.title = valueAfterColon(line);
        } else if (line.startsWith('DTSTART')) {
          const { date, timeLabel } = parseICalDateLine(line);
          currentEvent.date = date;
          currentEvent.time = timeLabel;
        } else if (line.startsWith('DTEND')) {
          // 필요 시 종료시간 활용 가능
        } else if (line.startsWith('DESCRIPTION')) {
          currentEvent.description = valueAfterColon(line);
        } else if (line.startsWith('LOCATION')) {
          currentEvent.location = valueAfterColon(line);
        }
      }
    }
    return events;
  }

  function valueAfterColon(line) {
    const idx = line.indexOf(':');
    return idx >= 0 ? line.slice(idx + 1).trim() : '';
  }

  function parseICalDateLine(line) {
    // 예: DTSTART:20250816, DTSTART:20250816T090000Z, DTSTART;TZID=Asia/Seoul:20250816T090000
    const val = valueAfterColon(line);
    const tzMatch = line.match(/TZID=([^:;]+)/i);
    const tzid = tzMatch ? tzMatch[1] : undefined;

    if (/^\d{8}$/.test(val)) {
      const y = parseInt(val.slice(0,4),10);
      const m = parseInt(val.slice(4,6),10)-1;
      const d = parseInt(val.slice(6,8),10);
      const date = new Date(y, m, d);
      return { date: date.toISOString().split('T')[0], timeLabel: '종일' };
    }

    const dt = val.replace('Z',''); // UTC 표기는 간단화
    const y = parseInt(dt.slice(0,4),10);
    const m = parseInt(dt.slice(4,6),10)-1;
    const d = parseInt(dt.slice(6,8),10);
    const hh = parseInt(dt.slice(9,11) || '0',10);
    const mm = parseInt(dt.slice(11,13) || '0',10);
    const ss = parseInt(dt.slice(13,15) || '0',10);

    // Z가 있었으면 UTC로 간주
    const isUTC = /Z$/.test(val);
    const dateObj = isUTC ? new Date(Date.UTC(y,m,d,hh,mm,ss)) : new Date(y,m,d,hh,mm,ss);

    return {
      date: dateObj.toISOString().split('T')[0],
      timeLabel: dateObj.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false })
    };
  }

  // ===== 저장/불러오기 =====
  function saveSubscribedCalendars() {
    localStorage.setItem('subscribedCalendars', JSON.stringify(subscribedCalendars));
  }

  function loadSubscribedCalendars() {
    const saved = localStorage.getItem('subscribedCalendars');
    if (saved) {
      try {
        subscribedCalendars = JSON.parse(saved);
      } catch { subscribedCalendars = []; }
    }
    updateSubscribedCalendarsList();
    // 초기 로드
    loadAllSubscribedEvents();
  }

  function saveUIState() {
    const payload = {
      view: currentView,
      accentColor,
      accentHoverColor,
      proxyUrl: document.getElementById('proxyUrl')?.value || ''
    };
    localStorage.setItem('calendarUIState', JSON.stringify(payload));
  }

  function loadUIState() {
    const raw = localStorage.getItem('calendarUIState');
    if (!raw) return;
    try {
      const data = JSON.parse(raw);
      currentView = data.view || 'month';
      accentColor = data.accentColor || '#4285f4';
      accentHoverColor = data.accentHoverColor || darkenColor(accentColor, 15);
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      const activeBtn = document.getElementById(currentView + 'Btn');
      if (activeBtn) activeBtn.classList.add('active');
      if (document.getElementById('proxyUrl')) document.getElementById('proxyUrl').value = data.proxyUrl || '';
    } catch {}
  }

  // ===== 키보드 단축키 =====
  document.addEventListener('keydown', function(e) {
    if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
    switch(e.key) {
      case 'ArrowLeft': navigateCalendar(-1); break;
      case 'ArrowRight': navigateCalendar(1); break;
      case 't': case 'T': goToToday(); break;
      case 'm': case 'M': setView('month'); break;
      case 'w': case 'W': setView('week'); break;
      case 'd': case 'D': setView('day'); break;
    }
  });

  // ===== Enter 핸들러 =====
  ['calendarUrl','apiKey','calendarId','embedUrl','proxyUrl'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        if (id === 'calendarUrl') addSubscribedCalendar();
        else if (id === 'embedUrl') loadEmbeddedCalendarFromField();
        else if (id === 'apiKey' || id === 'calendarId') loadCalendarData();
        else if (id === 'proxyUrl') saveUIState();
      }
    });
  });

  // ===== 시작! =====
  init();
</script>
</body>
</html>
